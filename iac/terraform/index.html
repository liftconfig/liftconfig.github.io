
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Tim Howlinson">
      
      
        <link rel="canonical" href="https://liftconfig.github.io/iac/terraform/">
      
      
        <link rel="prev" href="../../networking/nsxt/">
      
      
        <link rel="next" href="../../about/about-me/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.14">
    
    
      
        <title>Terraform - liftConfig</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.10ba22f1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-C3VKY555NW"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-C3VKY555NW",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-C3VKY555NW",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#more-than-certified-in-terraform-derek-morgan" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="liftConfig" class="md-header__button md-logo" aria-label="liftConfig" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 21.6a9.6 9.6 0 0 1-5.016-1.416L11.28 17.7v-5.4L6.612 9.6v5.424l3.3 1.908-4.152 2.4A9.6 9.6 0 0 1 7.296 3.6v4.8L12 11.136 16.68 8.4 12 5.724 8.688 7.632V2.964a9.6 9.6 0 0 1 12.372 5.64A9.72 9.72 0 0 1 21.672 12v.084L17.352 9.6l-4.68 2.712v5.412l4.68-2.7v-3.816l4.14 2.4A9.6 9.6 0 0 1 12 21.6z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            liftConfig
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Terraform
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="blue"  aria-label="Switch to Light Mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to Light Mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to Dark Mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to Dark Mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../blog/" class="md-tabs__link">
          
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../networking/iosxr/" class="md-tabs__link">
          
  
  Reference

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../about/about-me/" class="md-tabs__link">
          
  
  About

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  Tags

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="liftConfig" class="md-nav__button md-logo" aria-label="liftConfig" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 21.6a9.6 9.6 0 0 1-5.016-1.416L11.28 17.7v-5.4L6.612 9.6v5.424l3.3 1.908-4.152 2.4A9.6 9.6 0 0 1 7.296 3.6v4.8L12 11.136 16.68 8.4 12 5.724 8.688 7.632V2.964a9.6 9.6 0 0 1 12.372 5.64A9.72 9.72 0 0 1 21.672 12v.084L17.352 9.6l-4.68 2.712v5.412l4.68-2.7v-3.816l4.14 2.4A9.6 9.6 0 0 1 12 21.6z"/></svg>

    </a>
    liftConfig
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Networking
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Networking
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/iosxr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cisco IOS-XR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/fortinet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FortiOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../networking/nsxt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VMware NSX-T
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    IaC
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            IaC
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Terraform
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Terraform
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#section-1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Section 1: Introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 1: Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#12-terraform-terminology" class="md-nav__link">
    <span class="md-ellipsis">
      12. Terraform Terminology
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-2-terraform-basics-and-docker" class="md-nav__link">
    <span class="md-ellipsis">
      Section 2: Terraform Basics and Docker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 2: Terraform Basics and Docker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#15-init-deep-dive" class="md-nav__link">
    <span class="md-ellipsis">
      15. Init Deep Dive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16-terraform-dependency-lock" class="md-nav__link">
    <span class="md-ellipsis">
      16. Terraform Dependency Lock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#17-your-first-terraform-apply" class="md-nav__link">
    <span class="md-ellipsis">
      17. Your first terraform apply
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#18-terraform-plan-apply-deeper-dive" class="md-nav__link">
    <span class="md-ellipsis">
      18. Terraform plan &amp; apply deeper dive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#19-referencing-other-resources" class="md-nav__link">
    <span class="md-ellipsis">
      19. Referencing other resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#20-view-docker-image-in-browser" class="md-nav__link">
    <span class="md-ellipsis">
      20. View docker image in browser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#21-terraform-state-deeper-dive" class="md-nav__link">
    <span class="md-ellipsis">
      21. Terraform State Deeper Dive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-terraform-console-outputs" class="md-nav__link">
    <span class="md-ellipsis">
      22. Terraform Console &amp; Outputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-terraform-functions" class="md-nav__link">
    <span class="md-ellipsis">
      23. Terraform Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-the-random-resource" class="md-nav__link">
    <span class="md-ellipsis">
      24. The Random Resource
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-multiple-resources-and-count" class="md-nav__link">
    <span class="md-ellipsis">
      25. Multiple Resources and Count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-the-splat-expression" class="md-nav__link">
    <span class="md-ellipsis">
      26. The splat expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-for-expression" class="md-nav__link">
    <span class="md-ellipsis">
      27. For Expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#28-tainting-resources" class="md-nav__link">
    <span class="md-ellipsis">
      28. Tainting Resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#29-state-locking-breaking-state" class="md-nav__link">
    <span class="md-ellipsis">
      29. State locking &amp; breaking state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#30-terraform-import" class="md-nav__link">
    <span class="md-ellipsis">
      30. Terraform import
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#31-terraform-refresh-and-state-rm" class="md-nav__link">
    <span class="md-ellipsis">
      31. Terraform Refresh and State rm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-adding-variables" class="md-nav__link">
    <span class="md-ellipsis">
      32. Adding Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-variable-validation" class="md-nav__link">
    <span class="md-ellipsis">
      33. Variable Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-sensitive-variables" class="md-nav__link">
    <span class="md-ellipsis">
      35. Sensitive Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36-variable-definition-procedure" class="md-nav__link">
    <span class="md-ellipsis">
      36. Variable Definition Procedure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37-hiding-sensitive-values-from-cli" class="md-nav__link">
    <span class="md-ellipsis">
      37. Hiding sensitive values from CLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#38-the-bind-mount-and-local-exec" class="md-nav__link">
    <span class="md-ellipsis">
      38. The bind mount and local-exec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#39-utilising-local-values" class="md-nav__link">
    <span class="md-ellipsis">
      39. Utilising Local Values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#40-min-max-functions-the-expand-expression" class="md-nav__link">
    <span class="md-ellipsis">
      40. Min &amp; Max functions. The expand expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-path-references-and-string-interpolation" class="md-nav__link">
    <span class="md-ellipsis">
      41. Path references and string interpolation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-maps-and-lookups-the-image-variable" class="md-nav__link">
    <span class="md-ellipsis">
      42. Maps and Lookups: the Image Variable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-terraform-workspaces" class="md-nav__link">
    <span class="md-ellipsis">
      44. Terraform Workspaces
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-referencing-your-workspaces" class="md-nav__link">
    <span class="md-ellipsis">
      45. Referencing your Workspaces
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-using-map-keys-instead-of-lookups" class="md-nav__link">
    <span class="md-ellipsis">
      46. Using Map Keys instead of Lookups
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-3-modular-deployments" class="md-nav__link">
    <span class="md-ellipsis">
      Section 3: Modular Deployments
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 3: Modular Deployments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#47-modules-intro" class="md-nav__link">
    <span class="md-ellipsis">
      47. Modules Intro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#48-first-module" class="md-nav__link">
    <span class="md-ellipsis">
      48. First Module!
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#49-module-variables" class="md-nav__link">
    <span class="md-ellipsis">
      49. Module Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#50-terraform-graph" class="md-nav__link">
    <span class="md-ellipsis">
      50. Terraform Graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#51-troubleshooting-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      51. Troubleshooting Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-the-container-module-module-outputs" class="md-nav__link">
    <span class="md-ellipsis">
      52. The Container Module + module outputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54-module-information-flow" class="md-nav__link">
    <span class="md-ellipsis">
      54. Module information flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55-docker-volume" class="md-nav__link">
    <span class="md-ellipsis">
      55. Docker Volume
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#56-lifecycle-customisation-and-targeting" class="md-nav__link">
    <span class="md-ellipsis">
      56. Lifecycle Customisation and Targeting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#58-using-for_each" class="md-nav__link">
    <span class="md-ellipsis">
      58. Using for_each
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#61-new-outputs-and-map-transformations" class="md-nav__link">
    <span class="md-ellipsis">
      61. New Outputs and Map Transformations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-grafana-apply-yourself" class="md-nav__link">
    <span class="md-ellipsis">
      62. Grafana apply yourself
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-self-referencing-and-provisioner-failure-modes" class="md-nav__link">
    <span class="md-ellipsis">
      64. Self Referencing and Provisioner Failure Modes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65-terraform-apply-yourself-self-referencing" class="md-nav__link">
    <span class="md-ellipsis">
      65. Terraform apply yourself - self referencing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#66-dynamic-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      66. Dynamic Blocks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#67-nesting-the-volume-module" class="md-nav__link">
    <span class="md-ellipsis">
      67. Nesting the Volume module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#68-weatherboard-dashboard-project" class="md-nav__link">
    <span class="md-ellipsis">
      68. Weatherboard Dashboard Project
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-4-deploy-aws-resources-with-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Section 4: Deploy AWS Resources with Terraform
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 4: Deploy AWS Resources with Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#69-what-were-going-to-build" class="md-nav__link">
    <span class="md-ellipsis">
      69. What we're going to build
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#70a-configuring-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      70a. Configuring Terraform Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#70b-using-dev-container-ubuntu-to-deploy-to-aws-with-tfc-backend" class="md-nav__link">
    <span class="md-ellipsis">
      70b. Using Dev Container (Ubuntu) to deploy to AWS with TFC backend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#71-the-aws-provider" class="md-nav__link">
    <span class="md-ellipsis">
      71. The AWS Provider
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-deploy-a-vpc" class="md-nav__link">
    <span class="md-ellipsis">
      72. Deploy a VPC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-remote-state-in-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      73. Remote State in Terraform Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#76-the-cidrsubnet-function" class="md-nav__link">
    <span class="md-ellipsis">
      76. The cidrsubnet() Function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#77-the-aws_availability_zones-data-source-78-the-random_shuffle-resource" class="md-nav__link">
    <span class="md-ellipsis">
      77. The aws_availability_zones Data Source + 78. The random_shuffle Resource
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#80-route-tables-internet-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      80. Route tables &amp; Internet Gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#81-the-create_before_destroy-lifecycle-meta-argument" class="md-nav__link">
    <span class="md-ellipsis">
      81. The create_before_destroy Lifecycle Meta Argument
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-security-groups" class="md-nav__link">
    <span class="md-ellipsis">
      82. Security Groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85-vpc-rds-subnet-group-and-conditionals" class="md-nav__link">
    <span class="md-ellipsis">
      85. VPC RDS Subnet Group and Conditionals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#86-basic-rds-setup" class="md-nav__link">
    <span class="md-ellipsis">
      86. Basic RDS Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#89-the-terraform-providers-schema-command" class="md-nav__link">
    <span class="md-ellipsis">
      89. The terraform providers schema command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#90-alb-setup" class="md-nav__link">
    <span class="md-ellipsis">
      90. ALB setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-alb-target-group-and-the-uuid-and-substr-functions" class="md-nav__link">
    <span class="md-ellipsis">
      92. ALB Target Group and the UUID and substr functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-alb-listener" class="md-nav__link">
    <span class="md-ellipsis">
      93. ALB listener
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94-alb-lifecycle-policies-ignore_changes-and-create_before_destroy" class="md-nav__link">
    <span class="md-ellipsis">
      94. ALB lifecycle Policies: ignore_changes and create_before_destroy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#96-the-aws_ami-datasource" class="md-nav__link">
    <span class="md-ellipsis">
      96. The aws_ami datasource
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#97-ec2-instances" class="md-nav__link">
    <span class="md-ellipsis">
      97. EC2 instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#98-ssh-key-for-instance" class="md-nav__link">
    <span class="md-ellipsis">
      98. SSH Key for Instance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#100-controlling-random_id-changes-with-keepers" class="md-nav__link">
    <span class="md-ellipsis">
      100. Controlling random_id Changes with Keepers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-ec2-user-data-and-template-files" class="md-nav__link">
    <span class="md-ellipsis">
      102. EC2 User Data and Template Files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#104-deploying-nginx-on-kubernetes-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      104. Deploying NGINX on Kubernetes Cluster!
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#105-add-k3-instances-to-alb-target-group" class="md-nav__link">
    <span class="md-ellipsis">
      105. Add K3 Instances to ALB target group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#106-adding-outputs-for-our-resources" class="md-nav__link">
    <span class="md-ellipsis">
      106. Adding Outputs for our Resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#107-sensitive-outputs-and-how-to-access-them" class="md-nav__link">
    <span class="md-ellipsis">
      107. Sensitive Outputs and how to access them
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#109-utilising-the-remote-and-local-exec-provisioner-to-scp-the-kubeconfig-file" class="md-nav__link">
    <span class="md-ellipsis">
      109. Utilising the remote and local-exec provisioner to SCP the Kubeconfig file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-deploying-k8s-resources-from-our-cloud9-instance" class="md-nav__link">
    <span class="md-ellipsis">
      112. Deploying K8s Resources from our Cloud9 Instance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-5-deploying-kubernetes-resources-with-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Section 5: Deploying Kubernetes Resources with Terraform
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 5: Deploying Kubernetes Resources with Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#113-configuring-k8s-provider" class="md-nav__link">
    <span class="md-ellipsis">
      113. Configuring K8s provider
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#114-our-first-k8s-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      114. Our First K8s Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#116-terraform-apply-yourself-3-k8s-deployments-using-for_each" class="md-nav__link">
    <span class="md-ellipsis">
      116. Terraform Apply Yourself - 3 k8s deployments using for_each
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#117-terraform_remote_state-datasource-and-the-split-function" class="md-nav__link">
    <span class="md-ellipsis">
      117. Terraform_remote_state datasource and the split Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-6-continuous-deployment-using-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Section 6: Continuous Deployment using Terraform Cloud
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 6: Continuous Deployment using Terraform Cloud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#118-what-were-going-to-build" class="md-nav__link">
    <span class="md-ellipsis">
      118. What We're Going to Build
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#120-setting-up-github" class="md-nav__link">
    <span class="md-ellipsis">
      120. Setting up GitHub
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#121-configuring-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      121. Configuring Terraform Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-our-first-cloud-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      122. Our First Cloud Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-tfc-repo-based-modules" class="md-nav__link">
    <span class="md-ellipsis">
      123. TFC Repo-based modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124-utilising-the-configuration-designer-to-create-a-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      124. Utilising the Configuration Designer to Create a Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#125-settings-up-providers-for-our-new-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      125. Settings up Providers for our New Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#127-configuring-our-github-resources-in-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      127. Configuring our GitHub Resources in Terraform
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#128-configuring-our-terraform-cloud-resources-in-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      128. Configuring our Terraform Cloud Resources in Terraform
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#130-pushing-and-pulling-remote-state" class="md-nav__link">
    <span class="md-ellipsis">
      130. Pushing and pulling remote state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#131-updating-our-deployment-modules-and-destroying-it" class="md-nav__link">
    <span class="md-ellipsis">
      131. Updating our Deployment Modules and Destroying it
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cleaning-up" class="md-nav__link">
    <span class="md-ellipsis">
      Cleaning up
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-to-complete-course" class="md-nav__link">
    <span class="md-ellipsis">
      Time to complete course
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    About
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            About
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/about-me/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About Me
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/office-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Office Setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/gym-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gym Setup
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#section-1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Section 1: Introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 1: Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#12-terraform-terminology" class="md-nav__link">
    <span class="md-ellipsis">
      12. Terraform Terminology
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-2-terraform-basics-and-docker" class="md-nav__link">
    <span class="md-ellipsis">
      Section 2: Terraform Basics and Docker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 2: Terraform Basics and Docker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#15-init-deep-dive" class="md-nav__link">
    <span class="md-ellipsis">
      15. Init Deep Dive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16-terraform-dependency-lock" class="md-nav__link">
    <span class="md-ellipsis">
      16. Terraform Dependency Lock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#17-your-first-terraform-apply" class="md-nav__link">
    <span class="md-ellipsis">
      17. Your first terraform apply
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#18-terraform-plan-apply-deeper-dive" class="md-nav__link">
    <span class="md-ellipsis">
      18. Terraform plan &amp; apply deeper dive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#19-referencing-other-resources" class="md-nav__link">
    <span class="md-ellipsis">
      19. Referencing other resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#20-view-docker-image-in-browser" class="md-nav__link">
    <span class="md-ellipsis">
      20. View docker image in browser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#21-terraform-state-deeper-dive" class="md-nav__link">
    <span class="md-ellipsis">
      21. Terraform State Deeper Dive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-terraform-console-outputs" class="md-nav__link">
    <span class="md-ellipsis">
      22. Terraform Console &amp; Outputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-terraform-functions" class="md-nav__link">
    <span class="md-ellipsis">
      23. Terraform Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-the-random-resource" class="md-nav__link">
    <span class="md-ellipsis">
      24. The Random Resource
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-multiple-resources-and-count" class="md-nav__link">
    <span class="md-ellipsis">
      25. Multiple Resources and Count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-the-splat-expression" class="md-nav__link">
    <span class="md-ellipsis">
      26. The splat expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-for-expression" class="md-nav__link">
    <span class="md-ellipsis">
      27. For Expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#28-tainting-resources" class="md-nav__link">
    <span class="md-ellipsis">
      28. Tainting Resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#29-state-locking-breaking-state" class="md-nav__link">
    <span class="md-ellipsis">
      29. State locking &amp; breaking state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#30-terraform-import" class="md-nav__link">
    <span class="md-ellipsis">
      30. Terraform import
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#31-terraform-refresh-and-state-rm" class="md-nav__link">
    <span class="md-ellipsis">
      31. Terraform Refresh and State rm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-adding-variables" class="md-nav__link">
    <span class="md-ellipsis">
      32. Adding Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-variable-validation" class="md-nav__link">
    <span class="md-ellipsis">
      33. Variable Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-sensitive-variables" class="md-nav__link">
    <span class="md-ellipsis">
      35. Sensitive Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36-variable-definition-procedure" class="md-nav__link">
    <span class="md-ellipsis">
      36. Variable Definition Procedure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37-hiding-sensitive-values-from-cli" class="md-nav__link">
    <span class="md-ellipsis">
      37. Hiding sensitive values from CLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#38-the-bind-mount-and-local-exec" class="md-nav__link">
    <span class="md-ellipsis">
      38. The bind mount and local-exec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#39-utilising-local-values" class="md-nav__link">
    <span class="md-ellipsis">
      39. Utilising Local Values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#40-min-max-functions-the-expand-expression" class="md-nav__link">
    <span class="md-ellipsis">
      40. Min &amp; Max functions. The expand expression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-path-references-and-string-interpolation" class="md-nav__link">
    <span class="md-ellipsis">
      41. Path references and string interpolation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-maps-and-lookups-the-image-variable" class="md-nav__link">
    <span class="md-ellipsis">
      42. Maps and Lookups: the Image Variable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-terraform-workspaces" class="md-nav__link">
    <span class="md-ellipsis">
      44. Terraform Workspaces
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-referencing-your-workspaces" class="md-nav__link">
    <span class="md-ellipsis">
      45. Referencing your Workspaces
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-using-map-keys-instead-of-lookups" class="md-nav__link">
    <span class="md-ellipsis">
      46. Using Map Keys instead of Lookups
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-3-modular-deployments" class="md-nav__link">
    <span class="md-ellipsis">
      Section 3: Modular Deployments
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 3: Modular Deployments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#47-modules-intro" class="md-nav__link">
    <span class="md-ellipsis">
      47. Modules Intro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#48-first-module" class="md-nav__link">
    <span class="md-ellipsis">
      48. First Module!
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#49-module-variables" class="md-nav__link">
    <span class="md-ellipsis">
      49. Module Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#50-terraform-graph" class="md-nav__link">
    <span class="md-ellipsis">
      50. Terraform Graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#51-troubleshooting-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      51. Troubleshooting Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-the-container-module-module-outputs" class="md-nav__link">
    <span class="md-ellipsis">
      52. The Container Module + module outputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54-module-information-flow" class="md-nav__link">
    <span class="md-ellipsis">
      54. Module information flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55-docker-volume" class="md-nav__link">
    <span class="md-ellipsis">
      55. Docker Volume
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#56-lifecycle-customisation-and-targeting" class="md-nav__link">
    <span class="md-ellipsis">
      56. Lifecycle Customisation and Targeting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#58-using-for_each" class="md-nav__link">
    <span class="md-ellipsis">
      58. Using for_each
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#61-new-outputs-and-map-transformations" class="md-nav__link">
    <span class="md-ellipsis">
      61. New Outputs and Map Transformations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-grafana-apply-yourself" class="md-nav__link">
    <span class="md-ellipsis">
      62. Grafana apply yourself
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-self-referencing-and-provisioner-failure-modes" class="md-nav__link">
    <span class="md-ellipsis">
      64. Self Referencing and Provisioner Failure Modes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65-terraform-apply-yourself-self-referencing" class="md-nav__link">
    <span class="md-ellipsis">
      65. Terraform apply yourself - self referencing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#66-dynamic-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      66. Dynamic Blocks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#67-nesting-the-volume-module" class="md-nav__link">
    <span class="md-ellipsis">
      67. Nesting the Volume module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#68-weatherboard-dashboard-project" class="md-nav__link">
    <span class="md-ellipsis">
      68. Weatherboard Dashboard Project
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-4-deploy-aws-resources-with-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Section 4: Deploy AWS Resources with Terraform
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 4: Deploy AWS Resources with Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#69-what-were-going-to-build" class="md-nav__link">
    <span class="md-ellipsis">
      69. What we're going to build
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#70a-configuring-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      70a. Configuring Terraform Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#70b-using-dev-container-ubuntu-to-deploy-to-aws-with-tfc-backend" class="md-nav__link">
    <span class="md-ellipsis">
      70b. Using Dev Container (Ubuntu) to deploy to AWS with TFC backend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#71-the-aws-provider" class="md-nav__link">
    <span class="md-ellipsis">
      71. The AWS Provider
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-deploy-a-vpc" class="md-nav__link">
    <span class="md-ellipsis">
      72. Deploy a VPC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-remote-state-in-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      73. Remote State in Terraform Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#76-the-cidrsubnet-function" class="md-nav__link">
    <span class="md-ellipsis">
      76. The cidrsubnet() Function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#77-the-aws_availability_zones-data-source-78-the-random_shuffle-resource" class="md-nav__link">
    <span class="md-ellipsis">
      77. The aws_availability_zones Data Source + 78. The random_shuffle Resource
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#80-route-tables-internet-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      80. Route tables &amp; Internet Gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#81-the-create_before_destroy-lifecycle-meta-argument" class="md-nav__link">
    <span class="md-ellipsis">
      81. The create_before_destroy Lifecycle Meta Argument
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-security-groups" class="md-nav__link">
    <span class="md-ellipsis">
      82. Security Groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85-vpc-rds-subnet-group-and-conditionals" class="md-nav__link">
    <span class="md-ellipsis">
      85. VPC RDS Subnet Group and Conditionals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#86-basic-rds-setup" class="md-nav__link">
    <span class="md-ellipsis">
      86. Basic RDS Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#89-the-terraform-providers-schema-command" class="md-nav__link">
    <span class="md-ellipsis">
      89. The terraform providers schema command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#90-alb-setup" class="md-nav__link">
    <span class="md-ellipsis">
      90. ALB setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-alb-target-group-and-the-uuid-and-substr-functions" class="md-nav__link">
    <span class="md-ellipsis">
      92. ALB Target Group and the UUID and substr functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-alb-listener" class="md-nav__link">
    <span class="md-ellipsis">
      93. ALB listener
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94-alb-lifecycle-policies-ignore_changes-and-create_before_destroy" class="md-nav__link">
    <span class="md-ellipsis">
      94. ALB lifecycle Policies: ignore_changes and create_before_destroy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#96-the-aws_ami-datasource" class="md-nav__link">
    <span class="md-ellipsis">
      96. The aws_ami datasource
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#97-ec2-instances" class="md-nav__link">
    <span class="md-ellipsis">
      97. EC2 instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#98-ssh-key-for-instance" class="md-nav__link">
    <span class="md-ellipsis">
      98. SSH Key for Instance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#100-controlling-random_id-changes-with-keepers" class="md-nav__link">
    <span class="md-ellipsis">
      100. Controlling random_id Changes with Keepers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-ec2-user-data-and-template-files" class="md-nav__link">
    <span class="md-ellipsis">
      102. EC2 User Data and Template Files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#104-deploying-nginx-on-kubernetes-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      104. Deploying NGINX on Kubernetes Cluster!
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#105-add-k3-instances-to-alb-target-group" class="md-nav__link">
    <span class="md-ellipsis">
      105. Add K3 Instances to ALB target group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#106-adding-outputs-for-our-resources" class="md-nav__link">
    <span class="md-ellipsis">
      106. Adding Outputs for our Resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#107-sensitive-outputs-and-how-to-access-them" class="md-nav__link">
    <span class="md-ellipsis">
      107. Sensitive Outputs and how to access them
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#109-utilising-the-remote-and-local-exec-provisioner-to-scp-the-kubeconfig-file" class="md-nav__link">
    <span class="md-ellipsis">
      109. Utilising the remote and local-exec provisioner to SCP the Kubeconfig file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-deploying-k8s-resources-from-our-cloud9-instance" class="md-nav__link">
    <span class="md-ellipsis">
      112. Deploying K8s Resources from our Cloud9 Instance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-5-deploying-kubernetes-resources-with-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Section 5: Deploying Kubernetes Resources with Terraform
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 5: Deploying Kubernetes Resources with Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#113-configuring-k8s-provider" class="md-nav__link">
    <span class="md-ellipsis">
      113. Configuring K8s provider
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#114-our-first-k8s-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      114. Our First K8s Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#116-terraform-apply-yourself-3-k8s-deployments-using-for_each" class="md-nav__link">
    <span class="md-ellipsis">
      116. Terraform Apply Yourself - 3 k8s deployments using for_each
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#117-terraform_remote_state-datasource-and-the-split-function" class="md-nav__link">
    <span class="md-ellipsis">
      117. Terraform_remote_state datasource and the split Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-6-continuous-deployment-using-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Section 6: Continuous Deployment using Terraform Cloud
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Section 6: Continuous Deployment using Terraform Cloud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#118-what-were-going-to-build" class="md-nav__link">
    <span class="md-ellipsis">
      118. What We're Going to Build
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#120-setting-up-github" class="md-nav__link">
    <span class="md-ellipsis">
      120. Setting up GitHub
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#121-configuring-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      121. Configuring Terraform Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-our-first-cloud-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      122. Our First Cloud Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-tfc-repo-based-modules" class="md-nav__link">
    <span class="md-ellipsis">
      123. TFC Repo-based modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124-utilising-the-configuration-designer-to-create-a-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      124. Utilising the Configuration Designer to Create a Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#125-settings-up-providers-for-our-new-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      125. Settings up Providers for our New Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#127-configuring-our-github-resources-in-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      127. Configuring our GitHub Resources in Terraform
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#128-configuring-our-terraform-cloud-resources-in-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      128. Configuring our Terraform Cloud Resources in Terraform
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#130-pushing-and-pulling-remote-state" class="md-nav__link">
    <span class="md-ellipsis">
      130. Pushing and pulling remote state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#131-updating-our-deployment-modules-and-destroying-it" class="md-nav__link">
    <span class="md-ellipsis">
      131. Updating our Deployment Modules and Destroying it
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cleaning-up" class="md-nav__link">
    <span class="md-ellipsis">
      Cleaning up
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-to-complete-course" class="md-nav__link">
    <span class="md-ellipsis">
      Time to complete course
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  
<nav class="md-tags" >
  
    
    
    
      <a href="../../tags/#iac" class="md-tag">IaC</a>
    
  
    
    
    
      <a href="../../tags/#terraform" class="md-tag">Terraform</a>
    
  
</nav>



<h1 id="more-than-certified-in-terraform-derek-morgan">More than Certified in Terraform - Derek Morgan<a class="headerlink" href="#more-than-certified-in-terraform-derek-morgan" title="Permanent link">&para;</a></h1>
<p>Course projects: <a href="https://github.com/liftconfig/terraform-mtc-projects">https://github.com/liftconfig/terraform-mtc-projects</a></p>
<h2 id="section-1-introduction">Section 1: Introduction<a class="headerlink" href="#section-1-introduction" title="Permanent link">&para;</a></h2>
<h3 id="12-terraform-terminology">12. Terraform Terminology<a class="headerlink" href="#12-terraform-terminology" title="Permanent link">&para;</a></h3>
<ul>
<li>Declarative language:</li>
<li>Walks through a dependency graph</li>
<li>Requires state</li>
<li>Idempotent</li>
<li>Not always declarative. For example; provisioners (local/remote-exec) may operate procedurally</li>
</ul>
<h2 id="section-2-terraform-basics-and-docker">Section 2: Terraform Basics and Docker<a class="headerlink" href="#section-2-terraform-basics-and-docker" title="Permanent link">&para;</a></h2>
<h3 id="15-init-deep-dive">15. Init Deep Dive<a class="headerlink" href="#15-init-deep-dive" title="Permanent link">&para;</a></h3>
<p><a href="https://terraform.io/docs/cli/commands/init.html">https://terraform.io/docs/cli/commands/init.html</a></p>
<h3 id="16-terraform-dependency-lock">16. Terraform Dependency Lock<a class="headerlink" href="#16-terraform-dependency-lock" title="Permanent link">&para;</a></h3>
<p><a href="https://terraform.io/docs/language/dependency-lock.html">https://terraform.io/docs/language/dependency-lock.html</a></p>
<ul>
<li>Locks the provider version</li>
<li>Won't let you change the provider version with the lock in place unless you use <code>terraform init -upgrade</code>. This means you don't necessarily have to manually set the version in terraform:required_providers config.</li>
<li>If you use <code>~&gt;</code> you can lock it so only minor version upgrades are permitted x.x.y <code>version = "~&gt; 2.12.0"</code> or x.y <code>version = "~&gt; 2.12"</code>. Whatever is the latest version of the furthest right number will be used.</li>
</ul>
<h3 id="17-your-first-terraform-apply">17. Your first terraform apply<a class="headerlink" href="#17-your-first-terraform-apply" title="Permanent link">&para;</a></h3>
<ul>
<li>Make sure AWS subnet has allocated public IPs enabled</li>
<li>Spin up Cloud9 Instance with access option selected as SSH</li>
<li>Allow SSH from local public IP into EC2 C9 instance inbound security group</li>
<li>Use ssh-keygen to generate pub/private keys on local Linux container. Copy into <code>/home/vscode/.ssh/</code></li>
<li>In C9 append pub key to <code>/home/ubuntu/.ssh/authorized_keys</code></li>
<li><code>ssh ubuntu@x.x.x.x</code> from local Linux container</li>
<li>You can then set the host in the docker provider to <code>host = "ssh://ubuntu@x.x.x.x"</code> and plan/apply terraform</li>
</ul>
<h3 id="18-terraform-plan-apply-deeper-dive">18. Terraform plan &amp; apply deeper dive<a class="headerlink" href="#18-terraform-plan-apply-deeper-dive" title="Permanent link">&para;</a></h3>
<ul>
<li><code>terraform plan -out=plan1</code> creates an encoded plan file. The plan file is not encrypted so it needs to be stored somewhere safe</li>
<li><code>terraform apply plan1</code> no confirmation dialogue, just creates resources</li>
<li><code>terraform plan -destroy</code> simulate a destroy</li>
</ul>
<h3 id="19-referencing-other-resources">19. Referencing other resources<a class="headerlink" href="#19-referencing-other-resources" title="Permanent link">&para;</a></h3>
<p><a href="https://terraform.io/docs/configuration/expressions.html">https://terraform.io/docs/configuration/expressions.html</a></p>
<h3 id="20-view-docker-image-in-browser">20. View docker image in browser<a class="headerlink" href="#20-view-docker-image-in-browser" title="Permanent link">&para;</a></h3>
<ul>
<li>To find public IP of EC2 instance <code>curl http://169.254.169.254/latest/meta-data/public-ipv4</code></li>
</ul>
<h3 id="21-terraform-state-deeper-dive">21. Terraform State Deeper Dive<a class="headerlink" href="#21-terraform-state-deeper-dive" title="Permanent link">&para;</a></h3>
<ul>
<li>Lineage: generated when your state file is originally created. Verify that it's the correct state</li>
<li>terraform.tfstate.backup = previous state file before latest apply</li>
<li>View the state file without accessing the file directly: <code>terraform show -json | jq</code>. jq prettifys the JSON output.</li>
<li><code>terraform state list</code> lists all resources in the state file (1 line per resource). Quick way to check what resources have been provisioned without too much detail.</li>
<li><code>terraform state show xxxx</code> shows the attributes or a resource in the state file</li>
</ul>
<h3 id="22-terraform-console-outputs">22. Terraform Console &amp; Outputs<a class="headerlink" href="#22-terraform-console-outputs" title="Permanent link">&para;</a></h3>
<ul>
<li>Use outputs to display state information which can then be used by other apps or terraform modules</li>
<li>Use <code>terraform console</code> to query the attributes without having to look through the state file</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="w">  </span><span class="err">vscode</span><span class="w"> </span><span class="err">➜</span><span class="w"> </span><span class="err">/workspaces/terraform-associate/</span><span class="w">  </span><span class="err">terraform-docker</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">console</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">  </span><span class="err">&gt;</span><span class="w"> </span><span class="nv">docker_container.nodered_container.name</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span><span class="s2">&quot;nodered&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="err">&gt;</span><span class="w"> </span><span class="nv">docker_container.nodered_container.id</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">  </span><span class="s2">&quot;ee6cc21182468fb448213865632303360d99db6aaf56be5  fa1bbd15038ae7001&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">  </span><span class="err">&gt;</span><span class="w"> </span><span class="nv">docker_container.nodered_container</span><span class="p">.</span><span class="w"> </span><span class="nv">network_data[0].ip_address</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="s2">&quot;172.17.0.2&quot;</span>
</code></pre></div>
<ul>
<li>Add an output resource</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="w">  </span><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;ip-address&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_container.nodered_container.network_data[0].ip_address</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The IP Address of the container&quot;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<ul>
<li>After output resources have been created, you can use <code>terraform output</code> to show the value of all output resources</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="w">  </span><span class="err">vscode</span><span class="w"> </span><span class="err">➜</span><span class="w"> </span><span class="err">/workspaces/terraform-associate/terraform-docker</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">output</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="na">IP-Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;172.17.0.2&quot;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="na">container-name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered&quot;</span>
</code></pre></div>
<h3 id="23-terraform-functions">23. Terraform Functions<a class="headerlink" href="#23-terraform-functions" title="Permanent link">&para;</a></h3>
<p><a href="https://terraform.io/docs/configuration/functions/join.html">https://terraform.io/docs/configuration/functions/join.html</a></p>
<ul>
<li><code>join(separator, list)</code></li>
<li><code>join ("+", ["thing", 1]) = "thing+1"</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="w">  </span><span class="err">&gt;</span><span class="w"> </span><span class="nv">docker_container.nodered_container.network_data[0].ip_address</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="s2">&quot;172.17.0.3&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="err">&gt;</span><span class="w"> </span><span class="nv">docker_container.nodered_container.ports[0].external</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="m">1880</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">  </span><span class="err">&gt;</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">docker_container.nodered_container.network_data[0].ip_address</span><span class="p">,</span><span class="w"> </span><span class="nv">docker_container.nodered_container.ports[0].external</span><span class="p">])</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">  </span><span class="s2">&quot;172.17.0.3:1880&quot;</span>
</code></pre></div>
<h3 id="24-the-random-resource">24. The Random Resource<a class="headerlink" href="#24-the-random-resource" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string">https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string</a></p>
<ul>
<li>Can be used for unique resources names</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="w">  </span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_string&quot;</span><span class="w"> </span><span class="nv">&quot;random&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="na">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="na">upper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">  </span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;-&quot;,[&quot;nodered&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">random_string.random.result</span><span class="p">])</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_image.nodered_image.image_id</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">      </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="c1">      # external = 1880</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="25-multiple-resources-and-count">25. Multiple Resources and Count<a class="headerlink" href="#25-multiple-resources-and-count" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/meta-arguments/count">https://developer.hashicorp.com/terraform/language/meta-arguments/count</a></p>
<ul>
<li>Count.index will reference the current resource count #. Combine with random_string to reference a matching random_string index.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w">  </span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_string&quot;</span><span class="w"> </span><span class="nv">&quot;random&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="na">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="na">upper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">  </span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">    </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;-&quot;,[&quot;nodered&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">random_string.random[count.index].result</span><span class="p">])</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_image.nodered_image.image_id</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">      </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="c1">      # external = 1880</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="26-the-splat-expression">26. The splat expression<a class="headerlink" href="#26-the-splat-expression" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/expressions/splat">https://developer.hashicorp.com/terraform/language/expressions/splat</a></p>
<ul>
<li>Used like a for loop, but allows you to more concisely reference all the resources created by count</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="w">  </span><span class="err">vscode</span><span class="w"> </span><span class="err">➜</span><span class="w"> </span><span class="err">/workspaces/terraform-associate/terraform-docker</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">console</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="err">&gt;</span><span class="w"> </span><span class="nv">docker_container.nodered_container</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">name</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="p">[</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="s2">&quot;nodered-s061&quot;</span><span class="p">,</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="s2">&quot;nodered-9pu5&quot;</span><span class="p">,</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">  </span><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;container-name&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_container.nodered_container</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">name</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The name of the container&quot;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="27-for-expression">27. For Expression<a class="headerlink" href="#27-for-expression" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="err">&gt;</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">]:</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="m">1</span><span class="p">]</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="p">[</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="m">2</span><span class="p">,</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span><span class="m">3</span><span class="p">,</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">  </span><span class="m">4</span><span class="p">,</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="p">]</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="err">&gt;</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">docker_container.nodered_container</span><span class="p">[</span><span class="err">*</span><span class="p">]:</span><span class="w"> </span><span class="nv">i.name</span><span class="p">]</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="p">[</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">  </span><span class="s2">&quot;nodered-s061&quot;</span><span class="p">,</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">  </span><span class="s2">&quot;nodered-9pu5&quot;</span><span class="p">,</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="p">]</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="err">&gt;</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">docker_container.nodered_container</span><span class="p">[</span><span class="err">*</span><span class="p">]:</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;:&quot;,[i.network_data[0].ip_address, i.ports[0][&quot;external&quot;</span><span class="p">]])]</span><span class="w"> </span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="p">[</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">  </span><span class="s2">&quot;172.17.0.3:32776&quot;</span><span class="p">,</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">  </span><span class="s2">&quot;172.17.0.2:32775&quot;</span><span class="p">,</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="p">]</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;container-name&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_container.nodered_container</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">name</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The name of the container&quot;</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="p">}</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;ip-address&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">docker_container.nodered_container</span><span class="p">[</span><span class="err">*</span><span class="p">]:</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;:&quot;,[i.network_data[0].ip_address, i.ports[0][&quot;external&quot;</span><span class="p">]])]</span><span class="w"> </span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The IP Address and external port of the container&quot;</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="p">}</span>
</code></pre></div>
<h3 id="28-tainting-resources">28. Tainting Resources<a class="headerlink" href="#28-tainting-resources" title="Permanent link">&para;</a></h3>
<ul>
<li>Deprecated in favour of <code>-replace=...</code> option when using plan/apply</li>
<li>Way to force a resource to be destroyed and re-created. Example use case is if you need to re-apply a configuration from a volume. Similar to rebooting / reloading a daemon</li>
<li>Be very careful with taint. For example if you taint the random_string resource, the resource that relies on it for its name would also get replaced on next apply</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>vscode<span class="w"> </span>➜<span class="w"> </span>/workspaces/terraform-associate/terraform-docker<span class="w"> </span>$<span class="w"> </span>terraform<span class="w"> </span>taint<span class="w"> </span>random_string.random<span class="o">[</span><span class="m">0</span><span class="o">]</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>Resource<span class="w"> </span>instance<span class="w"> </span>random_string.random<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span>has<span class="w"> </span>been<span class="w"> </span>marked<span class="w"> </span>as<span class="w"> </span>tainted.
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>vscode<span class="w"> </span>➜<span class="w"> </span>/workspaces/terraform-associate/terraform-docker<span class="w"> </span>$<span class="w"> </span>terraform<span class="w"> </span>plan
</code></pre></div>
<ul>
<li>Untaint a resource <code>terraform untaint random_string.random[0]</code></li>
</ul>
<h3 id="29-state-locking-breaking-state">29. State locking &amp; breaking state<a class="headerlink" href="#29-state-locking-breaking-state" title="Permanent link">&para;</a></h3>
<ul>
<li><code>terraform apply -lock=true</code> is the default. If you don't lock the state there's a potential for corruption if multiple updates are done simultaneously.</li>
</ul>
<h3 id="30-terraform-import">30. Terraform import<a class="headerlink" href="#30-terraform-import" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/cli/import">https://developer.hashicorp.com/terraform/cli/import</a></p>
<p><code>terraform import docker_container.nodered_container2 $(docker inspect --format="{{.ID}}" nodered-3pfl)</code></p>
<ul>
<li>You can find the above import statement in the import section of the terraform docker provider.</li>
</ul>
<h3 id="31-terraform-refresh-and-state-rm">31. Terraform Refresh and State rm<a class="headerlink" href="#31-terraform-refresh-and-state-rm" title="Permanent link">&para;</a></h3>
<ul>
<li><code>terraform refresh</code> manually refresh state. If an object name has changed this will update the state file without having to apply.</li>
<li><code>terraform state rm random_string.random[1]</code> Manually remove a resource from the state file. Only should be done when you don't want to run a terraform apply immediately (if for example, you're deleting a random_string resources that is also used for the name of another resource).</li>
</ul>
<h3 id="32-adding-variables">32. Adding Variables<a class="headerlink" href="#32-adding-variables" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/values/variables">https://developer.hashicorp.com/terraform/language/values/variables</a></p>
<ul>
<li>If you don't define a default value or a value, the console will ask you for a value on every plan/apply/destroy</li>
<li>You can specify the value on the CLI <code>terraform plan -var ext_port=1880</code></li>
<li>You can specify the value using ENV variables <code>export TF_VAR_ext_port=1880</code>. Unset with <code>unset TF_VAR_ext_port</code></li>
</ul>
<h3 id="33-variable-validation">33. Variable Validation<a class="headerlink" href="#33-variable-validation" title="Permanent link">&para;</a></h3>
<ul>
<li>See variables link above. Allows you to put conditions and error messages within the variable block to validate the values</li>
</ul>
<h3 id="35-sensitive-variables">35. Sensitive Variables<a class="headerlink" href="#35-sensitive-variables" title="Permanent link">&para;</a></h3>
<ul>
<li><code>terraform.tfvars</code> is your variable definition file. This file should always be added to your git ignore file</li>
</ul>
<h3 id="36-variable-definition-procedure">36. Variable Definition Procedure<a class="headerlink" href="#36-variable-definition-procedure" title="Permanent link">&para;</a></h3>
<ul>
<li>Specify different tfvar file for different environments <code>terraform plan --var-file west.tfvars</code></li>
<li>Any variables specified in the CLI will override the default terraform.tfvars file</li>
<li>If you specify both a <code>--var-file</code> and a <code>-var</code> on the command line then order matters. The last item in the command will win e.g. <code>terraform plan -var-file=west.tfvars -var ext_port=2000</code> then the -var value of 2000 will be used. <code>terraform plan  -var ext_port=2000 -var-file=west.tfvars</code> then the value of ext_port from west.tfvars will be used.</li>
</ul>
<h3 id="37-hiding-sensitive-values-from-cli">37. Hiding sensitive values from CLI<a class="headerlink" href="#37-hiding-sensitive-values-from-cli" title="Permanent link">&para;</a></h3>
<ul>
<li>Set <code>sensitive = true</code> in the variable</li>
<li>If you try to use a sensitive variable in a non-sensitive output you will get the following error:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="w">  </span><span class="err">Error</span><span class="p">:</span><span class="w"> </span><span class="err">Output</span><span class="w"> </span><span class="err">refers</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">sensitive</span><span class="w"> </span><span class="err">values</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">  </span><span class="err">on</span><span class="w"> </span><span class="nv">outputs.tf</span><span class="w"> </span><span class="err">line</span><span class="w"> </span><span class="m">6</span><span class="p">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span><span class="m">6</span><span class="p">:</span><span class="w"> </span><span class="err">output</span><span class="w"> </span><span class="s2">&quot;ip-address&quot;</span>
</code></pre></div>
<ul>
<li><code>terraform show | grep external</code> will also show as sensitive</li>
<li>Only place sensitive variables are not hidden is in the terraform.tfstate file</li>
</ul>
<h3 id="38-the-bind-mount-and-local-exec">38. The bind mount and local-exec<a class="headerlink" href="#38-the-bind-mount-and-local-exec" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/resources/provisioners/local-exec">https://developer.hashicorp.com/terraform/language/resources/provisioners/local-exec</a></p>
<ul>
<li>Invokes a local executable on the machine running terraform after a resource has been created.</li>
<li>Remote exec will do the same but on a remote machine</li>
<li>Not recommended to use local-exec as it's not idempotent, will run on every apply. Use a configuration management tool like Ansible instead.</li>
<li>Local-exec provisioner needs to run in a resource block. You can use null_resource for this</li>
<li>Example - create a directory for a container's persistent volume using remote-exec:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="w">  </span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;null_resource&quot;</span><span class="w"> </span><span class="nv">&quot;dockevol&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="nb">connection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">      </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh&quot;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">      </span><span class="na">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">      </span><span class="na">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x.x.x.x&quot;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">      </span><span class="na">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${file(&quot;../id_rsa&quot;)}&quot;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;remote-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">      </span><span class="na">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">        </span><span class="s2">&quot;mkdir /home/ubuntu/environment/noderedvol/ || true &amp;&amp; sudo chown -R 1000:1000 /home/ubuntu/environment/noderedvol/&quot;</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">      </span><span class="p">]</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">  </span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.container_count</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">    </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;-&quot;,[&quot;nodered&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">random_string.random[count.index].result</span><span class="p">])</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">    </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_image.nodered_image.image_id</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">    </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">      </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">      </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">    </span><span class="nb">volumes</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">      </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/data&quot;</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">      </span><span class="na">host_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/home/ubuntu/environment/noderedvol&quot;</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="w">    </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">null_resource.dockervol</span><span class="w"> </span><span class="p">]</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="39-utilising-local-values">39. Utilising Local Values<a class="headerlink" href="#39-utilising-local-values" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/values/locals">https://developer.hashicorp.com/terraform/language/values/locals</a></p>
<ul>
<li>Local values are like a traditional functions temporary local variables</li>
<li>Example - creating a local var for counting the number of items in a list:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="w">  </span><span class="na">ext_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">1880</span><span class="p">,</span><span class="w"> </span><span class="m">1881</span><span class="p">,</span><span class="w"> </span><span class="m">1882</span><span class="p">,</span><span class="w"> </span><span class="m">1883</span><span class="p">]</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">  </span><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="na">container_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">)</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="40-min-max-functions-the-expand-expression">40. Min &amp; Max functions. The expand expression<a class="headerlink" href="#40-min-max-functions-the-expand-expression" title="Permanent link">&para;</a></h3>
<ul>
<li>The expand expression can be used to expand a list of values so that they can be evaluated by the likes of min/max. These functions don't allow lists natively</li>
<li><code>max([10, 20, 30]...), max is 30</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="w">  </span><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;ext_port&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">list</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="nb">validation</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">      </span><span class="na">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">...)</span><span class="w"> </span><span class="err">&lt;</span><span class="p">=</span><span class="w"> </span><span class="m">65535</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span><span class="err">min</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">...)</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">      </span><span class="na">error_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The external port must be between 0 and 65535&quot;</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="41-path-references-and-string-interpolation">41. Path references and string interpolation<a class="headerlink" href="#41-path-references-and-string-interpolation" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/expressions/references">https://developer.hashicorp.com/terraform/language/expressions/references</a></p>
<ul>
<li>Evaluates expression inside ${..}. Allows you to insert a variable in a string <code>"Hello, ${var.name}!"</code></li>
</ul>
<h3 id="42-maps-and-lookups-the-image-variable">42. Maps and Lookups: the Image Variable<a class="headerlink" href="#42-maps-and-lookups-the-image-variable" title="Permanent link">&para;</a></h3>
<p><a href="https://stackoverflow.com/questions/11489428/how-to-make-vim-paste-from-and-copy-to-systems-clipboard">https://stackoverflow.com/questions/11489428/how-to-make-vim-paste-from-and-copy-to-systems-clipboard</a>
<a href="https://developer.hashicorp.com/terraform/language/functions/lookup">https://developer.hashicorp.com/terraform/language/functions/lookup</a></p>
<ul>
<li>Use case is for setting the value of identifiers depending on the environment (prod, dev, test)</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="w">  </span><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;env&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Env to deploy to&quot;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">  </span><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;image&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">map</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Image to container&quot;</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">      </span><span class="na">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest&quot;</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">      </span><span class="na">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest-minimal&quot;</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">  </span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_image&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_image&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.image</span><span class="p">,</span><span class="w"> </span><span class="nv">var.env</span><span class="p">)</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">plan</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="err">grep</span><span class="w"> </span><span class="err">name</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">      </span><span class="err">+</span><span class="w"> </span><span class="na">hostname</span><span class="w">                                    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="err">known</span><span class="w"> </span><span class="err">after</span><span class="w"> </span><span class="err">apply</span><span class="p">)</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">      </span><span class="err">+</span><span class="w"> </span><span class="na">name</span><span class="w">                                        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="err">known</span><span class="w"> </span><span class="err">after</span><span class="w"> </span><span class="err">apply</span><span class="p">)</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">      </span><span class="err">+</span><span class="w"> </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest&quot;</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">  </span><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">plan</span><span class="w"> </span><span class="na">-var</span><span class="o">=</span><span class="s2">&quot;env=prod&quot;</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="err">grep</span><span class="w"> </span><span class="err">name</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">      </span><span class="err">+</span><span class="w"> </span><span class="na">hostname</span><span class="w">                                    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="err">known</span><span class="w"> </span><span class="err">after</span><span class="w"> </span><span class="err">apply</span><span class="p">)</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">      </span><span class="err">+</span><span class="w"> </span><span class="na">name</span><span class="w">                                        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="err">known</span><span class="w"> </span><span class="err">after</span><span class="w"> </span><span class="err">apply</span><span class="p">)</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">      </span><span class="err">+</span><span class="w"> </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest-minimal&quot;</span>
</code></pre></div>
<ul>
<li>Example - setting ports for docker container based on environment:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="w">  </span><span class="nb">ext_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="na">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">1980</span><span class="p">,</span><span class="w"> </span><span class="m">1981</span><span class="p">]</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="na">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">1880</span><span class="p">,</span><span class="w"> </span><span class="m">1881</span><span class="p">]</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">  </span><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;ext_port&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">map</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="nb">validation</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">      </span><span class="na">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;dev&quot;]...) &lt;= 65535 &amp;&amp; min(var.ext_port[&quot;dev&quot;</span><span class="p">]...)</span><span class="w"> </span><span class="err">&gt;</span><span class="p">=</span><span class="w"> </span><span class="m">1980</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">      </span><span class="na">error_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The external port must be between 0 and 65535&quot;</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">    </span><span class="nb">validation</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">      </span><span class="na">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;prod&quot;]...) &lt;= 1980 &amp;&amp; min(var.ext_port[&quot;prod&quot;</span><span class="p">]...)</span><span class="w"> </span><span class="err">&gt;</span><span class="p">=</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">      </span><span class="na">error_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The external port must be between 0 and 65535&quot;</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">  </span><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">    </span><span class="na">container_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">,</span><span class="w"> </span><span class="nv">var.env</span><span class="p">))</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">  </span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">    </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.container_count</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">    </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;-&quot;,[&quot;nodered&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">random_string.random[count.index].result</span><span class="p">])</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">    </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_image.nodered_image.image_id</span>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="w">    </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">      </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="w">      </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">,</span><span class="nv">var.env</span><span class="p">)[</span><span class="nv">count.index</span><span class="p">]</span>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="w">    </span><span class="nb">volumes</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="w">      </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/data&quot;</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="w">      </span><span class="na">host_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/home/ubuntu/environment/noderedvol&quot;</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="w">    </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">null_resource.dockervol</span><span class="w"> </span><span class="p">]</span>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Note you can't reference another variable in a variable definition so you can't use var.env in the ext_port validation</p>
</blockquote>
<h3 id="44-terraform-workspaces">44. Terraform Workspaces<a class="headerlink" href="#44-terraform-workspaces" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/cloud-docs/workspaces">https://developer.hashicorp.com/terraform/cloud-docs/workspaces</a></p>
<ul>
<li>Isolated versions of the terraform state that allows you to deploy multiple versions of the same environment with different variables, counts etc.</li>
<li>Typically, workspaces are tied to branches in git. Work better in small well-defined environments. Could become hard to manage if there are many differences between environments</li>
<li>Only particular backends support multiple workspaces (most popular ones do)</li>
<li>New folders for workspace state will be stored in <code>terraform.tfstat.d/"workspace name"</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="err">terraform</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">dev</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="err">terraform</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">prod</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="err">terraform</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="err">show</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="err">terraform</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="kt">list</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">  </span><span class="err">default</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">  </span><span class="err">dev</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="err">*</span><span class="w"> </span><span class="err">prod</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="err">terraform</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="err">select</span><span class="w"> </span><span class="err">dev</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="err">terraform</span><span class="w"> </span><span class="err">apply</span><span class="w"> </span><span class="err">--auto-approve</span><span class="w"> </span><span class="na">-var</span><span class="o">=</span><span class="s2">&quot;env=dev&quot;</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="err">Apply</span><span class="w"> </span><span class="err">complete</span><span class="p">!</span><span class="w"> </span><span class="err">Resources</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="err">added</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="err">changed</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="err">destroyed</span><span class="p">.</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="err">Outputs</span><span class="p">:</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="na">container-name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">  </span><span class="s2">&quot;nodered-q0tu&quot;</span><span class="p">,</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">  </span><span class="s2">&quot;nodered-gwtn&quot;</span><span class="p">,</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="p">]</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="na">ip-address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">  </span><span class="s2">&quot;172.17.0.3:1980&quot;</span><span class="p">,</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">  </span><span class="s2">&quot;172.17.0.2:1981&quot;</span><span class="p">,</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="p">]</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="err">terraform</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="err">select</span><span class="w"> </span><span class="err">prod</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="err">terraform</span><span class="w"> </span><span class="err">apply</span><span class="w"> </span><span class="err">--auto-approve</span><span class="w"> </span><span class="na">-var</span><span class="o">=</span><span class="s2">&quot;env=prod&quot;</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="err">Outputs</span><span class="p">:</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="na">container-name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="w">  </span><span class="s2">&quot;nodered-swel&quot;</span><span class="p">,</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="w">  </span><span class="s2">&quot;nodered-25uo&quot;</span><span class="p">,</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="p">]</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="na">ip-address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="w">  </span><span class="s2">&quot;172.17.0.5:1880&quot;</span><span class="p">,</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a><span class="w">  </span><span class="s2">&quot;172.17.0.4:1881&quot;</span><span class="p">,</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="p">]</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="err">~/environment</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="err">docker</span><span class="w"> </span><span class="err">image</span><span class="w"> </span><span class="err">ls</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a><span class="err">REPOSITORY</span><span class="w">         </span><span class="err">TAG</span><span class="w">              </span><span class="err">IMAGE</span><span class="w"> </span><span class="err">ID</span><span class="w">       </span><span class="err">CREATED</span><span class="w">      </span><span class="err">SIZE</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a><span class="err">nodered/node-red</span><span class="w">   </span><span class="err">latest-minimal</span><span class="w">   </span><span class="m">7</span><span class="err">b</span><span class="m">324</span><span class="err">af</span><span class="m">6</span><span class="err">f</span><span class="m">086</span><span class="w">   </span><span class="m">7</span><span class="w"> </span><span class="err">days</span><span class="w"> </span><span class="err">ago</span><span class="w">   </span><span class="m">272</span><span class="err">MB</span>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a><span class="err">nodered/node-red</span><span class="w">   </span><span class="err">latest</span><span class="w">           </span><span class="m">4</span><span class="err">eb</span><span class="m">056</span><span class="err">ef</span><span class="m">6</span><span class="err">be</span><span class="m">0</span><span class="w">   </span><span class="m">7</span><span class="w"> </span><span class="err">days</span><span class="w"> </span><span class="err">ago</span><span class="w">   </span><span class="m">558</span><span class="err">MB</span>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a><span class="err">~/environment</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="err">docker</span><span class="w"> </span><span class="err">ps</span>
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a><span class="err">CONTAINER</span><span class="w"> </span><span class="err">ID</span><span class="w">   </span><span class="err">IMAGE</span><span class="w">          </span><span class="err">COMMAND</span><span class="w">             </span><span class="err">CREATED</span><span class="w">          </span><span class="err">STATUS</span><span class="w">                             </span><span class="err">PORTS</span><span class="w">                    </span><span class="err">NAMES</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a><span class="m">909</span><span class="err">aad</span><span class="m">51</span><span class="err">f</span><span class="m">8</span><span class="err">ca</span><span class="w">   </span><span class="m">7</span><span class="err">b</span><span class="m">324</span><span class="err">af</span><span class="m">6</span><span class="err">f</span><span class="m">086</span><span class="w">   </span><span class="s2">&quot;./entrypoint.sh&quot;</span><span class="w">   </span><span class="m">14</span><span class="w"> </span><span class="err">seconds</span><span class="w"> </span><span class="err">ago</span><span class="w">   </span><span class="err">Up</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="err">seconds</span><span class="w"> </span><span class="p">(</span><span class="err">health</span><span class="p">:</span><span class="w"> </span><span class="err">starting</span><span class="p">)</span><span class="w">   </span><span class="nv">0.0.0.0</span><span class="p">:</span><span class="m">1880</span><span class="err">-&gt;</span><span class="m">1880</span><span class="err">/tcp</span><span class="w">   </span><span class="err">nodered-swel</span>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a><span class="err">f</span><span class="m">9</span><span class="err">da</span><span class="m">0351780</span><span class="err">d</span><span class="w">   </span><span class="m">7</span><span class="err">b</span><span class="m">324</span><span class="err">af</span><span class="m">6</span><span class="err">f</span><span class="m">086</span><span class="w">   </span><span class="s2">&quot;./entrypoint.sh&quot;</span><span class="w">   </span><span class="m">14</span><span class="w"> </span><span class="err">seconds</span><span class="w"> </span><span class="err">ago</span><span class="w">   </span><span class="err">Up</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="err">seconds</span><span class="w"> </span><span class="p">(</span><span class="err">health</span><span class="p">:</span><span class="w"> </span><span class="err">starting</span><span class="p">)</span><span class="w">   </span><span class="nv">0.0.0.0</span><span class="p">:</span><span class="m">1881</span><span class="err">-&gt;</span><span class="m">1880</span><span class="err">/tcp</span><span class="w">   </span><span class="err">nodered-</span><span class="m">25</span><span class="err">uo</span>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a><span class="err">bc</span><span class="m">7</span><span class="err">f</span><span class="m">1018</span><span class="err">bff</span><span class="m">3</span><span class="w">   </span><span class="m">4</span><span class="err">eb</span><span class="m">056</span><span class="err">ef</span><span class="m">6</span><span class="err">be</span><span class="m">0</span><span class="w">   </span><span class="s2">&quot;./entrypoint.sh&quot;</span><span class="w">   </span><span class="m">2</span><span class="w"> </span><span class="err">minutes</span><span class="w"> </span><span class="err">ago</span><span class="w">    </span><span class="err">Up</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="err">minutes</span><span class="w"> </span><span class="p">(</span><span class="err">healthy</span><span class="p">)</span><span class="w">             </span><span class="nv">0.0.0.0</span><span class="p">:</span><span class="m">1981</span><span class="err">-&gt;</span><span class="m">1880</span><span class="err">/tcp</span><span class="w">   </span><span class="err">nodered-gwtn</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a><span class="err">c</span><span class="m">6412</span><span class="err">f</span><span class="m">9</span><span class="err">c</span><span class="m">4</span><span class="err">ce</span><span class="m">4</span><span class="w">   </span><span class="m">4</span><span class="err">eb</span><span class="m">056</span><span class="err">ef</span><span class="m">6</span><span class="err">be</span><span class="m">0</span><span class="w">   </span><span class="s2">&quot;./entrypoint.sh&quot;</span><span class="w">   </span><span class="m">2</span><span class="w"> </span><span class="err">minutes</span><span class="w"> </span><span class="err">ago</span><span class="w">    </span><span class="err">Up</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="err">minutes</span><span class="w"> </span><span class="p">(</span><span class="err">healthy</span><span class="p">)</span><span class="w">             </span><span class="nv">0.0.0.0</span><span class="p">:</span><span class="m">1980</span><span class="err">-&gt;</span><span class="m">1880</span><span class="err">/tcp</span><span class="w">   </span><span class="err">nodered-q</span><span class="m">0</span><span class="err">tu</span>
</code></pre></div>
<h3 id="45-referencing-your-workspaces">45. Referencing your Workspaces<a class="headerlink" href="#45-referencing-your-workspaces" title="Permanent link">&para;</a></h3>
<ul>
<li>Use <code>terraform.workspace</code> instead of creating a var.env</li>
<li>This means you don't have to specify the environment variable when doing a terraform apply (less chance of an error)</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="err">vscode</span><span class="w"> </span><span class="err">➜</span><span class="w"> </span><span class="err">/workspaces/terraform-associate/terraform-docker</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">workspace</span><span class="w"> </span><span class="err">select</span><span class="w"> </span><span class="err">prod</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="err">vscode</span><span class="w"> </span><span class="err">➜</span><span class="w"> </span><span class="err">/workspaces/terraform-associate/terraform-docker</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">console</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="err">&gt;</span><span class="w"> </span><span class="nv">terraform.workspace</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="s2">&quot;prod&quot;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_image&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_image&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.image</span><span class="p">,</span><span class="w"> </span><span class="nv">terraform.workspace</span><span class="p">)</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="p">}</span>
</code></pre></div>
<h3 id="46-using-map-keys-instead-of-lookups">46. Using Map Keys instead of Lookups<a class="headerlink" href="#46-using-map-keys-instead-of-lookups" title="Permanent link">&para;</a></h3>
<ul>
<li>Map keys = new way of accessing map values without a lookup. Preferred way of using map in most scenarios</li>
<li>Only reason to use a lookup over a map key is the default value you can specify <code>lookup(map, key, default)</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">  </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">  </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">,</span><span class="nv">terraform.workspace</span><span class="p">)[</span><span class="nv">count.index</span><span class="p">]</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="p">}</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">  </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">  </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port[terraform.workspace][count.index</span><span class="p">]</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="p">}</span>
</code></pre></div>
<h2 id="section-3-modular-deployments">Section 3: Modular Deployments<a class="headerlink" href="#section-3-modular-deployments" title="Permanent link">&para;</a></h2>
<h3 id="47-modules-intro">47. Modules Intro<a class="headerlink" href="#47-modules-intro" title="Permanent link">&para;</a></h3>
<p><img alt="Module Overview Diagram" src="../../assets/images/terraform/image.png" /></p>
<h3 id="48-first-module">48. First Module!<a class="headerlink" href="#48-first-module" title="Permanent link">&para;</a></h3>
<ul>
<li>Move Terraform required providers and provider attributes into their own <code>providers.tf</code> file</li>
<li>Run <code>terraform init</code> whenever a new module is used to create a resource</li>
<li>Create a new module folder and base files <code>mkdir image/ &amp;&amp; cd image/ &amp;&amp; touch variables.tf main.tf outputs.tf providers.tf</code></li>
<li>Passing outputs from a module:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;image&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./image&quot;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="p">}</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.container_count</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">  </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;-&quot;,[&quot;nodered&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">terraform.workspace</span><span class="p">,</span><span class="w"> </span><span class="nv">random_string.random[count.index].result</span><span class="p">])</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">  </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.image.image_out</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="c1"># --- image/main.tf ---</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_image&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_image&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">nodred/node-red</span><span class="p">:</span><span class="err">latest</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="p">}</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="c1"># --- image/outputs.tf ---</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;image_out&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_image.nodered_image.image_id</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="p">}</span>
</code></pre></div>
<h3 id="49-module-variables">49. Module Variables<a class="headerlink" href="#49-module-variables" title="Permanent link">&para;</a></h3>
<ul>
<li>Modules shouldn't have any hardcoded values and should be rarely changed. Only specific people should have access to edit modules</li>
<li>Passing variables into modules:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># --- main.tf ---</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;image&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./image&quot;</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">  </span><span class="na">image_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image[terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="p">}</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="c1"># --- variables.tf ---</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;image&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">map</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Image to container&quot;</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">    </span><span class="na">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest&quot;</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">    </span><span class="na">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest-minimal&quot;</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="p">}</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="c1"># --- image/main.tf ---</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_image&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_image&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image_in</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="p">}</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="c1"># --- image/variables.tf ---</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;image_in&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;name of image&quot;</span>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="p">}</span>
</code></pre></div>
<h3 id="50-terraform-graph">50. Terraform Graph<a class="headerlink" href="#50-terraform-graph" title="Permanent link">&para;</a></h3>
<ul>
<li>Terraform Graph combined with graphViz allows you to visually see your deployment dependencies</li>
<li><code>Terraform validate</code> validate your configuration code without doing a plan/apply</li>
<li>Install graphviz: <code>sudo apt install graphviz</code></li>
<li>Create a PDF: <code>terraform graph | dot -Tpdf &gt; graph-plan.pdf</code></li>
<li>Create a PNG: <code>terraform graph | dot -Tpng &gt; graph-plan.png</code></li>
<li>Create a PNG of plan to destroy: `terraform graph -type=plan-destroy| dot -Tpng &gt; graph-destroy.png</li>
<li>Very useful for finding dependency issues</li>
</ul>
<h3 id="51-troubleshooting-dependencies">51. Troubleshooting Dependencies<a class="headerlink" href="#51-troubleshooting-dependencies" title="Permanent link">&para;</a></h3>
<ul>
<li>Can create two kinds of manual dependencies - implicit and explicit</li>
<li>Implicit: You reference one of the resources attributes within your calling resource</li>
<li>Explicit: Use <code>depends_on</code> within a resource</li>
</ul>
<h3 id="52-the-container-module-module-outputs">52. The Container Module + module outputs<a class="headerlink" href="#52-the-container-module-module-outputs" title="Permanent link">&para;</a></h3>
<ul>
<li>Reference the outputs of the module in the main outputs file</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># --- container/main.tf ---</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.name_in</span><span class="w"> </span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">  </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image_in</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">  </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port_in</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">    </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port_in</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">  </span><span class="nb">volumes</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">    </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.container_path_in</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">    </span><span class="na">host_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.host_path_in</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="p">}</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="c1"># --- container/outputs.tf ---</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;container-name&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_container.nodered_container.name</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The name of the container&quot;</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="p">}</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;ip-address&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">docker_container.nodered_container</span><span class="p">[</span><span class="err">*</span><span class="p">]:</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;:&quot;,[i.network_data[0].ip_address, i.ports[0][&quot;external&quot;</span><span class="p">]])]</span><span class="w"> </span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The IP Address and external port of the container&quot;</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="p">}</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="c1"># alternative:</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;ip-address&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">flatten</span><span class="p">(</span><span class="nv">module.container</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">ip-address</span><span class="p">)</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The IP Address and external port of the container&quot;</span>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="p">}</span>
</code></pre></div>
<h3 id="54-module-information-flow">54. Module information flow<a class="headerlink" href="#54-module-information-flow" title="Permanent link">&para;</a></h3>
<p><img alt="Variables flowing between modules" src="../../assets/images/terraform/image-1.png" /></p>
<ul>
<li>Information doesn't flow directly between modules. Variables are passed between modules as outputs and inputs via the root module.</li>
</ul>
<h3 id="55-docker-volume">55. Docker Volume<a class="headerlink" href="#55-docker-volume" title="Permanent link">&para;</a></h3>
<ul>
<li>Consider if you need a separate module for certain resources or if they should be included within another module</li>
<li>In this example each container will always have a volume so it makes sense to include it in the container module</li>
<li>You can use the <code>volumes</code> block in the docker_container resource to create a volume but the only problem is these won't get removed with <code>terraform destroy</code></li>
<li>Correct way is to use a docker_volume resource</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;nodered_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.name_in</span><span class="w"> </span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">  </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image_in</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port_in</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port_in</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">  </span><span class="nb">volumes</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">    </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.container_path_in</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">    </span><span class="na">volume_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_volume.container_volume.name</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="p">}</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_volume&quot;</span><span class="w"> </span><span class="nv">&quot;container_volume&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name_in}-volume&quot;</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>root@ip-172-31-0-155:/home/ubuntu/environment#<span class="w"> </span>docker<span class="w"> </span>volume<span class="w"> </span>ls
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>DRIVER<span class="w">    </span>VOLUME<span class="w"> </span>NAME
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="nb">local</span><span class="w">     </span>nodered-dev-jtar-volume
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="nb">local</span><span class="w">     </span>nodered-dev-zkyc-volume
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>root@ip-172-31-0-155:/home/ubuntu/environment#<span class="w"> </span>ls<span class="w"> </span>/var/lib/docker/volumes/nodered-dev-jtar-volume/_data/
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>flows.json<span class="w">  </span>lib<span class="w">  </span>node_modules<span class="w">  </span>package.json<span class="w">  </span>settings.js
</code></pre></div>
<h3 id="56-lifecycle-customisation-and-targeting">56. Lifecycle Customisation and Targeting<a class="headerlink" href="#56-lifecycle-customisation-and-targeting" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/meta-arguments/lifecycle">https://developer.hashicorp.com/terraform/language/meta-arguments/lifecycle</a></p>
<ul>
<li>Lifecycle block arguments <code>create_before_destroy</code>, <code>prevent_destroy</code>, <code>ignore_changes</code></li>
<li>Target a particular resource for destruction</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">state</span><span class="w"> </span><span class="kt">list</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="nv">module.container[0].docker_container.nodered_container</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="nv">module.container[0].docker_volume.container_volume</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="nv">module.container[1].docker_container.nodered_container</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="nv">module.container[1].docker_volume.container_volume</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="nv">module.image.docker_image.nodered_image</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">destroy</span><span class="w"> </span><span class="na">-target</span><span class="o">=</span><span class="nv">module.container[0].docker_container.nodered_container</span>
</code></pre></div>
<h3 id="58-using-for_each">58. Using for_each<a class="headerlink" href="#58-using-for_each" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/meta-arguments/for_each">https://developer.hashicorp.com/terraform/language/meta-arguments/for_each</a></p>
<ul>
<li>One type of design pattern, may not work for everyone</li>
<li>Cycles through a map of objects</li>
<li>Resources that use count use a numerical index, whereas for_each has a key value. A lot easier to troubleshoot and manage keys.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nv">module.container[0].docker_container.nodered_container</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nv">module.container[0].docker_volume.container_volume</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="err">vs</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="nv">module.image</span><span class="p">[</span><span class="s2">&quot;influxdb&quot;</span><span class="p">].</span><span class="nv">docker_image.container_image</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="nv">module.image</span><span class="p">[</span><span class="s2">&quot;nodered&quot;</span><span class="p">].</span><span class="nv">docker_image.container_image</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">  </span><span class="nb">deployment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="nb">nodered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">      </span><span class="na">container_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;nodered&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">])</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">      </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image</span><span class="p">[</span><span class="s2">&quot;nodered&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">      </span><span class="na">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">      </span><span class="na">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;nodered&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">      </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/data&quot;</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">    </span><span class="nb">influxdb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">      </span><span class="na">container_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;influxdb&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">])</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">      </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image</span><span class="p">[</span><span class="s2">&quot;influxdb&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">      </span><span class="na">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8086</span><span class="w"> </span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">      </span><span class="na">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;influxdb&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">      </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/var/lib/influxdb&quot;</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="p">}</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;image&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./image&quot;</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.deployment</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">  </span><span class="na">image_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.image</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="p">}</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./container&quot;</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.deployment</span>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="w">  </span><span class="na">count_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.container_count</span>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a><span class="w">  </span><span class="na">name_in</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="w">  </span><span class="na">image_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.image[each.key].image_out</span>
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="w">  </span><span class="na">int_port_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.int</span>
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="w">  </span><span class="na">ext_port_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.ext</span>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a><span class="w">  </span><span class="na">container_path_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.container_path</span>
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a><span class="p">}</span>
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a><span class="c1"># --- root/terraform.tfvars ---</span>
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a><span class="nb">ext_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a><span class="w">  </span><span class="nb">nodered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a><span class="w">    </span><span class="na">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">1980</span><span class="p">]</span>
<a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a><span class="w">    </span><span class="na">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">1880</span><span class="p">]</span>
<a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a><span class="w">  </span><span class="nb">influxdb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a><span class="w">    </span><span class="na">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">8186</span><span class="p">,</span><span class="w"> </span><span class="m">8187</span><span class="p">]</span>
<a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a><span class="w">    </span><span class="na">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">8086</span><span class="p">]</span>
<a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a><span class="p">}</span><span class="c1"> </span>
<a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a>
<a id="__codelineno-25-52" name="__codelineno-25-52" href="#__codelineno-25-52"></a><span class="c1"># --- container/main.tf ---</span>
<a id="__codelineno-25-53" name="__codelineno-25-53" href="#__codelineno-25-53"></a>
<a id="__codelineno-25-54" name="__codelineno-25-54" href="#__codelineno-25-54"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_string&quot;</span><span class="w"> </span><span class="nv">&quot;random&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-55" name="__codelineno-25-55" href="#__codelineno-25-55"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.count_in</span>
<a id="__codelineno-25-56" name="__codelineno-25-56" href="#__codelineno-25-56"></a><span class="w">  </span><span class="na">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<a id="__codelineno-25-57" name="__codelineno-25-57" href="#__codelineno-25-57"></a><span class="w">  </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-25-58" name="__codelineno-25-58" href="#__codelineno-25-58"></a><span class="w">  </span><span class="na">upper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-25-59" name="__codelineno-25-59" href="#__codelineno-25-59"></a><span class="p">}</span>
<a id="__codelineno-25-60" name="__codelineno-25-60" href="#__codelineno-25-60"></a>
<a id="__codelineno-25-61" name="__codelineno-25-61" href="#__codelineno-25-61"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;app_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-62" name="__codelineno-25-62" href="#__codelineno-25-62"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.count_in</span>
<a id="__codelineno-25-63" name="__codelineno-25-63" href="#__codelineno-25-63"></a><span class="w">  </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w">  </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,[</span><span class="nv">var.name_in</span><span class="p">,</span><span class="w"> </span><span class="nv">terraform.workspace</span><span class="p">,</span><span class="w"> </span><span class="nv">random_string.random[count.index].result</span><span class="p">])</span>
<a id="__codelineno-25-64" name="__codelineno-25-64" href="#__codelineno-25-64"></a><span class="w">  </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image_in</span>
<a id="__codelineno-25-65" name="__codelineno-25-65" href="#__codelineno-25-65"></a><span class="w">  </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-66" name="__codelineno-25-66" href="#__codelineno-25-66"></a><span class="w">    </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port_in</span>
<a id="__codelineno-25-67" name="__codelineno-25-67" href="#__codelineno-25-67"></a><span class="w">    </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port_in[count.index</span><span class="p">]</span>
<a id="__codelineno-25-68" name="__codelineno-25-68" href="#__codelineno-25-68"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-69" name="__codelineno-25-69" href="#__codelineno-25-69"></a><span class="w">  </span><span class="nb">volumes</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-70" name="__codelineno-25-70" href="#__codelineno-25-70"></a><span class="w">    </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.container_path_in</span>
<a id="__codelineno-25-71" name="__codelineno-25-71" href="#__codelineno-25-71"></a><span class="w">    </span><span class="na">volume_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_volume.container_volume[count.index].name</span>
<a id="__codelineno-25-72" name="__codelineno-25-72" href="#__codelineno-25-72"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-73" name="__codelineno-25-73" href="#__codelineno-25-73"></a><span class="p">}</span>
<a id="__codelineno-25-74" name="__codelineno-25-74" href="#__codelineno-25-74"></a>
<a id="__codelineno-25-75" name="__codelineno-25-75" href="#__codelineno-25-75"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_volume&quot;</span><span class="w"> </span><span class="nv">&quot;container_volume&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-76" name="__codelineno-25-76" href="#__codelineno-25-76"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.count_in</span>
<a id="__codelineno-25-77" name="__codelineno-25-77" href="#__codelineno-25-77"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name_in}-${random_string.random[count.index].result}-volume&quot;</span>
<a id="__codelineno-25-78" name="__codelineno-25-78" href="#__codelineno-25-78"></a><span class="w">  </span><span class="nb">lifecycle</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-79" name="__codelineno-25-79" href="#__codelineno-25-79"></a><span class="w">    </span><span class="na">prevent_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-25-80" name="__codelineno-25-80" href="#__codelineno-25-80"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-81" name="__codelineno-25-81" href="#__codelineno-25-81"></a><span class="p">}</span>
<a id="__codelineno-25-82" name="__codelineno-25-82" href="#__codelineno-25-82"></a>
<a id="__codelineno-25-83" name="__codelineno-25-83" href="#__codelineno-25-83"></a><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">console</span>
<a id="__codelineno-25-84" name="__codelineno-25-84" href="#__codelineno-25-84"></a><span class="err">&gt;</span><span class="w"> </span><span class="nv">local.deployment</span>
<a id="__codelineno-25-85" name="__codelineno-25-85" href="#__codelineno-25-85"></a><span class="p">{</span>
<a id="__codelineno-25-86" name="__codelineno-25-86" href="#__codelineno-25-86"></a><span class="w">  </span><span class="s2">&quot;influxdb&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-87" name="__codelineno-25-87" href="#__codelineno-25-87"></a><span class="w">    </span><span class="s2">&quot;image&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;influxdb:latest&quot;</span>
<a id="__codelineno-25-88" name="__codelineno-25-88" href="#__codelineno-25-88"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-89" name="__codelineno-25-89" href="#__codelineno-25-89"></a><span class="w">  </span><span class="s2">&quot;nodered&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-90" name="__codelineno-25-90" href="#__codelineno-25-90"></a><span class="w">    </span><span class="s2">&quot;image&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest&quot;</span>
<a id="__codelineno-25-91" name="__codelineno-25-91" href="#__codelineno-25-91"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-92" name="__codelineno-25-92" href="#__codelineno-25-92"></a><span class="p">}</span>
<a id="__codelineno-25-93" name="__codelineno-25-93" href="#__codelineno-25-93"></a><span class="err">&gt;</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="nv">local.deployment</span><span class="p">)</span>
<a id="__codelineno-25-94" name="__codelineno-25-94" href="#__codelineno-25-94"></a><span class="p">[</span>
<a id="__codelineno-25-95" name="__codelineno-25-95" href="#__codelineno-25-95"></a><span class="w">  </span><span class="s2">&quot;influxdb&quot;</span><span class="p">,</span>
<a id="__codelineno-25-96" name="__codelineno-25-96" href="#__codelineno-25-96"></a><span class="w">  </span><span class="s2">&quot;nodered&quot;</span><span class="p">,</span>
<a id="__codelineno-25-97" name="__codelineno-25-97" href="#__codelineno-25-97"></a><span class="p">]</span>
<a id="__codelineno-25-98" name="__codelineno-25-98" href="#__codelineno-25-98"></a><span class="err">&gt;</span><span class="w"> </span><span class="nf">values</span><span class="p">(</span><span class="nv">local.deployment</span><span class="p">)</span>
<a id="__codelineno-25-99" name="__codelineno-25-99" href="#__codelineno-25-99"></a><span class="p">[</span>
<a id="__codelineno-25-100" name="__codelineno-25-100" href="#__codelineno-25-100"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-25-101" name="__codelineno-25-101" href="#__codelineno-25-101"></a><span class="w">    </span><span class="s2">&quot;image&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;influxdb:latest&quot;</span>
<a id="__codelineno-25-102" name="__codelineno-25-102" href="#__codelineno-25-102"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-25-103" name="__codelineno-25-103" href="#__codelineno-25-103"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-25-104" name="__codelineno-25-104" href="#__codelineno-25-104"></a><span class="w">    </span><span class="s2">&quot;image&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest&quot;</span>
<a id="__codelineno-25-105" name="__codelineno-25-105" href="#__codelineno-25-105"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-25-106" name="__codelineno-25-106" href="#__codelineno-25-106"></a><span class="p">]</span>
<a id="__codelineno-25-107" name="__codelineno-25-107" href="#__codelineno-25-107"></a><span class="err">&gt;</span><span class="w"> </span><span class="nf">values</span><span class="p">(</span><span class="nv">local.deployment</span><span class="p">[</span><span class="s2">&quot;nodered&quot;</span><span class="p">])</span>
<a id="__codelineno-25-108" name="__codelineno-25-108" href="#__codelineno-25-108"></a><span class="p">[</span>
<a id="__codelineno-25-109" name="__codelineno-25-109" href="#__codelineno-25-109"></a><span class="w">  </span><span class="s2">&quot;nodered/node-red:latest&quot;</span><span class="p">,</span>
<a id="__codelineno-25-110" name="__codelineno-25-110" href="#__codelineno-25-110"></a><span class="p">]</span>
</code></pre></div>
<h3 id="61-new-outputs-and-map-transformations">61. New Outputs and Map Transformations<a class="headerlink" href="#61-new-outputs-and-map-transformations" title="Permanent link">&para;</a></h3>
<ul>
<li>Quickly build a map using a for loop</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">console</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="err">&gt;</span><span class="w"> </span><span class="p">{</span><span class="err">for</span><span class="w"> </span><span class="err">x</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;blue&quot;]: x =&gt; &quot;fish&quot;</span><span class="p">}</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="p">{</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">  </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fish&quot;</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">  </span><span class="s2">&quot;2&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fish&quot;</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">  </span><span class="s2">&quot;3&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fish&quot;</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">  </span><span class="s2">&quot;blue&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fish&quot;</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="p">}</span>
</code></pre></div>
<ul>
<li>Used to build structured maps for module output</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># --- container/outputs.tf ---</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;application_access&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="err">for</span><span class="w"> </span><span class="err">x</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">docker_container.app_container</span><span class="p">[</span><span class="err">*</span><span class="p">]:</span><span class="w"> </span><span class="nv">x.name</span><span class="w"> </span><span class="p">=</span><span class="err">&gt;</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;:&quot;, [x.network_data[0].ip_address], x.ports[*][&quot;external&quot;</span><span class="p">])}</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="p">}</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="c1">##For loop technically not necessary as the outputs aren&#39;t being manipulated. Can just use module.container for simplicity</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;application_access&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">x</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">module.container</span><span class="p">[</span><span class="err">*</span><span class="p">]:</span><span class="w"> </span><span class="err">x</span><span class="p">]</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The name and socket for each application.&quot;</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="p">}</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="err">Apply</span><span class="w"> </span><span class="err">complete</span><span class="p">!</span><span class="w"> </span><span class="err">Resources</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="err">added</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="err">changed</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="err">destroyed</span><span class="p">.</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="err">Outputs</span><span class="p">:</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="na">application_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="w">    </span><span class="s2">&quot;influxdb&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w">      </span><span class="s2">&quot;application_access&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w">        </span><span class="s2">&quot;influxdb-dev-7tuy&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;172.17.0.3:8186&quot;</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">        </span><span class="s2">&quot;influxdb-dev-s70o&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;172.17.0.4:8187&quot;</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">    </span><span class="s2">&quot;nodered&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="w">      </span><span class="s2">&quot;application_access&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">        </span><span class="s2">&quot;nodered-dev-bz3i&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;172.17.0.2:1980&quot;</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="p">]</span>
</code></pre></div>
<h3 id="62-grafana-apply-yourself">62. Grafana apply yourself<a class="headerlink" href="#62-grafana-apply-yourself" title="Permanent link">&para;</a></h3>
<p><a href="https://grafana.com/docs/grafana/latest/installation/docker">https://grafana.com/docs/grafana/latest/installation/docker</a></p>
<h3 id="64-self-referencing-and-provisioner-failure-modes">64. Self Referencing and Provisioner Failure Modes<a class="headerlink" href="#64-self-referencing-and-provisioner-failure-modes" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/resources/provisioners/syntax#the-self-object">https://developer.hashicorp.com/terraform/language/resources/provisioners/syntax#the-self-object</a></p>
<ul>
<li>Allows the provisioner to reference the parent resource's attributes</li>
<li>Example of backing up docker volume before deletion</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_volume&quot;</span><span class="w"> </span><span class="nv">&quot;container_volume&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.count_in</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name_in}-${random_string.random[count.index].result}-volume&quot;</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">  </span><span class="nb">lifecycle</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="na">prevent_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;remote-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="na">when</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">destroy</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">    </span><span class="na">on_failure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">continue</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">    </span><span class="nb">connection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">      </span><span class="na">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x.x.x.x&quot;</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">      </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh&quot;</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">      </span><span class="na">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">      </span><span class="na">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${file(&quot;../../id_rsa&quot;)}&quot;</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">    </span><span class="na">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">      </span><span class="s2">&quot;mkdir /home/ubuntu/environment/backup/&quot;</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;remote-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">    </span><span class="na">when</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">destroy</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">    </span><span class="na">on_failure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">fail</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">    </span><span class="nb">connection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">      </span><span class="na">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x.x.x.x&quot;</span>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">      </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh&quot;</span>
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">      </span><span class="na">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">      </span><span class="na">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${file(&quot;../../id_rsa&quot;)}&quot;</span>
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="w">    </span><span class="na">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="w">      </span><span class="s2">&quot;sudo tar -czvf /home/ubuntu/environment/backup/${self.name}.tar.gz ${self.mountpoint}/&quot;</span>
<a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="p">}</span>
</code></pre></div>
<h3 id="65-terraform-apply-yourself-self-referencing">65. Terraform apply yourself - self referencing<a class="headerlink" href="#65-terraform-apply-yourself-self-referencing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;app_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.count_in</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">  </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w">  </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,[</span><span class="nv">var.name_in</span><span class="p">,</span><span class="w"> </span><span class="nv">terraform.workspace</span><span class="p">,</span><span class="w"> </span><span class="nv">random_string.random[count.index].result</span><span class="p">])</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">  </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image_in</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">  </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">    </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port_in</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">    </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port_in[count.index</span><span class="p">]</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">  </span><span class="nb">volumes</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">    </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.container_path_in</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">    </span><span class="na">volume_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_volume.container_volume[count.index].name</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">  </span><span class="err">provisioner</span><span class="w"> </span><span class="nb">remote-exec</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">    </span><span class="nb">connection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="w">      </span><span class="na">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x.x.x.x&quot;</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="w">      </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh&quot;</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="w">      </span><span class="na">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="w">      </span><span class="na">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${file(&quot;../../id_rsa&quot;)}&quot;</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="w">    </span><span class="na">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="w">      </span><span class="s2">&quot;echo ${self.name}: ${self.network_data[0].ip_address}:${join(&quot;&quot;, [for x in self.ports[*][&quot;external&quot;]: x])} &gt;&gt; /home/ubuntu/environment/containers.txt&quot;</span>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;remote-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="w">    </span><span class="na">when</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">destroy</span>
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="w">    </span><span class="na">on_failure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">continue</span>
<a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="w">    </span><span class="nb">connection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="w">      </span><span class="na">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x.x.x.x&quot;</span>
<a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a><span class="w">      </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh&quot;</span>
<a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a><span class="w">      </span><span class="na">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a><span class="w">      </span><span class="na">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${file(&quot;../../id_rsa&quot;)}&quot;</span>
<a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a><span class="w">    </span><span class="na">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a><span class="w">      </span><span class="s2">&quot;rm -f /home/ubuntu/environment/containers.txt&quot;</span>
<a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a><span class="p">}</span>
</code></pre></div>
<h3 id="66-dynamic-blocks">66. Dynamic Blocks<a class="headerlink" href="#66-dynamic-blocks" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks">https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks</a></p>
<ul>
<li>Allows you to create repeatable nested blocks within a resource using for_each</li>
<li>Overuse can make configuration hard to read and maintain</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1"># --- root/locals.tf ---</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">  </span><span class="nb">deployment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">    </span><span class="nb">grafana</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">      </span><span class="na">container_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;grafana&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">])</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">      </span><span class="na">image</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image</span><span class="p">[</span><span class="s2">&quot;grafana&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">      </span><span class="na">int</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">      </span><span class="na">ext</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;grafana&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">      </span><span class="na">volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="na">container_path_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/var/lib/grafana&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="na">container_path_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/etc/grafana&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">      </span><span class="p">]</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="p">}</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w">  </span><span class="na">source</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./container&quot;</span>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">  </span><span class="na">for_each</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">local.deployment</span>
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">  </span><span class="na">count_in</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.container_count</span>
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">  </span><span class="na">name_in</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span>
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w">  </span><span class="na">image_in</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">module.image[each.key].image_out</span>
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w">  </span><span class="na">int_port_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.int</span>
<a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="w">  </span><span class="na">ext_port_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.ext</span>
<a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a><span class="w">  </span><span class="na">volumes_in</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.volumes</span>
<a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="p">}</span>
<a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a>
<a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="c1"># --- container/main.tf ---</span>
<a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a>
<a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;app_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.count_in</span>
<a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a><span class="w">  </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">var.name_in</span><span class="p">,</span><span class="w"> </span><span class="nv">terraform.workspace</span><span class="p">,</span><span class="w"> </span><span class="nv">random_string.random[count.index].result</span><span class="p">])</span>
<a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a><span class="w">  </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image_in</span>
<a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a><span class="w">  </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a><span class="w">    </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port_in</span>
<a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a><span class="w">    </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port_in[count.index</span><span class="p">]</span>
<a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a><span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">&quot;volumes&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a><span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.volumes_in</span>
<a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a><span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-44" name="__codelineno-30-44" href="#__codelineno-30-44"></a><span class="w">      </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">volumes.value</span><span class="p">[</span><span class="s2">&quot;container_path_each&quot;</span><span class="p">]</span>
<a id="__codelineno-30-45" name="__codelineno-30-45" href="#__codelineno-30-45"></a><span class="w">      </span><span class="na">volume_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_volume.container_volume[volumes.key].name</span>
<a id="__codelineno-30-46" name="__codelineno-30-46" href="#__codelineno-30-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-47" name="__codelineno-30-47" href="#__codelineno-30-47"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-30-48" name="__codelineno-30-48" href="#__codelineno-30-48"></a><span class="p">}</span>
<a id="__codelineno-30-49" name="__codelineno-30-49" href="#__codelineno-30-49"></a>
<a id="__codelineno-30-50" name="__codelineno-30-50" href="#__codelineno-30-50"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_volume&quot;</span><span class="w"> </span><span class="nv">&quot;container_volume&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-51" name="__codelineno-30-51" href="#__codelineno-30-51"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.volumes_in</span><span class="p">)</span>
<a id="__codelineno-30-52" name="__codelineno-30-52" href="#__codelineno-30-52"></a><span class="w">  </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name_in}-${count.index}-volume&quot;</span>
<a id="__codelineno-30-53" name="__codelineno-30-53" href="#__codelineno-30-53"></a><span class="w">  </span><span class="nb">lifecycle</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-54" name="__codelineno-30-54" href="#__codelineno-30-54"></a><span class="w">    </span><span class="na">prevent_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-30-55" name="__codelineno-30-55" href="#__codelineno-30-55"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-30-56" name="__codelineno-30-56" href="#__codelineno-30-56"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>$<span class="w"> </span>docker<span class="w"> </span>inspect<span class="w"> </span><span class="k">$(</span>docker<span class="w"> </span>ps<span class="w"> </span>-a<span class="w"> </span>-q<span class="k">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>volume
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w"> </span><span class="s2">&quot;grafana-1-volume:/etc/grafana:rw&quot;</span>,
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w"> </span><span class="s2">&quot;grafana-0-volume:/var/lib/grafana:rw&quot;</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w"> </span><span class="s2">&quot;Type&quot;</span>:<span class="w"> </span><span class="s2">&quot;volume&quot;</span>,
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w"> </span><span class="s2">&quot;Name&quot;</span>:<span class="w"> </span><span class="s2">&quot;grafana-1-volume&quot;</span>,
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w"> </span><span class="s2">&quot;Source&quot;</span>:<span class="w"> </span><span class="s2">&quot;/var/lib/docker/volumes/grafana-1-volume/_data&quot;</span>,
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w"> </span><span class="s2">&quot;Type&quot;</span>:<span class="w"> </span><span class="s2">&quot;volume&quot;</span>,
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w"> </span><span class="s2">&quot;Name&quot;</span>:<span class="w"> </span><span class="s2">&quot;grafana-0-volume&quot;</span>,
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w"> </span><span class="s2">&quot;Source&quot;</span>:<span class="w"> </span><span class="s2">&quot;/var/lib/docker/volumes/grafana-0-volume/_data&quot;</span>,
</code></pre></div>
<h3 id="67-nesting-the-volume-module">67. Nesting the Volume module<a class="headerlink" href="#67-nesting-the-volume-module" title="Permanent link">&para;</a></h3>
<ul>
<li>When there are multiple containers (multiple external ports), a volume module will allow the correct number of modules to be created ()</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1"># --- root/locals.tf ---</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">  </span><span class="nb">deployment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span><span class="nb">nodered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">      </span><span class="na">container_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;nodered&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">])</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">      </span><span class="na">image</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image</span><span class="p">[</span><span class="s2">&quot;nodered&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">      </span><span class="na">int</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">      </span><span class="na">ext</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;nodered&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">      </span><span class="na">container_path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/data&quot;</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">      </span><span class="na">volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="na">container_path_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/data&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">      </span><span class="p">]</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">    </span><span class="nb">influxdb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">      </span><span class="na">container_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;influxdb&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">])</span>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="w">      </span><span class="na">image</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image</span><span class="p">[</span><span class="s2">&quot;influxdb&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="w">      </span><span class="na">int</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">8086</span>
<a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">      </span><span class="na">ext</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;influxdb&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">      </span><span class="na">container_path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/var/lib/influxdb&quot;</span>
<a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="w">      </span><span class="na">volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="na">container_path_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/var/lib/influxdb&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="w">      </span><span class="p">]</span>
<a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="w">    </span><span class="nb">grafana</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="w">      </span><span class="na">container_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;grafana&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">])</span>
<a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="w">      </span><span class="na">image</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image</span><span class="p">[</span><span class="s2">&quot;grafana&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a><span class="w">      </span><span class="na">int</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span>
<a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a><span class="w">      </span><span class="na">ext</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port</span><span class="p">[</span><span class="s2">&quot;grafana&quot;</span><span class="p">][</span><span class="nv">terraform.workspace</span><span class="p">]</span>
<a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a><span class="w">      </span><span class="na">volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="na">container_path_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/var/lib/grafana&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="na">container_path_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/etc/grafana&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a><span class="w">      </span><span class="p">]</span>
<a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-36" name="__codelineno-32-36" href="#__codelineno-32-36"></a><span class="p">}</span>
<a id="__codelineno-32-37" name="__codelineno-32-37" href="#__codelineno-32-37"></a>
<a id="__codelineno-32-38" name="__codelineno-32-38" href="#__codelineno-32-38"></a><span class="c1"># --- root/variables.tf ---</span>
<a id="__codelineno-32-39" name="__codelineno-32-39" href="#__codelineno-32-39"></a>
<a id="__codelineno-32-40" name="__codelineno-32-40" href="#__codelineno-32-40"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;int_port&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-41" name="__codelineno-32-41" href="#__codelineno-32-41"></a><span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">number</span>
<a id="__codelineno-32-42" name="__codelineno-32-42" href="#__codelineno-32-42"></a><span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-32-43" name="__codelineno-32-43" href="#__codelineno-32-43"></a>
<a id="__codelineno-32-44" name="__codelineno-32-44" href="#__codelineno-32-44"></a><span class="w">  </span><span class="nb">validation</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-45" name="__codelineno-32-45" href="#__codelineno-32-45"></a><span class="w">    </span><span class="na">condition</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-32-46" name="__codelineno-32-46" href="#__codelineno-32-46"></a><span class="w">    </span><span class="na">error_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The internal port must be 1880&quot;</span>
<a id="__codelineno-32-47" name="__codelineno-32-47" href="#__codelineno-32-47"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-48" name="__codelineno-32-48" href="#__codelineno-32-48"></a><span class="p">}</span>
<a id="__codelineno-32-49" name="__codelineno-32-49" href="#__codelineno-32-49"></a>
<a id="__codelineno-32-50" name="__codelineno-32-50" href="#__codelineno-32-50"></a><span class="c1"># --- root/terraform.tfvars ---</span>
<a id="__codelineno-32-51" name="__codelineno-32-51" href="#__codelineno-32-51"></a>
<a id="__codelineno-32-52" name="__codelineno-32-52" href="#__codelineno-32-52"></a><span class="nb">ext_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-53" name="__codelineno-32-53" href="#__codelineno-32-53"></a><span class="w">  </span><span class="nb">nodered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-54" name="__codelineno-32-54" href="#__codelineno-32-54"></a><span class="w">    </span><span class="na">dev</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">1980</span><span class="p">]</span>
<a id="__codelineno-32-55" name="__codelineno-32-55" href="#__codelineno-32-55"></a><span class="w">    </span><span class="na">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">1880</span><span class="p">]</span>
<a id="__codelineno-32-56" name="__codelineno-32-56" href="#__codelineno-32-56"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-57" name="__codelineno-32-57" href="#__codelineno-32-57"></a><span class="w">  </span><span class="nb">influxdb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-58" name="__codelineno-32-58" href="#__codelineno-32-58"></a><span class="w">    </span><span class="na">dev</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">8186</span><span class="p">]</span>
<a id="__codelineno-32-59" name="__codelineno-32-59" href="#__codelineno-32-59"></a><span class="w">    </span><span class="na">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">8086</span><span class="p">]</span>
<a id="__codelineno-32-60" name="__codelineno-32-60" href="#__codelineno-32-60"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-61" name="__codelineno-32-61" href="#__codelineno-32-61"></a><span class="w">  </span><span class="nb">grafana</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-62" name="__codelineno-32-62" href="#__codelineno-32-62"></a><span class="w">    </span><span class="na">dev</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">3100</span><span class="p">,</span><span class="w"> </span><span class="m">3101</span><span class="p">]</span>
<a id="__codelineno-32-63" name="__codelineno-32-63" href="#__codelineno-32-63"></a><span class="w">    </span><span class="na">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">3000</span><span class="p">]</span>
<a id="__codelineno-32-64" name="__codelineno-32-64" href="#__codelineno-32-64"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-65" name="__codelineno-32-65" href="#__codelineno-32-65"></a><span class="p">}</span><span class="c1"> </span>
<a id="__codelineno-32-66" name="__codelineno-32-66" href="#__codelineno-32-66"></a>
<a id="__codelineno-32-67" name="__codelineno-32-67" href="#__codelineno-32-67"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-32-68" name="__codelineno-32-68" href="#__codelineno-32-68"></a>
<a id="__codelineno-32-69" name="__codelineno-32-69" href="#__codelineno-32-69"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-70" name="__codelineno-32-70" href="#__codelineno-32-70"></a><span class="w">  </span><span class="na">source</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./container&quot;</span>
<a id="__codelineno-32-71" name="__codelineno-32-71" href="#__codelineno-32-71"></a><span class="w">  </span><span class="na">for_each</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">local.deployment</span>
<a id="__codelineno-32-72" name="__codelineno-32-72" href="#__codelineno-32-72"></a><span class="w">  </span><span class="na">count_in</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.container_count</span>
<a id="__codelineno-32-73" name="__codelineno-32-73" href="#__codelineno-32-73"></a><span class="w">  </span><span class="na">name_in</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span>
<a id="__codelineno-32-74" name="__codelineno-32-74" href="#__codelineno-32-74"></a><span class="w">  </span><span class="na">image_in</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">module.image[each.key].image_out</span>
<a id="__codelineno-32-75" name="__codelineno-32-75" href="#__codelineno-32-75"></a><span class="w">  </span><span class="na">int_port_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.int</span>
<a id="__codelineno-32-76" name="__codelineno-32-76" href="#__codelineno-32-76"></a><span class="w">  </span><span class="na">ext_port_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.ext</span>
<a id="__codelineno-32-77" name="__codelineno-32-77" href="#__codelineno-32-77"></a><span class="w">  </span><span class="na">volumes_in</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.volumes</span>
<a id="__codelineno-32-78" name="__codelineno-32-78" href="#__codelineno-32-78"></a><span class="p">}</span>
<a id="__codelineno-32-79" name="__codelineno-32-79" href="#__codelineno-32-79"></a>
<a id="__codelineno-32-80" name="__codelineno-32-80" href="#__codelineno-32-80"></a><span class="c1"># --- root/outputs.tf ---</span>
<a id="__codelineno-32-81" name="__codelineno-32-81" href="#__codelineno-32-81"></a>
<a id="__codelineno-32-82" name="__codelineno-32-82" href="#__codelineno-32-82"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;application_access&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-83" name="__codelineno-32-83" href="#__codelineno-32-83"></a><span class="w">  </span><span class="na">value</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">x</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">module.container</span><span class="p">[</span><span class="err">*</span><span class="p">]</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">x</span><span class="p">]</span>
<a id="__codelineno-32-84" name="__codelineno-32-84" href="#__codelineno-32-84"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The name and socket for each application.&quot;</span>
<a id="__codelineno-32-85" name="__codelineno-32-85" href="#__codelineno-32-85"></a><span class="p">}</span>
<a id="__codelineno-32-86" name="__codelineno-32-86" href="#__codelineno-32-86"></a>
<a id="__codelineno-32-87" name="__codelineno-32-87" href="#__codelineno-32-87"></a><span class="c1"># --- container/variables.tf ---</span>
<a id="__codelineno-32-88" name="__codelineno-32-88" href="#__codelineno-32-88"></a>
<a id="__codelineno-32-89" name="__codelineno-32-89" href="#__codelineno-32-89"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;name_in&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-32-90" name="__codelineno-32-90" href="#__codelineno-32-90"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;image_in&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-32-91" name="__codelineno-32-91" href="#__codelineno-32-91"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;int_port_in&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-32-92" name="__codelineno-32-92" href="#__codelineno-32-92"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;ext_port_in&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-32-93" name="__codelineno-32-93" href="#__codelineno-32-93"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;count_in&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-32-94" name="__codelineno-32-94" href="#__codelineno-32-94"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;volumes_in&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-32-95" name="__codelineno-32-95" href="#__codelineno-32-95"></a>
<a id="__codelineno-32-96" name="__codelineno-32-96" href="#__codelineno-32-96"></a><span class="c1"># --- container/main.tf ---</span>
<a id="__codelineno-32-97" name="__codelineno-32-97" href="#__codelineno-32-97"></a>
<a id="__codelineno-32-98" name="__codelineno-32-98" href="#__codelineno-32-98"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_container&quot;</span><span class="w"> </span><span class="nv">&quot;app_container&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-99" name="__codelineno-32-99" href="#__codelineno-32-99"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.count_in</span>
<a id="__codelineno-32-100" name="__codelineno-32-100" href="#__codelineno-32-100"></a><span class="w">  </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">var.name_in</span><span class="p">,</span><span class="w"> </span><span class="nv">terraform.workspace</span><span class="p">,</span><span class="w"> </span><span class="nv">random_string.random[count.index].result</span><span class="p">])</span>
<a id="__codelineno-32-101" name="__codelineno-32-101" href="#__codelineno-32-101"></a><span class="w">  </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.image_in</span>
<a id="__codelineno-32-102" name="__codelineno-32-102" href="#__codelineno-32-102"></a><span class="w">  </span><span class="nb">ports</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-103" name="__codelineno-32-103" href="#__codelineno-32-103"></a><span class="w">    </span><span class="na">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.int_port_in</span>
<a id="__codelineno-32-104" name="__codelineno-32-104" href="#__codelineno-32-104"></a><span class="w">    </span><span class="na">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.ext_port_in[count.index</span><span class="p">]</span>
<a id="__codelineno-32-105" name="__codelineno-32-105" href="#__codelineno-32-105"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-106" name="__codelineno-32-106" href="#__codelineno-32-106"></a><span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">&quot;volumes&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-107" name="__codelineno-32-107" href="#__codelineno-32-107"></a><span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.volumes_in</span>
<a id="__codelineno-32-108" name="__codelineno-32-108" href="#__codelineno-32-108"></a><span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-109" name="__codelineno-32-109" href="#__codelineno-32-109"></a><span class="w">      </span><span class="na">container_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">volumes.value</span><span class="p">[</span><span class="s2">&quot;container_path_each&quot;</span><span class="p">]</span>
<a id="__codelineno-32-110" name="__codelineno-32-110" href="#__codelineno-32-110"></a><span class="w">      </span><span class="na">volume_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">module.volume[count.index].volume_output[volumes.key</span><span class="p">]</span>
<a id="__codelineno-32-111" name="__codelineno-32-111" href="#__codelineno-32-111"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-112" name="__codelineno-32-112" href="#__codelineno-32-112"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-113" name="__codelineno-32-113" href="#__codelineno-32-113"></a>
<a id="__codelineno-32-114" name="__codelineno-32-114" href="#__codelineno-32-114"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;volume&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-115" name="__codelineno-32-115" href="#__codelineno-32-115"></a><span class="w">  </span><span class="na">source</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./volume&quot;</span>
<a id="__codelineno-32-116" name="__codelineno-32-116" href="#__codelineno-32-116"></a><span class="w">  </span><span class="na">count</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">var.count_in</span>
<a id="__codelineno-32-117" name="__codelineno-32-117" href="#__codelineno-32-117"></a><span class="w">  </span><span class="na">volume_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.volumes_in</span><span class="p">)</span>
<a id="__codelineno-32-118" name="__codelineno-32-118" href="#__codelineno-32-118"></a><span class="w">  </span><span class="na">volume_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.name_in}-${terraform.workspace}-${random_string.random[count.index].result}-volume&quot;</span>
<a id="__codelineno-32-119" name="__codelineno-32-119" href="#__codelineno-32-119"></a><span class="p">}</span>
<a id="__codelineno-32-120" name="__codelineno-32-120" href="#__codelineno-32-120"></a>
<a id="__codelineno-32-121" name="__codelineno-32-121" href="#__codelineno-32-121"></a><span class="c1"># --- container/outputs.tf ---</span>
<a id="__codelineno-32-122" name="__codelineno-32-122" href="#__codelineno-32-122"></a>
<a id="__codelineno-32-123" name="__codelineno-32-123" href="#__codelineno-32-123"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;application_access&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-124" name="__codelineno-32-124" href="#__codelineno-32-124"></a><span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">x</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">docker_container.app_container</span><span class="p">[</span><span class="err">*</span><span class="p">]</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nv">x.name</span><span class="w"> </span><span class="p">=</span><span class="err">&gt;</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="s2">&quot;:&quot;, [x.network_data[0].ip_address], x.ports[*][&quot;external&quot;</span><span class="p">])</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-32-125" name="__codelineno-32-125" href="#__codelineno-32-125"></a><span class="p">}</span>
<a id="__codelineno-32-126" name="__codelineno-32-126" href="#__codelineno-32-126"></a>
<a id="__codelineno-32-127" name="__codelineno-32-127" href="#__codelineno-32-127"></a><span class="c1"># --- container/volume/variables.tf ---</span>
<a id="__codelineno-32-128" name="__codelineno-32-128" href="#__codelineno-32-128"></a>
<a id="__codelineno-32-129" name="__codelineno-32-129" href="#__codelineno-32-129"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;volume_count&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-32-130" name="__codelineno-32-130" href="#__codelineno-32-130"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;volume_name&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-32-131" name="__codelineno-32-131" href="#__codelineno-32-131"></a>
<a id="__codelineno-32-132" name="__codelineno-32-132" href="#__codelineno-32-132"></a><span class="c1"># --- container/volume/main.tf ---</span>
<a id="__codelineno-32-133" name="__codelineno-32-133" href="#__codelineno-32-133"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;docker_volume&quot;</span><span class="w"> </span><span class="nv">&quot;container_volume&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-134" name="__codelineno-32-134" href="#__codelineno-32-134"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.volume_count</span>
<a id="__codelineno-32-135" name="__codelineno-32-135" href="#__codelineno-32-135"></a><span class="w">  </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.volume_name}-${count.index}&quot;</span>
<a id="__codelineno-32-136" name="__codelineno-32-136" href="#__codelineno-32-136"></a><span class="w">  </span><span class="nb">lifecycle</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-137" name="__codelineno-32-137" href="#__codelineno-32-137"></a><span class="w">    </span><span class="na">prevent_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-32-138" name="__codelineno-32-138" href="#__codelineno-32-138"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-139" name="__codelineno-32-139" href="#__codelineno-32-139"></a><span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;remote-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-140" name="__codelineno-32-140" href="#__codelineno-32-140"></a><span class="w">    </span><span class="na">when</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="err">destroy</span>
<a id="__codelineno-32-141" name="__codelineno-32-141" href="#__codelineno-32-141"></a><span class="w">    </span><span class="na">on_failure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">continue</span>
<a id="__codelineno-32-142" name="__codelineno-32-142" href="#__codelineno-32-142"></a><span class="w">    </span><span class="nb">connection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-143" name="__codelineno-32-143" href="#__codelineno-32-143"></a><span class="w">      </span><span class="na">host</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x.x.x.x&quot;</span>
<a id="__codelineno-32-144" name="__codelineno-32-144" href="#__codelineno-32-144"></a><span class="w">      </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh&quot;</span>
<a id="__codelineno-32-145" name="__codelineno-32-145" href="#__codelineno-32-145"></a><span class="w">      </span><span class="na">user</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<a id="__codelineno-32-146" name="__codelineno-32-146" href="#__codelineno-32-146"></a><span class="w">      </span><span class="na">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">file</span><span class="p">(</span><span class="s2">&quot;../../id_rsa&quot;</span><span class="p">)</span>
<a id="__codelineno-32-147" name="__codelineno-32-147" href="#__codelineno-32-147"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-148" name="__codelineno-32-148" href="#__codelineno-32-148"></a><span class="w">    </span><span class="na">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-32-149" name="__codelineno-32-149" href="#__codelineno-32-149"></a><span class="w">      </span><span class="s2">&quot;mkdir /home/ubuntu/environment/backup/&quot;</span>
<a id="__codelineno-32-150" name="__codelineno-32-150" href="#__codelineno-32-150"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-32-151" name="__codelineno-32-151" href="#__codelineno-32-151"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-152" name="__codelineno-32-152" href="#__codelineno-32-152"></a><span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;remote-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-153" name="__codelineno-32-153" href="#__codelineno-32-153"></a><span class="w">    </span><span class="na">when</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="err">destroy</span>
<a id="__codelineno-32-154" name="__codelineno-32-154" href="#__codelineno-32-154"></a><span class="w">    </span><span class="na">on_failure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">fail</span>
<a id="__codelineno-32-155" name="__codelineno-32-155" href="#__codelineno-32-155"></a><span class="w">    </span><span class="nb">connection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-156" name="__codelineno-32-156" href="#__codelineno-32-156"></a><span class="w">      </span><span class="na">host</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x.x.x.x&quot;</span>
<a id="__codelineno-32-157" name="__codelineno-32-157" href="#__codelineno-32-157"></a><span class="w">      </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh&quot;</span>
<a id="__codelineno-32-158" name="__codelineno-32-158" href="#__codelineno-32-158"></a><span class="w">      </span><span class="na">user</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<a id="__codelineno-32-159" name="__codelineno-32-159" href="#__codelineno-32-159"></a><span class="w">      </span><span class="na">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">file</span><span class="p">(</span><span class="s2">&quot;../../id_rsa&quot;</span><span class="p">)</span>
<a id="__codelineno-32-160" name="__codelineno-32-160" href="#__codelineno-32-160"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-161" name="__codelineno-32-161" href="#__codelineno-32-161"></a><span class="w">    </span><span class="na">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-32-162" name="__codelineno-32-162" href="#__codelineno-32-162"></a><span class="w">      </span><span class="s2">&quot;sudo tar -czvf /home/ubuntu/environment/backup/${self.name}.tar.gz ${self.mountpoint}/&quot;</span>
<a id="__codelineno-32-163" name="__codelineno-32-163" href="#__codelineno-32-163"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-32-164" name="__codelineno-32-164" href="#__codelineno-32-164"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-32-165" name="__codelineno-32-165" href="#__codelineno-32-165"></a><span class="p">}</span>
<a id="__codelineno-32-166" name="__codelineno-32-166" href="#__codelineno-32-166"></a>
<a id="__codelineno-32-167" name="__codelineno-32-167" href="#__codelineno-32-167"></a><span class="c1">#container/volume/outputs.tf</span>
<a id="__codelineno-32-168" name="__codelineno-32-168" href="#__codelineno-32-168"></a>
<a id="__codelineno-32-169" name="__codelineno-32-169" href="#__codelineno-32-169"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;volume_output&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-170" name="__codelineno-32-170" href="#__codelineno-32-170"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">docker_volume.container_volume</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">name</span>
<a id="__codelineno-32-171" name="__codelineno-32-171" href="#__codelineno-32-171"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>tree<span class="w"> </span>/var/lib/docker/volumes
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>/var/lib/docker/volumes
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>├──<span class="w"> </span>1d3f5154b76b183837c385fe30b34060eb6aff9e75560ac4c84631112c650904
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>│<span class="w">   </span>└──<span class="w"> </span>_data
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>├──<span class="w"> </span>backingFsBlockDev
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>├──<span class="w"> </span>be650d694e83103874d9e889bd697080216be219f4a15b0c6bbf93619391def3
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>│<span class="w">   </span>└──<span class="w"> </span>_data
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>├──<span class="w"> </span>grafana-dev-qt6e-volume-0
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>│<span class="w">   </span>└──<span class="w"> </span>_data
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>│<span class="w">       </span>├──<span class="w"> </span>alerting
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>│<span class="w">       </span>│<span class="w">   </span>└──<span class="w"> </span><span class="m">1</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>│<span class="w">       </span>│<span class="w">       </span>└──<span class="w"> </span>__default__.tmpl
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>│<span class="w">       </span>├──<span class="w"> </span>csv
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>│<span class="w">       </span>├──<span class="w"> </span>grafana.db
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>│<span class="w">       </span>├──<span class="w"> </span>plugins
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>│<span class="w">       </span>└──<span class="w"> </span>png
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>├──<span class="w"> </span>grafana-dev-qt6e-volume-1
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>│<span class="w">   </span>└──<span class="w"> </span>_data
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>│<span class="w">       </span>├──<span class="w"> </span>grafana.ini
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>│<span class="w">       </span>├──<span class="w"> </span>ldap.toml
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a>│<span class="w">       </span>└──<span class="w"> </span>provisioning
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>│<span class="w">           </span>├──<span class="w"> </span>access-control
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>│<span class="w">           </span>├──<span class="w"> </span>alerting
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>│<span class="w">           </span>├──<span class="w"> </span>dashboards
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a>│<span class="w">           </span>├──<span class="w"> </span>datasources
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>│<span class="w">           </span>├──<span class="w"> </span>notifiers
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a>│<span class="w">           </span>└──<span class="w"> </span>plugins
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a>├──<span class="w"> </span>grafana-dev-zo9d-volume-0
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a>│<span class="w">   </span>└──<span class="w"> </span>_data
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a>│<span class="w">       </span>├──<span class="w"> </span>alerting
<a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a>│<span class="w">       </span>│<span class="w">   </span>└──<span class="w"> </span><span class="m">1</span>
<a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a>│<span class="w">       </span>│<span class="w">       </span>└──<span class="w"> </span>__default__.tmpl
<a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a>│<span class="w">       </span>├──<span class="w"> </span>csv
<a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a>│<span class="w">       </span>├──<span class="w"> </span>grafana.db
<a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a>│<span class="w">       </span>├──<span class="w"> </span>plugins
<a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a>│<span class="w">       </span>└──<span class="w"> </span>png
<a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a>├──<span class="w"> </span>grafana-dev-zo9d-volume-1
<a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a>│<span class="w">   </span>└──<span class="w"> </span>_data
<a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a>│<span class="w">       </span>├──<span class="w"> </span>grafana.ini
<a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a>│<span class="w">       </span>├──<span class="w"> </span>ldap.toml
<a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a>│<span class="w">       </span>└──<span class="w"> </span>provisioning
<a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a>│<span class="w">           </span>├──<span class="w"> </span>access-control
<a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a>│<span class="w">           </span>├──<span class="w"> </span>alerting
<a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a>│<span class="w">           </span>├──<span class="w"> </span>dashboards
<a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a>│<span class="w">           </span>├──<span class="w"> </span>datasources
<a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a>│<span class="w">           </span>├──<span class="w"> </span>notifiers
<a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a>│<span class="w">           </span>└──<span class="w"> </span>plugins
<a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a>└──<span class="w"> </span>metadata.db
<a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a>
<a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a><span class="m">36</span><span class="w"> </span>directories,<span class="w"> </span><span class="m">10</span><span class="w"> </span>files
</code></pre></div>
<h3 id="68-weatherboard-dashboard-project">68. Weatherboard Dashboard Project<a class="headerlink" href="#68-weatherboard-dashboard-project" title="Permanent link">&para;</a></h3>
<ul>
<li>Build weather monitoring app to monitor weather for rocket launches in Houston and Kennedy Space Center</li>
<li>
<p>Use nodered to pull from the openweather map api, insert the data into influxdb, and then use grafana to graph the data</p>
</li>
<li>
<p>Signup and get API key from openweathermap.org</p>
</li>
<li>Setup default bucket in influxdb called "weather". Copy API key.</li>
<li>Use nodered template found in resources. Add API key for http request to openweathermap.org, add influxdb API key and bucket name</li>
<li>Add influxdb as a data source in grafana and import the dashboard found in resources</li>
</ul>
<h2 id="section-4-deploy-aws-resources-with-terraform">Section 4: Deploy AWS Resources with Terraform<a class="headerlink" href="#section-4-deploy-aws-resources-with-terraform" title="Permanent link">&para;</a></h2>
<h3 id="69-what-were-going-to-build">69. What we're going to build<a class="headerlink" href="#69-what-were-going-to-build" title="Permanent link">&para;</a></h3>
<p><img alt="AWS VPC" src="../../assets/images/terraform/image-2.png" /></p>
<ul>
<li>Standard 3 tier app with a K3 control plane and worker node using free tier (T2 micro for K3s)</li>
<li>K3s doesn't use etcd but instead can use MySQL or PostgreSQL (Amazon RDS)</li>
<li>Use provisioners to copy kubeconfig settings files from control plane to the Cloud9 control node. This will allow k8s commands to be run from the node to the cluster automatically using terraform.</li>
</ul>
<h3 id="70a-configuring-terraform-cloud">70a. Configuring Terraform Cloud<a class="headerlink" href="#70a-configuring-terraform-cloud" title="Permanent link">&para;</a></h3>
<ul>
<li>CLI driven workflow = Terraform workflow commands are run remotely via CLI (see execution modes below)</li>
<li>API driven workflow = Use TFC APIs to initiate workflow</li>
<li>Git driven workflow = changes in git trigger workflow</li>
<li>Execution modes for a workspace:</li>
<li>Remote (default) = Plan and apply occur on TFC infrastructure and reviews are done in the GUI</li>
<li>Local = Plan and apply occur locally and TFC is only used for state synchronisation</li>
<li>After specifying terraform cloud org and workspace in backends.tf use <code>terraform login</code> to request an API token to allow local TF to use TFC as state backend</li>
</ul>
<h3 id="70b-using-dev-container-ubuntu-to-deploy-to-aws-with-tfc-backend">70b. Using Dev Container (Ubuntu) to deploy to AWS with TFC backend<a class="headerlink" href="#70b-using-dev-container-ubuntu-to-deploy-to-aws-with-tfc-backend" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://www.reddit.com/r/Terraform/comments/tkkn04/best_authentication_method_for_aws/">Assuming roles using terraform (Reddit)</a></li>
<li><a href="https://www.reddit.com/r/Terraform/comments/x0o3av/authenticating_to_aws_provider/">Authenticating to AWS Provider with Terraform (Reddit)</a></li>
<li>
<p><a href="https://github.com/99designs/aws-vault/blob/master/USAGE.md#environment-variables">aws-vault env vars</a></p>
</li>
<li>
<p>Install <a href="https://www.passwordstore.org/">Password Store</a> and <a href="https://github.com/99designs/aws-vault/blob/master/README.md">aws-vault</a> in dockerfile</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">RUN</span><span class="w"> </span>curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>/usr/local/bin/aws-vault<span class="w"> </span>https://github.com/99designs/aws-vault/releases/latest/download/aws-vault-linux-<span class="k">$(</span>dpkg<span class="w"> </span>--print-architecture<span class="k">)</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="k">RUN</span><span class="w"> </span>chmod<span class="w"> </span><span class="m">755</span><span class="w"> </span>/usr/local/bin/aws-vault
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span>pass<span class="w"> </span>
</code></pre></div>
<ol>
<li>Create GPG key to use with aws-vault, init pass, set env vars, add AWS account, login to TFC</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>gpg<span class="w"> </span>--full-generate-key<span class="w"> </span><span class="c1">#Follow prompts</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>gpg<span class="w"> </span>--list-secret-keys<span class="w"> </span>--keyid-format<span class="w"> </span>LONG<span class="w"> </span><span class="c1">#Only needed if key-id isn&#39;t recorded when output</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>pass<span class="w"> </span>init<span class="w"> </span>&lt;gpg<span class="w"> </span>key-id&gt;
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_VAULT_PASS_PREFIX</span><span class="o">=</span>aws-vault
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_VAULT_BACKEND</span><span class="o">=</span>pass
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-southeast-2
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_MFA_SERIAL</span><span class="o">=</span>arn:aws:iam::x:mfa/xxxxxxxxx
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="nb">export</span><span class="w"> </span><span class="nv">GPG_TTY</span><span class="o">=</span><span class="k">$(</span>tty<span class="k">)</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>aws-vault<span class="w"> </span>add<span class="w"> </span>aws-profile<span class="w"> </span><span class="c1">#Enter AWS Key ID &amp; Secret Access Key</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>aws-vault<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>aws-profile<span class="w"> </span><span class="c1">#Enter AWS OTP</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>terraform<span class="w"> </span>login<span class="w"> </span><span class="c1">#Enter TFC token</span>
</code></pre></div>
<p>Example of AWS key and STS token in password-store:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>$<span class="w"> </span>tree<span class="w"> </span>~/.password-store/
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>/home/vscode/.password-store/
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>└──<span class="w"> </span>aws-vault
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span>├──<span class="w"> </span>aws-profile.gpg
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span>└──<span class="w"> </span>sts.GetSessionToken.gpg
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>$<span class="w"> </span>pass
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>Password<span class="w"> </span>Store
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>└──<span class="w"> </span>aws-vault
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="w">    </span>├──<span class="w"> </span>aws-profile
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="w">    </span>└──<span class="w"> </span>sts.GetSessionToken
</code></pre></div>
<p>After MFA Prompt, aws-vault opens a subshell with temp STS credentials added as env vars. Terraform will pick up the access key, secret access key, and session token from here. It will assume the specified role in the provider config and then execute the commands.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;aws&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="w">  </span><span class="na">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_region</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">  </span><span class="nb">assume_role</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">    </span><span class="na">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1h&quot;</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">    </span><span class="na">role_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam:::role/mtc-terraform&quot;</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="p">}</span>
</code></pre></div>
<h3 id="71-the-aws-provider">71. The AWS Provider<a class="headerlink" href="#71-the-aws-provider" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs">https://registry.terraform.io/providers/hashicorp/aws/latest/docs</a></p>
<h3 id="72-deploy-a-vpc">72. Deploy a VPC<a class="headerlink" href="#72-deploy-a-vpc" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc</a></p>
<h3 id="73-remote-state-in-terraform-cloud">73. Remote State in Terraform Cloud<a class="headerlink" href="#73-remote-state-in-terraform-cloud" title="Permanent link">&para;</a></h3>
<ul>
<li>TFC workspace settings:</li>
<li>Add SSH keys for downloading TF modules from Git</li>
<li>Manually lock state</li>
<li>Deny destroy plans</li>
</ul>
<h3 id="76-the-cidrsubnet-function">76. The cidrsubnet() Function<a class="headerlink" href="#76-the-cidrsubnet-function" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/functions/cidrsubnet">https://developer.hashicorp.com/terraform/language/functions/cidrsubnet</a></p>
<ul>
<li><code>range (a,b,c)</code> a = min, b = max, c = step</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="err">terraform</span><span class="w"> </span><span class="err">console</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="err">&gt;</span><span class="w"> </span><span class="nf">cidrsubnet</span><span class="p">(</span><span class="s2">&quot;10.123.0.0/16&quot;</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">)</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="s2">&quot;10.123.20.0/24&quot;</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="err">&gt;</span><span class="w"> </span><span class="err">range</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="nf">tolist</span><span class="p">([</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">  </span><span class="m">1</span><span class="p">,</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">  </span><span class="m">3</span><span class="p">,</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="w">  </span><span class="m">5</span><span class="p">,</span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="p">])</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;networking&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./networking&quot;</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="w">  </span><span class="na">vpc_cidr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.123.0.0/16&quot;</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="w">  </span><span class="na">public_sn_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a><span class="w">  </span><span class="na">private_sn_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a><span class="w">  </span><span class="na">public_cidrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">255</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nf">cidrsubnet</span><span class="p">(</span><span class="s2">&quot;10.123.0.0/16&quot;</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">)]</span>
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a><span class="w">  </span><span class="na">private_cidrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">255</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nf">cidrsubnet</span><span class="p">(</span><span class="s2">&quot;10.123.0.0/16&quot;</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">)]</span>
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a><span class="p">}</span>
<a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a>
<a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a><span class="c1"># --- networking/main.tf ---</span>
<a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a>
<a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_subnet&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_public_subnet&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.public_sn_count</span>
<a id="__codelineno-38-26" name="__codelineno-38-26" href="#__codelineno-38-26"></a><span class="w">  </span><span class="na">vpc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.mtc_vpc.id</span>
<a id="__codelineno-38-27" name="__codelineno-38-27" href="#__codelineno-38-27"></a><span class="w">  </span><span class="na">cidr_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.public_cidrs[count.index</span><span class="p">]</span>
<a id="__codelineno-38-28" name="__codelineno-38-28" href="#__codelineno-38-28"></a><span class="w">  </span><span class="na">map_public_ip_on_launch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span><span class="c1"> #defaults to false</span>
<a id="__codelineno-38-29" name="__codelineno-38-29" href="#__codelineno-38-29"></a><span class="w">  </span><span class="na">availability_zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ap-southeast-2a&quot;,&quot;ap-southeast-2b&quot;,&quot;ap-southeast-2c&quot;</span><span class="p">][</span><span class="nv">count.index</span><span class="p">]</span>
<a id="__codelineno-38-30" name="__codelineno-38-30" href="#__codelineno-38-30"></a>
<a id="__codelineno-38-31" name="__codelineno-38-31" href="#__codelineno-38-31"></a><span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-32" name="__codelineno-38-32" href="#__codelineno-38-32"></a><span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc_public_${count.index + 1}&quot;</span>
<a id="__codelineno-38-33" name="__codelineno-38-33" href="#__codelineno-38-33"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-38-34" name="__codelineno-38-34" href="#__codelineno-38-34"></a><span class="p">}</span>
<a id="__codelineno-38-35" name="__codelineno-38-35" href="#__codelineno-38-35"></a>
<a id="__codelineno-38-36" name="__codelineno-38-36" href="#__codelineno-38-36"></a><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">state</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="err">grep</span><span class="w"> </span><span class="err">public</span>
<a id="__codelineno-38-37" name="__codelineno-38-37" href="#__codelineno-38-37"></a><span class="nv">module.networking.aws_subnet.mtc_public_subnet[0</span><span class="p">]</span>
<a id="__codelineno-38-38" name="__codelineno-38-38" href="#__codelineno-38-38"></a><span class="nv">module.networking.aws_subnet.mtc_public_subnet[1</span><span class="p">]</span>
</code></pre></div>
<h3 id="77-the-aws_availability_zones-data-source-78-the-random_shuffle-resource">77. The aws_availability_zones Data Source + 78. The random_shuffle Resource<a class="headerlink" href="#77-the-aws_availability_zones-data-source-78-the-random_shuffle-resource" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/availability_zones">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/availability_zones</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># --- networking/main.tf ---</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;aws_availability_zones&quot;</span><span class="w"> </span><span class="nv">&quot;available&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_shuffle&quot;</span><span class="w"> </span><span class="nv">&quot;az_list&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">  </span><span class="na">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_availability_zones.available.names</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">  </span><span class="na">result_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.max_subnets</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="p">}</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_subnet&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_public_subnet&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="w">  </span><span class="na">availability_zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">random_shuffle.az_list.result[count.index</span><span class="p">]</span>
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="p">}</span>
</code></pre></div>
<h3 id="80-route-tables-internet-gateway">80. Route tables &amp; Internet Gateway<a class="headerlink" href="#80-route-tables-internet-gateway" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route_table">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route_table</a>
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/default_route_table">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/default_route_table</a>
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/internet_gateway">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/internet_gateway</a></p>
<ul>
<li>One internet gateway per VPC (no count etc. required)</li>
<li>Caveat around the default route table - it's an existing resource that terraform "adopts". All routes will be removed/replaced</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_default_route_table&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_private_rt&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">  </span><span class="na">default_route_table_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.mtc_vpc.default_route_table_id</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="p">}</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="c1">#This sets the default route table in the VPC to the existing default route table that is created during VPC creation rather than assigning a new one</span>
</code></pre></div>
<h3 id="81-the-create_before_destroy-lifecycle-meta-argument">81. The create_before_destroy Lifecycle Meta Argument<a class="headerlink" href="#81-the-create_before_destroy-lifecycle-meta-argument" title="Permanent link">&para;</a></h3>
<ul>
<li>When making a change to a VPC that requires recreating the VPC (e.g. changing the CIDR block) terraform will not delete the internet gateway. Instead, it will try and associate it to the new VPC which doesn't exist.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="w">  </span><span class="c1"># module.networking.aws_internet_gateway.mtc_internet_gateway will be updated in-place</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">  </span>~<span class="w"> </span>resource<span class="w"> </span><span class="s2">&quot;aws_internet_gateway&quot;</span><span class="w"> </span><span class="s2">&quot;mtc_internet_gateway&quot;</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">        </span><span class="nv">id</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;igw-0196283b5867f33f8&quot;</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">        </span><span class="nv">tags</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">            </span><span class="s2">&quot;Name&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc_igw&quot;</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">        </span><span class="o">}</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">      </span>~<span class="w"> </span><span class="nv">vpc_id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;vpc-0b39532bb43b7b98c&quot;</span><span class="w"> </span>-&gt;<span class="w"> </span><span class="o">(</span>known<span class="w"> </span>after<span class="w"> </span>apply<span class="o">)</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">        </span><span class="c1"># (3 unchanged attributes hidden)</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">  </span><span class="o">}</span>
</code></pre></div>
<ul>
<li>Need to use create_before_destroy lifecycle argument on the VPC to tell Terraform to create a new VPC before destroying the old one</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_vpc&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_vpc&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">  </span><span class="na">cidr_block</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">var.vpc_cidr</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">  </span><span class="na">enable_dns_hostnames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">  </span><span class="na">enable_dns_support</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">    </span><span class="na">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc_vpc_${random_integer.random.id}&quot;</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">  </span><span class="nb">lifecycle</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">    </span><span class="na">create_before_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="p">}</span>
</code></pre></div>
<h3 id="82-security-groups">82. Security Groups<a class="headerlink" href="#82-security-groups" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group</a></p>
<ul>
<li>Always a chance when modifying security groups of causing a very short interruption to traffic</li>
<li>Can use nested <code>for_each</code> to access inner maps within locals and then use dynamic blocks to iterate through them.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1"># --- root/locals.tf ---</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">  </span><span class="nb">security_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">    </span><span class="nb">public</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">      </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;public_sg&quot;</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">      </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Security Group for Public Access&quot;</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">      </span><span class="nb">ingress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">        </span><span class="nb">ssh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">          </span><span class="na">from</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">22</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">          </span><span class="na">to</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="m">22</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="w">          </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="w">          </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">var.access_ip</span><span class="p">]</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="w">        </span><span class="nb">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="w">          </span><span class="na">from</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="w">          </span><span class="na">to</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a><span class="w">          </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a><span class="w">          </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a><span class="w">    </span><span class="nb">rds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a><span class="w">      </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;rds_sg&quot;</span>
<a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a><span class="w">      </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;RDS Access&quot;</span>
<a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a><span class="w">      </span><span class="nb">ingress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a><span class="w">        </span><span class="nb">mysql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a><span class="w">          </span><span class="na">from</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">3306</span>
<a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a><span class="w">          </span><span class="na">to</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="m">3306</span>
<a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a><span class="w">          </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tcp&quot;</span>
<a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a><span class="w">          </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">local.vpc_cidr</span><span class="p">]</span>
<a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a><span class="p">}</span>
<a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a>
<a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a>
<a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;networking&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a><span class="w">  </span><span class="na">source</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./networking&quot;</span>
<a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a><span class="w">  </span><span class="na">vpc_cidr</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">local.vpc_cidr</span>
<a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a><span class="w">  </span><span class="na">access_ip</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a><span class="w">  </span><span class="na">security_groups</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">local.security_groups</span>
<a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a><span class="w">  </span><span class="na">public_sn_count</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-43-46" name="__codelineno-43-46" href="#__codelineno-43-46"></a><span class="w">  </span><span class="na">private_sn_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<a id="__codelineno-43-47" name="__codelineno-43-47" href="#__codelineno-43-47"></a><span class="w">  </span><span class="na">max_subnets</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">20</span>
<a id="__codelineno-43-48" name="__codelineno-43-48" href="#__codelineno-43-48"></a><span class="w">  </span><span class="na">public_cidrs</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">255</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nf">cidrsubnet</span><span class="p">(</span><span class="nv">local.vpc_cidr</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">)]</span>
<a id="__codelineno-43-49" name="__codelineno-43-49" href="#__codelineno-43-49"></a><span class="w">  </span><span class="na">private_cidrs</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">255</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nf">cidrsubnet</span><span class="p">(</span><span class="nv">local.vpc_cidr</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="err">i</span><span class="p">)]</span>
<a id="__codelineno-43-50" name="__codelineno-43-50" href="#__codelineno-43-50"></a><span class="p">}</span>
<a id="__codelineno-43-51" name="__codelineno-43-51" href="#__codelineno-43-51"></a>
<a id="__codelineno-43-52" name="__codelineno-43-52" href="#__codelineno-43-52"></a><span class="c1"># --- networking/main.tf ---</span>
<a id="__codelineno-43-53" name="__codelineno-43-53" href="#__codelineno-43-53"></a>
<a id="__codelineno-43-54" name="__codelineno-43-54" href="#__codelineno-43-54"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_security_group&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_sg&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-55" name="__codelineno-43-55" href="#__codelineno-43-55"></a><span class="w">  </span><span class="na">for_each</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.security_groups</span>
<a id="__codelineno-43-56" name="__codelineno-43-56" href="#__codelineno-43-56"></a><span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.name</span>
<a id="__codelineno-43-57" name="__codelineno-43-57" href="#__codelineno-43-57"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.description</span>
<a id="__codelineno-43-58" name="__codelineno-43-58" href="#__codelineno-43-58"></a><span class="w">  </span><span class="na">vpc_id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_vpc.mtc_vpc.id</span>
<a id="__codelineno-43-59" name="__codelineno-43-59" href="#__codelineno-43-59"></a>
<a id="__codelineno-43-60" name="__codelineno-43-60" href="#__codelineno-43-60"></a><span class="w">  </span><span class="err">dynamic</span><span class="w"> </span><span class="s2">&quot;ingress&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-61" name="__codelineno-43-61" href="#__codelineno-43-61"></a><span class="w">    </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.ingress</span>
<a id="__codelineno-43-62" name="__codelineno-43-62" href="#__codelineno-43-62"></a><span class="w">    </span><span class="nb">content</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-63" name="__codelineno-43-63" href="#__codelineno-43-63"></a><span class="w">      </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">ingress.value.from</span>
<a id="__codelineno-43-64" name="__codelineno-43-64" href="#__codelineno-43-64"></a><span class="w">      </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">ingress.value.to</span>
<a id="__codelineno-43-65" name="__codelineno-43-65" href="#__codelineno-43-65"></a><span class="w">      </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">ingress.value.protocol</span>
<a id="__codelineno-43-66" name="__codelineno-43-66" href="#__codelineno-43-66"></a><span class="w">      </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ingress.value.cidr_blocks</span>
<a id="__codelineno-43-67" name="__codelineno-43-67" href="#__codelineno-43-67"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-43-68" name="__codelineno-43-68" href="#__codelineno-43-68"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-43-69" name="__codelineno-43-69" href="#__codelineno-43-69"></a>
<a id="__codelineno-43-70" name="__codelineno-43-70" href="#__codelineno-43-70"></a><span class="w">  </span><span class="nb">egress</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-71" name="__codelineno-43-71" href="#__codelineno-43-71"></a><span class="w">    </span><span class="na">from_port</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-43-72" name="__codelineno-43-72" href="#__codelineno-43-72"></a><span class="w">    </span><span class="na">to_port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-43-73" name="__codelineno-43-73" href="#__codelineno-43-73"></a><span class="w">    </span><span class="na">protocol</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;-1&quot;</span>
<a id="__codelineno-43-74" name="__codelineno-43-74" href="#__codelineno-43-74"></a><span class="w">    </span><span class="na">cidr_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
<a id="__codelineno-43-75" name="__codelineno-43-75" href="#__codelineno-43-75"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-43-76" name="__codelineno-43-76" href="#__codelineno-43-76"></a><span class="p">}</span>
</code></pre></div>
<h3 id="85-vpc-rds-subnet-group-and-conditionals">85. VPC RDS Subnet Group and Conditionals<a class="headerlink" href="#85-vpc-rds-subnet-group-and-conditionals" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_subnet_group">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_subnet_group</a></p>
<ul>
<li>Need a db_subnet to create an RDS</li>
<li>Conditionals allow you to control how many instances are deployed. Uses logical "if variable == value, then x, else y". Example:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="err">&gt;</span><span class="w"> </span><span class="s2">&quot;us-east-1&quot;</span><span class="w"> </span><span class="o">=</span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;us-east-1&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">3</span><span class="p">:</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="m">3</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="err">&gt;</span><span class="w"> </span><span class="s2">&quot;us-west-1&quot;</span><span class="w"> </span><span class="o">=</span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;us-east-1&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">3</span><span class="p">:</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="m">1</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="err">&gt;</span><span class="w"> </span><span class="na">true</span><span class="w"> </span><span class="o">=</span><span class="p">=</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="m">1</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="err">&gt;</span><span class="w"> </span><span class="na">false</span><span class="w"> </span><span class="o">=</span><span class="p">=</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="m">0</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="err">&gt;</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="m">1</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="err">&gt;</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="m">0</span>
</code></pre></div>
<ul>
<li>Conditional bool is useful to control whether a resource is deployed based on a flag. If <code>db_subnet_group = false</code> then subnet_group does not deploy</li>
<li><code>count = var.db_subnet_group == true ? 1 : 0</code> can be shortened to <code>count = var.db_subnet_group ? 1 : 0</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;networking&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">  </span><span class="na">source</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./networking&quot;</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">  </span><span class="na">db_subnet_group</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="p">}</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_db_subnet_group&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_rds_subnetgroup&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.db_subnet_group</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc_rds_subnetgroup&quot;</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="w">  </span><span class="na">subnet_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_subnet.mtc_private_subnet</span><span class="p">.</span><span class="err">*</span><span class="p">.</span><span class="err">id</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="w">    </span><span class="s2">&quot;Name&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc_rds_sng&quot;</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="p">}</span>
</code></pre></div>
<h3 id="86-basic-rds-setup">86. Basic RDS Setup<a class="headerlink" href="#86-basic-rds-setup" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance</a></p>
<ul>
<li>Most K8s deployments you would use etcd but in this case using Rancher K3s it allows you to use a standard RDS (MySQL or Postgres) to store the data</li>
</ul>
<h3 id="89-the-terraform-providers-schema-command">89. The terraform providers schema command<a class="headerlink" href="#89-the-terraform-providers-schema-command" title="Permanent link">&para;</a></h3>
<ul>
<li>Shows the entire AWS schema. 65 Mbps file, 890000 lines</li>
<li>example of where password is marked as sensitive in aws_db_instance</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="kc">terraf</span><span class="err">orm</span><span class="w"> </span><span class="err">providers</span><span class="w"> </span><span class="err">schema</span><span class="w"> </span><span class="mi">-</span><span class="err">jso</span><span class="kc">n</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="err">jq</span><span class="w"> </span><span class="err">&#39;.&#39;</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">schema.jso</span><span class="kc">n</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">        </span><span class="nt">&quot;aws_db_instance&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">          </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">          </span><span class="nt">&quot;block&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">            </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">              </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">                </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">                </span><span class="nt">&quot;description_kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;plain&quot;</span><span class="p">,</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">                </span><span class="nt">&quot;optional&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">                </span><span class="nt">&quot;sensitive&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="w">              </span><span class="p">}</span>
</code></pre></div>
<h3 id="90-alb-setup">90. ALB setup<a class="headerlink" href="#90-alb-setup" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb</a></p>
<ul>
<li>Load balances K3s in public subnet. Usually these would be in private subnets, but there's no bastion host or NAT gateway in this scenario</li>
<li>Subnets and security groups similar to <code>aws_db_instance</code></li>
</ul>
<h3 id="92-alb-target-group-and-the-uuid-and-substr-functions">92. ALB Target Group and the UUID and substr functions<a class="headerlink" href="#92-alb-target-group-and-the-uuid-and-substr-functions" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group</a>
<a href="https://developer.hashicorp.com/terraform/language/functions/uuid">https://developer.hashicorp.com/terraform/language/functions/uuid</a>
<a href="https://developer.hashicorp.com/terraform/language/functions/substr">https://developer.hashicorp.com/terraform/language/functions/substr</a></p>
<ul>
<li>use instead of the random function for naming</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="err">&gt;</span><span class="w"> </span><span class="nf">uuid</span><span class="p">()</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="err">b</span><span class="m">5</span><span class="err">ee</span><span class="m">72</span><span class="err">a</span><span class="m">3</span><span class="err">-</span><span class="m">54</span><span class="err">dd-c</span><span class="m">4</span><span class="err">b</span><span class="m">8</span><span class="err">-</span><span class="m">551</span><span class="err">c-</span><span class="m">4</span><span class="err">bdc</span><span class="m">0204</span><span class="err">cedb</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="nf">substr</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="err">offset</span><span class="p">,</span><span class="w"> </span><span class="err">length</span><span class="p">)</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="err">&gt;</span><span class="w"> </span><span class="err">substr</span><span class="w"> </span><span class="p">(</span><span class="nf">uuid</span><span class="p">(),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="s2">&quot;b5ee&quot;</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lb_target_group&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_tg&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-lb-tg-${substr(uuid(), 0, 3)}&quot;</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>Note, each time terraform apply is ran it will generate a new UUID. If this is used in a resource name it may try and destroy/re-create the resource each time (as is the case with ALB target group)</p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/57183814/error-deleting-target-group-resourceinuse-when-changing-target-ports-in-aws-thr">create before destroy when changing lb_target_group port</a></p>
</li>
</ul>
<h3 id="93-alb-listener">93. ALB listener<a class="headerlink" href="#93-alb-listener" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener</a></p>
<ul>
<li>Receives the external traffic and forwards to target group</li>
</ul>
<h3 id="94-alb-lifecycle-policies-ignore_changes-and-create_before_destroy">94. ALB lifecycle Policies: ignore_changes and create_before_destroy<a class="headerlink" href="#94-alb-lifecycle-policies-ignore_changes-and-create_before_destroy" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/meta-arguments/lifecycle">https://developer.hashicorp.com/terraform/language/meta-arguments/lifecycle</a></p>
<ul>
<li>To prevent the alb target group from being replaced on each run using the UUID function for generating the name, use the ignore_changes lifecycle policy</li>
<li>If replacing the target group (for example after the name is updated) the listener needs to reference the new target group before the old one is destroyed</li>
<li>Solution: Use the create_before_destroy lifecycle policy on the target group</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lb_target_group&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_tg&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">  </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-lb-tg-${substr(uuid(), 0, 3)}&quot;</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">  </span><span class="na">port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.tg_port</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">  </span><span class="na">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.tg_protocol</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">  </span><span class="na">vpc_id</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.vpc_id</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">  </span><span class="nb">lifecycle</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">    </span><span class="na">ignore_changes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nb">name</span><span class="p">]</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="w">    </span><span class="na">create_before_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="w">  </span><span class="nb">health_check</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="w">    </span><span class="na">healthy_threshold</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.lb_healthy_threshold</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="w">    </span><span class="na">unhealthy_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.lb_unhealthy_threshold</span>
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a><span class="w">    </span><span class="na">timeout</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">var.lb_timeout</span>
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="w">    </span><span class="na">interval</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">var.lb_interval</span>
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a><span class="p">}</span>
</code></pre></div>
<h3 id="96-the-aws_ami-datasource">96. The aws_ami datasource<a class="headerlink" href="#96-the-aws_ami-datasource" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami</a></p>
<ul>
<li>Use awscli to search and sort Ubuntu images</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>aws<span class="w"> </span>ec2<span class="w"> </span>describe-images<span class="w"> </span>--owners<span class="w"> </span><span class="m">099720109477</span><span class="w"> </span>--filters<span class="w"> </span><span class="s2">&quot;Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*&quot;</span><span class="w"> </span>--query<span class="w"> </span><span class="s1">&#39;Images[*].[ImageId, Name]&#39;</span><span class="w"> </span>--output<span class="w"> </span>table<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $4,$2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>Latest<span class="w"> </span>image:<span class="w"> </span>ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-20240207.1<span class="w"> </span>ami-0d6f74b9139d26bf1
</code></pre></div>
<ul>
<li>How to always get the latest version in terraform</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># --- compute/main.tf ---</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;aws_ami&quot;</span><span class="w"> </span><span class="nv">&quot;server_ami&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">  </span><span class="na">most_recent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">  </span><span class="na">owners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;099720109477&quot;</span><span class="p">]</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">  </span><span class="nb">filter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;name&quot;</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="w">    </span><span class="na">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*&quot;</span><span class="p">]</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="p">}</span>
</code></pre></div>
<h3 id="97-ec2-instances">97. EC2 instances<a class="headerlink" href="#97-ec2-instances" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance</a></p>
<h3 id="98-ssh-key-for-instance">98. SSH Key for Instance<a class="headerlink" href="#98-ssh-key-for-instance" title="Permanent link">&para;</a></h3>
<p><a href="https://www.udemy.com/course/terraform-certified/learn/lecture/24789250#notes">https://www.udemy.com/course/terraform-certified/learn/lecture/24789250#notes</a></p>
<ul>
<li>Pass public key as a file rather than a string</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1"># --- compute/main.tf ---</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_key_pair&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_auth&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">  </span><span class="na">key_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.key_name</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">  </span><span class="na">public_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">file</span><span class="p">(</span><span class="nv">var.public_key_path</span><span class="p">)</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="p">}</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;compute&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">  </span><span class="na">source</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./compute&quot;</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="w">  </span><span class="na">public_key_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;../../id_rsa.pub&quot;</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="p">}</span>
</code></pre></div>
<h3 id="100-controlling-random_id-changes-with-keepers">100. Controlling random_id Changes with Keepers<a class="headerlink" href="#100-controlling-random_id-changes-with-keepers" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/random/latest/docs#resource-keepers">https://registry.terraform.io/providers/hashicorp/random/latest/docs#resource-keepers</a></p>
<ul>
<li>Use the random_id resource in some cases as the UUID method <code>name = "mtc-lb-tg-${substr(uuid(), 0, 3)}"</code> may not always generate what's required. UUID also changes on each apply which is usually not wanted.</li>
<li>Keepers trigger a new random ID resource when the consumer of that resource is destroyed</li>
<li>The resources all provide a map argument called keepers that can be populated with arbitrary key/value pairs that when one of the values is modified, a new random ID should be generated. Otherwise, random_id only generates randomness when it is first created.</li>
<li>The key_name in the keepers block determines when a new random_id should be created (when the key_name is changed)</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_id&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_node_id&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">  </span><span class="na">byte_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="w">  </span><span class="na">count</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.instance_count</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">  </span><span class="nb">keepers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="c1">    #Generate a new id each time a new key_name is changes. A instance is replaced by terraform whenever the key changes.</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">    </span><span class="na">key_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.key_name</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="p">}</span>
</code></pre></div>
<h3 id="102-ec2-user-data-and-template-files">102. EC2 User Data and Template Files<a class="headerlink" href="#102-ec2-user-data-and-template-files" title="Permanent link">&para;</a></h3>
<p><a href="https://docs.k3s.io/installation">https://docs.k3s.io/installation</a>
<a href="https://developer.hashicorp.com/terraform/language/functions/templatefile">https://developer.hashicorp.com/terraform/language/functions/templatefile</a></p>
<ul>
<li>Template files: Pass template file path and variables from terraform deployment <code>templatefile(path, vars)</code>, and it will generate the required output (can do JSON &amp; YAML)</li>
<li>Similar to Ansible Jinja template</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;compute&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">  </span><span class="na">source</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./compute&quot;</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">  </span><span class="na">user_data_path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${path.root}/userdata.tpl&quot;</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">  </span><span class="na">db_endpoint</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">module.database.db_endpoint</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">  </span><span class="na">dbname</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nv">var.dbname</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="w">  </span><span class="na">dbuser</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nv">var.dbuser</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">  </span><span class="na">dbpassword</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.dbpassword</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="p">}</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="c1"># --- compute/main.tf ---</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_instance&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_node&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="w">  </span><span class="na">user_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">templatefile</span><span class="p">(</span><span class="nv">var.user_data_path</span><span class="p">,</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="w">      </span><span class="na">nodename</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-${random_id.mtc_node_id[count.index].dec}&quot;</span>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w">      </span><span class="na">db_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.db_endpoint</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w">      </span><span class="na">dbname</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.dbname</span>
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a><span class="w">      </span><span class="na">dbuser</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.dbuser</span>
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a><span class="w">      </span><span class="na">dbpass</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.dbpassword</span>
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a><span class="w">  </span><span class="p">)</span>
<a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a><span class="p">}</span>
<a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a>
<a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a><span class="c1"># --- userdata.tpl ---</span>
<a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a>
<a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a><span class="c1">#!/bin/bash</span>
<a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a><span class="err">sudo</span><span class="w"> </span><span class="err">hostnamectl</span><span class="w"> </span><span class="kt">set</span><span class="err">-hostname</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="err">nodename</span><span class="p">}</span><span class="w"> </span><span class="err">&amp;&amp;</span>
<a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a><span class="err">curl</span><span class="w"> </span><span class="err">-sfL</span><span class="w"> </span><span class="err">https</span><span class="p">:</span><span class="c1">//get.k3s.io | sh -s - server \</span>
<a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a><span class="na">--datastore-endpoint</span><span class="o">=</span><span class="s2">&quot;mysql://${dbuser}:${dbpass}@tcp(${db_endpoint})/${dbname}&quot;</span><span class="w"> </span>\
<a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a><span class="err">--write-kubeconfig-mode</span><span class="w"> </span><span class="m">644</span><span class="w"> </span>\
<a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a><span class="na">--tls-san</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="err">curl</span><span class="w"> </span><span class="err">http</span><span class="p">:</span><span class="c1">//169.254.169.254/latest/meta-data/public-ipv4) \</span>
<a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a><span class="na">--token</span><span class="o">=</span><span class="s2">&quot;th1s1sat0k3n!&quot;</span>
</code></pre></div>
<h3 id="104-deploying-nginx-on-kubernetes-cluster">104. Deploying NGINX on Kubernetes Cluster!<a class="headerlink" href="#104-deploying-nginx-on-kubernetes-cluster" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1"># --- deployment.yaml ---</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="w">      </span><span class="c1"># manage pods with the label app: nginx</span>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a><span class="w">          </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>ubuntu@mtc-28454:~$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>NAME<span class="w">        </span>STATUS<span class="w">   </span>ROLES<span class="w">                  </span>AGE<span class="w">     </span>VERSION
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>mtc-28454<span class="w">   </span>Ready<span class="w">    </span>control-plane,master<span class="w">   </span>3m40s<span class="w">   </span>v1.28.6+k3s2
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>ubuntu@mtc-28454:~$<span class="w"> </span>vim<span class="w"> </span>deployment.yaml
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>ubuntu@mtc-28454:~$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>deployment.yaml<span class="w"> </span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>deployment.apps/nginx<span class="w"> </span>created
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>ubuntu@mtc-28454:~$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>NAME<span class="w">                     </span>READY<span class="w">   </span>STATUS<span class="w">              </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a>nginx-77d6466568-77dmw<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Pending<span class="w">             </span><span class="m">0</span><span class="w">          </span>8s
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>nginx-77d6466568-j7bxx<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>ContainerCreating<span class="w">   </span><span class="m">0</span><span class="w">          </span>8s
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a>ubuntu@mtc-28454:~$<span class="w"> </span>curl<span class="w"> </span>localhost:8000
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a>&lt;!DOCTYPE<span class="w"> </span>html&gt;
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a>&lt;html&gt;
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a>&lt;head&gt;
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a>&lt;title&gt;Welcome<span class="w"> </span>to<span class="w"> </span>nginx!&lt;/title&gt;
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a>&lt;style&gt;
</code></pre></div>
<ul>
<li>Only 1x K3s node so 1/2 NGINX replicas is Pending</li>
<li>Using RDS to share the state of the cluster, so as soon as the 2nd K3s instance is deployed it will join the cluster</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>ubuntu@mtc-28454:~$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>NAME<span class="w">        </span>STATUS<span class="w">   </span>ROLES<span class="w">                  </span>AGE<span class="w">   </span>VERSION
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>mtc-28454<span class="w">   </span>Ready<span class="w">    </span>control-plane,master<span class="w">   </span>14m<span class="w">   </span>v1.28.6+k3s2
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>mtc-8953<span class="w">    </span>Ready<span class="w">    </span>control-plane,master<span class="w">   </span>46s<span class="w">   </span>v1.28.6+k3s2
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>ubuntu@mtc-28454:~$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>NAME<span class="w">                     </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>nginx-77d6466568-j7bxx<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7m38s
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>nginx-77d6466568-77dmw<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7m38s
</code></pre></div>
<h3 id="105-add-k3-instances-to-alb-target-group">105. Add K3 Instances to ALB target group<a class="headerlink" href="#105-add-k3-instances-to-alb-target-group" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group_attachment">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group_attachment</a></p>
<ul>
<li>Configure target group attachment which assigns instances (targets) to an ALB target group</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1"># --- loadbalancing/outputs.tf ---</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;lb_target_group_arn&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lb_target_group.mtc_tg.arn</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="p">}</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;compute&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="w">  </span><span class="na">source</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./compute&quot;</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="w">  </span><span class="na">instance_count</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="w">  </span><span class="p">...</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="w">  </span><span class="na">lb_target_group_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.loadbalancing.lb_target_group_arn</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="p">}</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a><span class="c1"># --- compute/main.tf ---</span>
<a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a>
<a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lb_target_group_attachment&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_tg_attach&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a><span class="w">  </span><span class="na">count</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">var.instance_count</span>
<a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a><span class="w">  </span><span class="na">target_group_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.lb_target_group_arn</span>
<a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a><span class="w">  </span><span class="na">target_id</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_instance.mtc_node[count.index].id</span>
<a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a><span class="w">  </span><span class="na">port</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="m">8000</span>
<a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a><span class="p">}</span>
</code></pre></div>
<h3 id="106-adding-outputs-for-our-resources">106. Adding Outputs for our Resources<a class="headerlink" href="#106-adding-outputs-for-our-resources" title="Permanent link">&para;</a></h3>
<ul>
<li>Output to show ALB DNS name</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="c1"># --- loadbalancing/outputs.tf ---</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;lb_endpoint&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lb.mtc_lb.dns_name</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="p">}</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="c1"># --- root/outputs.tf ---</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;load_balancer_endpoint&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.loadbalancing.lb_endpoint</span>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="w"> </span>$<span class="w"> </span>terraform<span class="w"> </span>refresh
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>module.networking.random_integer.random:<span class="w"> </span>Refreshing<span class="w"> </span>state...<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span><span class="m">41</span><span class="o">]</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>module.compute.random_id.mtc_node_id<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Refreshing<span class="w"> </span>state...<span class="w"> </span><span class="o">[</span><span class="nv">id</span><span class="o">=</span>Ivk<span class="o">]</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>...
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>Outputs:
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="nv">load_balancer_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-loadbalancer-1200784660.ap-southeast-2.elb.amazonaws.com&quot;</span>
</code></pre></div>
<ul>
<li>Terraform refresh will refresh state and show the outputs without having to do an apply. Can also do a <code>terraform output</code> once the outputs have been created the first time.</li>
</ul>
<h3 id="107-sensitive-outputs-and-how-to-access-them">107. Sensitive Outputs and how to access them<a class="headerlink" href="#107-sensitive-outputs-and-how-to-access-them" title="Permanent link">&para;</a></h3>
<ul>
<li>Create output for EC2 instances name and IP</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="c1"># --- compute/outputs.tf ---</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;instance&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_instance.mtc_node</span><span class="p">[</span><span class="err">*</span><span class="p">]</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="p">}</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="c1"># --- root/outputs.tf ---</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="kr">output</span><span class="w"> </span><span class="nv">&quot;instances&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="w">  </span><span class="nb">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="err">for</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">module.compute.instance</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nv">i.tags.Name</span><span class="w"> </span><span class="p">=</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">i.public_ip</span><span class="p">}</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>terraform<span class="w"> </span>refresh
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>Outputs:
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="nv">instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">  </span><span class="s2">&quot;mtc_node-28454&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;3.106.116.78&quot;</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="w">  </span><span class="s2">&quot;mtc_node-8953&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;13.210.137.182&quot;</span>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="o">}</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="nv">load_balancer_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-loadbalancer-1200784660.ap-southeast-2.elb.amazonaws.com&quot;</span>
</code></pre></div>
<ul>
<li>In older versions of Terraform when you send all attributes of the instances in compute/outputs.tf output you would need to add <code>sensitive = true</code> to the outputs in the compute and root modules. Then you would need to output in JSON to get the values. With later versions you don't need this workaround because you aren't outputting the sensitive values in the root module.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>terraform<span class="w"> </span>output<span class="w"> </span>-json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.&quot;instances&quot;.&quot;value&quot;&#39;</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="o">{</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="w">  </span><span class="s2">&quot;mtc_node-28454&quot;</span>:<span class="w"> </span><span class="s2">&quot;3.106.116.78&quot;</span>,
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">  </span><span class="s2">&quot;mtc_node-8953&quot;</span>:<span class="w"> </span><span class="s2">&quot;13.210.137.182&quot;</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="o">}</span>
</code></pre></div>
<h3 id="109-utilising-the-remote-and-local-exec-provisioner-to-scp-the-kubeconfig-file">109. Utilising the remote and local-exec provisioner to SCP the Kubeconfig file<a class="headerlink" href="#109-utilising-the-remote-and-local-exec-provisioner-to-scp-the-kubeconfig-file" title="Permanent link">&para;</a></h3>
<ul>
<li>Install Kubectl to run K8s commands locally in devcontainer. Add to dockerfile</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="k">RUN</span><span class="w"> </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key<span class="w"> </span><span class="p">|</span><span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span>-o<span class="w"> </span>/etc/apt/keyrings/kubernetes-apt-keyring.gpg
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="k">RUN</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/kubernetes.list
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="w">    </span>kubectl
</code></pre></div>
<ul>
<li>Remote provisioner will run delay.sh to check for the presence of k3s.yaml on the remote node, so it knows when the node is operational.</li>
<li>Local provisioner copies k3s YAML config locally from k3s node and replaces local IP with the public IP. Then you can run kubectl commands locally and access the remote node.</li>
<li>Local provisioner will remove the k3s config file upon destroy</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="c1"># --- compute/main.tf ---</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_instance&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_node&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="w">    </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;remote-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="w">    </span><span class="nb">connection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="w">      </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh&quot;</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="w">      </span><span class="na">host</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">self.public_ip</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="w">      </span><span class="na">user</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="w">      </span><span class="na">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">file</span><span class="p">(</span><span class="s2">&quot;${path.cwd}/../../id_rsa&quot;</span><span class="p">)</span>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="w">    </span><span class="na">script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${path.cwd}/delay.sh&quot;</span>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="w">    </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;local-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="w">    </span><span class="na">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">templatefile</span><span class="p">(</span><span class="s2">&quot;${path.cwd}/scp_script.tpl&quot;</span><span class="p">,</span>
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a><span class="w">        </span><span class="na">nodeip</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nv">self.public_ip</span>
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a><span class="w">        </span><span class="na">k3s_path</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${path.cwd}/../../&quot;</span>
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a><span class="w">        </span><span class="na">nodename</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">self.tags.Name</span>
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a><span class="w">        </span><span class="na">privatekey_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${path.cwd}/../../id_rsa&quot;</span>
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a><span class="w">    </span><span class="p">)</span>
<a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a><span class="w">    </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;local-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a><span class="w">    </span><span class="na">when</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="err">destroy</span>
<a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a><span class="w">    </span><span class="na">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;rm -f ${path.cwd}/../../k3s-${self.tags.Name}&quot;</span>
<a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="c1"># --- delay.sh ---</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="c1">#!/bin/bash</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span>/etc/rancher/k3s/k3s.yaml<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;Waiting for k3s to bootstrap...&quot;</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="w">    </span>sleep<span class="w"> </span><span class="m">3</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="k">done</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="c1"># --- scp_script.tpl ---</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a>scp<span class="w"> </span>-i<span class="w"> </span><span class="si">${</span><span class="nv">privatekey_path</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a>-o<span class="w"> </span><span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>-o<span class="w"> </span><span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a>-q<span class="w"> </span>ubuntu@<span class="si">${</span><span class="nv">nodeip</span><span class="si">}</span>:/etc/rancher/k3s/k3s.yaml<span class="w"> </span><span class="si">${</span><span class="nv">k3s_path</span><span class="si">}</span>/k3s-<span class="si">${</span><span class="nv">nodename</span><span class="si">}</span>.yaml<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/127.0.0.1/${nodeip}/&#39;</span><span class="w"> </span><span class="si">${</span><span class="nv">k3s_path</span><span class="si">}</span>/k3s-<span class="si">${</span><span class="nv">nodename</span><span class="si">}</span>.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="c1"># --- k3s-mtc_node-50332.yaml ---</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="nt">clusters</span><span class="p">:</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster</span><span class="p">:</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="w">    </span><span class="nt">certificate-authority-data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://x.x.x.x:6443</span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="nt">contexts</span><span class="p">:</span>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">context</span><span class="p">:</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a><span class="w">    </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a><span class="nt">current-context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Config</span>
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a><span class="nt">preferences</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a><span class="nt">users</span><span class="p">:</span>
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a><span class="w">  </span><span class="nt">user</span><span class="p">:</span>
<a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a><span class="w">    </span><span class="nt">client-certificate-data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a><span class="w">    </span><span class="nt">client-key-data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/workspaces/terraform-associate/k3s-mtc_node-50332.yaml
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>NAME<span class="w">        </span>STATUS<span class="w">   </span>ROLES<span class="w">                  </span>AGE<span class="w">     </span>VERSION
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>mtc-50332<span class="w">   </span>Ready<span class="w">    </span>control-plane,master<span class="w">   </span>4m41s<span class="w">   </span>v1.28.6+k3s2
</code></pre></div>
<h3 id="112-deploying-k8s-resources-from-our-cloud9-instance">112. Deploying K8s Resources from our Cloud9 Instance<a class="headerlink" href="#112-deploying-k8s-resources-from-our-cloud9-instance" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># --- nginx-dep.yaml ---</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="w">      </span><span class="c1"># manage pods with the label app: nginx</span>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a><span class="w">          </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>NAME<span class="w">        </span>STATUS<span class="w">   </span>ROLES<span class="w">                  </span>AGE<span class="w">   </span>VERSION
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>mtc-50332<span class="w">   </span>Ready<span class="w">    </span>control-plane,master<span class="w">   </span>51m<span class="w">   </span>v1.28.6+k3s2
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>$<span class="w"> </span>kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>nginx-dep.yaml
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>deployment.apps/nginx<span class="w"> </span>created
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>NAME<span class="w">                     </span>READY<span class="w">   </span>STATUS<span class="w">              </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>mtc-50332<span class="w">   </span>Ready<span class="w">    </span>control-plane,master<span class="w">   </span>52m<span class="w">   </span>v1.28.6+k3s2
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>$<span class="w"> </span>terraform<span class="w"> </span>output<span class="w"> </span>-json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.&quot;load_balancer_endpoint&quot;.&quot;value&quot;&#39;</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="s2">&quot;mtc-loadbalancer-574255458.ap-southeast-2.elb.amazonaws.com&quot;</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a>$<span class="w"> </span>curl<span class="w"> </span>mtc-loadbalancer-574255458.ap-southeast-2.elb.amazonaws.com
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>&lt;!DOCTYPE<span class="w"> </span>html&gt;
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a>&lt;html&gt;
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a>&lt;head&gt;
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>&lt;title&gt;Welcome<span class="w"> </span>to<span class="w"> </span>nginx!&lt;/title&gt;
</code></pre></div>
<h2 id="section-5-deploying-kubernetes-resources-with-terraform">Section 5: Deploying Kubernetes Resources with Terraform<a class="headerlink" href="#section-5-deploying-kubernetes-resources-with-terraform" title="Permanent link">&para;</a></h2>
<h3 id="113-configuring-k8s-provider">113. Configuring K8s provider<a class="headerlink" href="#113-configuring-k8s-provider" title="Permanent link">&para;</a></h3>
<p><a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs">https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs</a></p>
<h3 id="114-our-first-k8s-deployment">114. Our First K8s Deployment<a class="headerlink" href="#114-our-first-k8s-deployment" title="Permanent link">&para;</a></h3>
<ul>
<li>For large K8s deployment, Terraform is not the right tool. Don't always play well together. Probably best to use native k8s tools or Helm/ArgoCD</li>
<li>This deployment is node-red containers (behind ALB) with their own local volume storage (not shared EFS, EBS etc.)</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;kubernetes_deployment&quot;</span><span class="w"> </span><span class="nv">&quot;iotdep&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="w">  </span><span class="nb">metadata</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;iotdep&quot;</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="w">    </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="w">      </span><span class="na">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;iotapp&quot;</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a><span class="w">  </span><span class="nb">spec</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a><span class="w">    </span><span class="na">replicas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>
<a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a><span class="w">    </span><span class="nb">selector</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a><span class="w">      </span><span class="nb">match_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a><span class="w">        </span><span class="na">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;iotapp&quot;</span>
<a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a>
<a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a><span class="w">    </span><span class="nb">template</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a><span class="w">      </span><span class="nb">metadata</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a><span class="w">        </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a><span class="w">          </span><span class="na">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;iotapp&quot;</span>
<a id="__codelineno-70-24" name="__codelineno-70-24" href="#__codelineno-70-24"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-70-25" name="__codelineno-70-25" href="#__codelineno-70-25"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-70-26" name="__codelineno-70-26" href="#__codelineno-70-26"></a>
<a id="__codelineno-70-27" name="__codelineno-70-27" href="#__codelineno-70-27"></a><span class="w">      </span><span class="nb">spec</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-28" name="__codelineno-70-28" href="#__codelineno-70-28"></a><span class="w">        </span><span class="nb">container</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-29" name="__codelineno-70-29" href="#__codelineno-70-29"></a><span class="w">          </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest&quot;</span>
<a id="__codelineno-70-30" name="__codelineno-70-30" href="#__codelineno-70-30"></a><span class="w">          </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered-container&quot;</span>
<a id="__codelineno-70-31" name="__codelineno-70-31" href="#__codelineno-70-31"></a><span class="w">          </span><span class="nb">volume_mount</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-32" name="__codelineno-70-32" href="#__codelineno-70-32"></a><span class="w">            </span><span class="na">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered-vol&quot;</span>
<a id="__codelineno-70-33" name="__codelineno-70-33" href="#__codelineno-70-33"></a><span class="w">            </span><span class="na">mount_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/data&quot;</span>
<a id="__codelineno-70-34" name="__codelineno-70-34" href="#__codelineno-70-34"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-70-35" name="__codelineno-70-35" href="#__codelineno-70-35"></a><span class="w">          </span><span class="nb">port</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-36" name="__codelineno-70-36" href="#__codelineno-70-36"></a><span class="w">            </span><span class="na">container_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-70-37" name="__codelineno-70-37" href="#__codelineno-70-37"></a><span class="w">            </span><span class="na">host_port</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">8000</span>
<a id="__codelineno-70-38" name="__codelineno-70-38" href="#__codelineno-70-38"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-70-39" name="__codelineno-70-39" href="#__codelineno-70-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-70-40" name="__codelineno-70-40" href="#__codelineno-70-40"></a><span class="w">        </span><span class="nb">volume</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-41" name="__codelineno-70-41" href="#__codelineno-70-41"></a><span class="w">          </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered-vol&quot;</span>
<a id="__codelineno-70-42" name="__codelineno-70-42" href="#__codelineno-70-42"></a><span class="w">          </span><span class="nb">empty_dir</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-70-43" name="__codelineno-70-43" href="#__codelineno-70-43"></a><span class="w">            </span><span class="na">medium</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<a id="__codelineno-70-44" name="__codelineno-70-44" href="#__codelineno-70-44"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-70-45" name="__codelineno-70-45" href="#__codelineno-70-45"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-70-46" name="__codelineno-70-46" href="#__codelineno-70-46"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-70-47" name="__codelineno-70-47" href="#__codelineno-70-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-70-48" name="__codelineno-70-48" href="#__codelineno-70-48"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-70-49" name="__codelineno-70-49" href="#__codelineno-70-49"></a><span class="p">}</span>
</code></pre></div>
<h3 id="116-terraform-apply-yourself-3-k8s-deployments-using-for_each">116. Terraform Apply Yourself - 3 k8s deployments using for_each<a class="headerlink" href="#116-terraform-apply-yourself-3-k8s-deployments-using-for_each" title="Permanent link">&para;</a></h3>
<ul>
<li>Deploy nodered, influxdb, and grafana using the one deployment resource</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="c1"># --- root/locals.tf ---</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="w">  </span><span class="nb">deployment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="w">    </span><span class="nb">nodered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="w">      </span><span class="na">image</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nodered/node-red:latest&quot;</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="w">      </span><span class="na">int</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="w">      </span><span class="na">ext</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">1880</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="w">      </span><span class="na">volumepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/data&quot;</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="w">    </span><span class="nb">influxdb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="w">      </span><span class="na">image</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;influxdb&quot;</span>
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a><span class="w">      </span><span class="na">int</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">8086</span>
<a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a><span class="w">      </span><span class="na">ext</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">8086</span>
<a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a><span class="w">      </span><span class="na">volumepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;var/lib/influxdb&quot;</span>
<a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a><span class="w">    </span><span class="nb">grafana</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a><span class="w">      </span><span class="na">image</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;grafana/grafana&quot;</span>
<a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a><span class="w">      </span><span class="na">int</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span>
<a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a><span class="w">      </span><span class="na">ext</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span>
<a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a><span class="w">      </span><span class="na">volumepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;var/lib/grafana&quot;</span>
<a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a><span class="p">}</span>
<a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a>
<a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a><span class="c1"># --- root/mains.tf ---</span>
<a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a>
<a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;kubernetes_deployment&quot;</span><span class="w"> </span><span class="nv">&quot;iotdep&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a><span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.deployment</span>
<a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a><span class="w">  </span><span class="nb">metadata</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a><span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${each.key}-dep&quot;</span>
<a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a><span class="w">    </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a><span class="w">      </span><span class="na">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;iotapp&quot;</span>
<a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a>
<a id="__codelineno-71-37" name="__codelineno-71-37" href="#__codelineno-71-37"></a><span class="w">  </span><span class="nb">spec</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-38" name="__codelineno-71-38" href="#__codelineno-71-38"></a><span class="w">    </span><span class="na">replicas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-71-39" name="__codelineno-71-39" href="#__codelineno-71-39"></a>
<a id="__codelineno-71-40" name="__codelineno-71-40" href="#__codelineno-71-40"></a><span class="w">    </span><span class="nb">selector</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-41" name="__codelineno-71-41" href="#__codelineno-71-41"></a><span class="w">      </span><span class="nb">match_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-42" name="__codelineno-71-42" href="#__codelineno-71-42"></a><span class="w">        </span><span class="na">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;iotapp&quot;</span>
<a id="__codelineno-71-43" name="__codelineno-71-43" href="#__codelineno-71-43"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-71-44" name="__codelineno-71-44" href="#__codelineno-71-44"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-71-45" name="__codelineno-71-45" href="#__codelineno-71-45"></a>
<a id="__codelineno-71-46" name="__codelineno-71-46" href="#__codelineno-71-46"></a><span class="w">    </span><span class="nb">template</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-47" name="__codelineno-71-47" href="#__codelineno-71-47"></a><span class="w">      </span><span class="nb">metadata</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-48" name="__codelineno-71-48" href="#__codelineno-71-48"></a><span class="w">        </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-49" name="__codelineno-71-49" href="#__codelineno-71-49"></a><span class="w">          </span><span class="na">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;iotapp&quot;</span>
<a id="__codelineno-71-50" name="__codelineno-71-50" href="#__codelineno-71-50"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-71-51" name="__codelineno-71-51" href="#__codelineno-71-51"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-71-52" name="__codelineno-71-52" href="#__codelineno-71-52"></a>
<a id="__codelineno-71-53" name="__codelineno-71-53" href="#__codelineno-71-53"></a><span class="w">      </span><span class="nb">spec</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-54" name="__codelineno-71-54" href="#__codelineno-71-54"></a><span class="w">        </span><span class="nb">container</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-55" name="__codelineno-71-55" href="#__codelineno-71-55"></a><span class="w">          </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.image</span>
<a id="__codelineno-71-56" name="__codelineno-71-56" href="#__codelineno-71-56"></a><span class="w">          </span><span class="na">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${each.key}-container&quot;</span>
<a id="__codelineno-71-57" name="__codelineno-71-57" href="#__codelineno-71-57"></a><span class="w">          </span><span class="nb">volume_mount</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-58" name="__codelineno-71-58" href="#__codelineno-71-58"></a><span class="w">            </span><span class="na">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${each.key}-vol&quot;</span>
<a id="__codelineno-71-59" name="__codelineno-71-59" href="#__codelineno-71-59"></a><span class="w">            </span><span class="na">mount_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.volumepath</span>
<a id="__codelineno-71-60" name="__codelineno-71-60" href="#__codelineno-71-60"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-71-61" name="__codelineno-71-61" href="#__codelineno-71-61"></a><span class="w">          </span><span class="nb">port</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-62" name="__codelineno-71-62" href="#__codelineno-71-62"></a><span class="w">            </span><span class="na">container_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.int</span>
<a id="__codelineno-71-63" name="__codelineno-71-63" href="#__codelineno-71-63"></a><span class="w">            </span><span class="na">host_port</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.ext</span>
<a id="__codelineno-71-64" name="__codelineno-71-64" href="#__codelineno-71-64"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-71-65" name="__codelineno-71-65" href="#__codelineno-71-65"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-71-66" name="__codelineno-71-66" href="#__codelineno-71-66"></a><span class="w">        </span><span class="nb">volume</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-67" name="__codelineno-71-67" href="#__codelineno-71-67"></a><span class="w">          </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${each.key}-vol&quot;</span>
<a id="__codelineno-71-68" name="__codelineno-71-68" href="#__codelineno-71-68"></a><span class="w">          </span><span class="nb">empty_dir</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-71-69" name="__codelineno-71-69" href="#__codelineno-71-69"></a><span class="w">            </span><span class="na">medium</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<a id="__codelineno-71-70" name="__codelineno-71-70" href="#__codelineno-71-70"></a><span class="w">          </span><span class="p">}</span>
<a id="__codelineno-71-71" name="__codelineno-71-71" href="#__codelineno-71-71"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-71-72" name="__codelineno-71-72" href="#__codelineno-71-72"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-71-73" name="__codelineno-71-73" href="#__codelineno-71-73"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-71-74" name="__codelineno-71-74" href="#__codelineno-71-74"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-71-75" name="__codelineno-71-75" href="#__codelineno-71-75"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>deployments
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>NAME<span class="w">           </span>READY<span class="w">   </span>UP-TO-DATE<span class="w">   </span>AVAILABLE<span class="w">   </span>AGE
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>nodered-dep<span class="w">    </span><span class="m">0</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">0</span><span class="w">           </span>3m16s
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>grafana-dep<span class="w">    </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>3m16s
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>influxdb-dep<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>3m16s
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>NAME<span class="w">                            </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>grafana-dep-66f59cdd49-xlz7n<span class="w">    </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m8s
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>influxdb-dep-69bb978bfd-hjrxk<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m8s
<a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>nodered-dep-5867bf8c7c-5str7<span class="w">    </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m8s
</code></pre></div>
<p><img alt="nodered and influxdb running" src="../../assets/images/terraform/image-3.png" /></p>
<h3 id="117-terraform_remote_state-datasource-and-the-split-function">117. Terraform_remote_state datasource and the split Function<a class="headerlink" href="#117-terraform_remote_state-datasource-and-the-split-function" title="Permanent link">&para;</a></h3>
<p><a href="https://developer.hashicorp.com/terraform/language/state/remote-state-data">https://developer.hashicorp.com/terraform/language/state/remote-state-data</a></p>
<ul>
<li>Pull values from a remote state file. Recommendation is to not use this if possible. You need full access to the workspace state. Better to use tfe_outputs data source.</li>
<li>Use the output from the terraform-aws state file which shows the env var with the location of the K8s config file. Then use split to just get the file location.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="err">$</span><span class="w"> </span><span class="err">terraform</span><span class="w"> </span><span class="err">console</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="err">&gt;</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="s2">&quot;=&quot;, &quot;export KUBECONFIG=/workspaces/terraform-associate/terraform-aws/terraform-aws/../../k3s-mtc_node-59231.yaml&quot;</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="s2">&quot;/workspaces/terraform-associate/terraform-aws/terraform-aws/../../k3s-mtc_node-59231.yaml&quot;</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="err">&gt;</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="s2">&quot;=&quot;, &quot;export KUBECONFIG=/workspaces/terraform-associate/terraform-aws/terraform-aws/../../k3s-mtc_node-59231.yaml&quot;</span><span class="p">)</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="nf">tolist</span><span class="p">([</span>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="w">  </span><span class="s2">&quot;export KUBECONFIG&quot;</span><span class="p">,</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="w">  </span><span class="s2">&quot;/workspaces/terraform-associate/terraform-aws/terraform-aws/../../k3s-mtc_node-59231.yaml&quot;</span><span class="p">,</span>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="p">])</span>
</code></pre></div>
<ul>
<li>Accessing tfstate from terraform-aws in TFC. <code>data.terraform_remote_state.kubeconfig.outputs.kubeconfig</code> has the location of the K8s config file.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># --- root/datasources.tf ---</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;terraform_remote_state&quot;</span><span class="w"> </span><span class="nv">&quot;kubeconfig&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="w">  </span><span class="na">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;remote&quot;</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="w">  </span><span class="nb">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="w">    </span><span class="na">organization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-terraform-th&quot;</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="w">    </span><span class="nb">workspaces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="w">      </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-dev&quot;</span>
<a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="p">}</span>
<a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a>
<a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a><span class="c1"># --- root/providers.tf ---</span>
<a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a>
<a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a><span class="w">  </span><span class="na">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.terraform_remote_state.kubeconfig.outputs.kubeconfig</span>
<a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="p">}</span>
<a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a><span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a><span class="w">    </span><span class="nb">kubernetes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a><span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/kubernetes&quot;</span>
<a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 2.26.0&quot;</span>
<a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a><span class="p">}</span>
<a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a>
<a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;kubernetes&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a><span class="w">  </span><span class="na">config_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span><span class="nv">local.config[0</span><span class="p">])[</span><span class="m">1</span><span class="p">]</span>
<a id="__codelineno-74-30" name="__codelineno-74-30" href="#__codelineno-74-30"></a><span class="p">}</span>
</code></pre></div>
<h2 id="section-6-continuous-deployment-using-terraform-cloud">Section 6: Continuous Deployment using Terraform Cloud<a class="headerlink" href="#section-6-continuous-deployment-using-terraform-cloud" title="Permanent link">&para;</a></h2>
<h3 id="118-what-were-going-to-build">118. What We're Going to Build<a class="headerlink" href="#118-what-were-going-to-build" title="Permanent link">&para;</a></h3>
<p><img alt="Deployment overview" src="../../assets/images/terraform/image-4.png" /></p>
<ul>
<li>CI/CD pipeline</li>
<li>GitHub Networking &amp; Compute Repos hosting modules</li>
<li>GitHub hosting Deployment repo (main.tf)</li>
<li>Oauth GitHub with Terraform Cloud so that when a change is made in the module repos it will be reflected in the modules in TFC. Also, so that a change in the deployment repo will deploy in TFC using a deployment workspace.</li>
<li>Deployment envars in TFC will contain AWS credentials</li>
</ul>
<h3 id="120-setting-up-github">120. Setting up GitHub<a class="headerlink" href="#120-setting-up-github" title="Permanent link">&para;</a></h3>
<ul>
<li>Pull repo <a href="https://github.com/derekops/terraform-aws-networking">https://github.com/derekops/terraform-aws-networking</a></li>
<li>GitHub &gt; Settings &gt; Developer settings &gt; PAT</li>
<li>When creating a module repo, the repo name must start with terraform-aws or TFC will not pick it up as a module</li>
<li>Output below: clone repo, remove git, initialise a new repo, create new repo in GitHub GUI, then add the GitHub repo as origin source</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/derekops/terraform-aws-networking.git
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>rm<span class="w"> </span>-rf<span class="w"> </span>.git<span class="w"> </span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>git<span class="w"> </span>init<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Git initial&quot;</span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>git<span class="w"> </span>branch<span class="w"> </span>-M<span class="w"> </span>main
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>git<span class="w"> </span>remote<span class="w"> </span>add<span class="w"> </span>origin<span class="w"> </span>https://github.com/liftconfig/terraform-aws-networking.git
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>git<span class="w"> </span>status
</code></pre></div>
<h3 id="121-configuring-terraform-cloud">121. Configuring Terraform Cloud<a class="headerlink" href="#121-configuring-terraform-cloud" title="Permanent link">&para;</a></h3>
<p>Authorise TFC to access GitHub account. Create an Application in GitHub</p>
<ol>
<li>In terraform Cloud Org settings configure a VSC provider</li>
<li>Link to GitHub to register a new OAuth Application <a href="https://github.com/settings/applications/new">https://github.com/settings/applications/new</a> TFC provides all the steps to do this.</li>
<li>Create a new workspace and chose Version Control Workflow. You will be able to select GitHub as a VCS provider.</li>
<li>Choose a repository from GitHub</li>
</ol>
<h3 id="122-our-first-cloud-deployment">122. Our First Cloud Deployment<a class="headerlink" href="#122-our-first-cloud-deployment" title="Permanent link">&para;</a></h3>
<ul>
<li>TFC will pick up any variable file <code>*.auto.tfvars</code> and automatically use the variables in the configuration.</li>
<li>When creating variables if you are using anything other than a string (list, map etc.) make sure to tick the HCL box or it will be inside quotes like a string.</li>
</ul>
<h3 id="123-tfc-repo-based-modules">123. TFC Repo-based modules<a class="headerlink" href="#123-tfc-repo-based-modules" title="Permanent link">&para;</a></h3>
<ul>
<li>Publish private modules in TFC under registry &gt; modules</li>
<li>Select VSC Provider and then a repo for the module (same as a VSC workflow workspace)</li>
<li>"Module source repository has no tags" - A module requires Git tagging before it can be utilised.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>$<span class="w"> </span>git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span>v1.0.0<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;first version&quot;</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>$<span class="w"> </span>git<span class="w"> </span>tag
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>v1.0.0
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>v1.0.0
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>To<span class="w"> </span>https://github.com/liftconfig/terraform-aws-networking.git
<a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a><span class="w"> </span>*<span class="w"> </span><span class="o">[</span>new<span class="w"> </span>tag<span class="o">]</span><span class="w">         </span>v1.0.0<span class="w"> </span>-&gt;<span class="w"> </span>v1.0.0
</code></pre></div>
<p><img alt="TFC Module inputs" src="../../assets/images/terraform/image-5.png" />
<img alt="TFC Module resources" src="../../assets/images/terraform/image-7.png" /></p>
<ul>
<li>Modules won't pick up the <code>*.auto.tfvars</code> file, so this needs to be specified outside the repository.</li>
</ul>
<h3 id="124-utilising-the-configuration-designer-to-create-a-deployment">124. Utilising the Configuration Designer to Create a Deployment<a class="headerlink" href="#124-utilising-the-configuration-designer-to-create-a-deployment" title="Permanent link">&para;</a></h3>
<ul>
<li>Registry (where you can see your modules) &gt; Design configuration &gt; Select modules</li>
<li>Add variables for each of the modules. You can use the outputs of other modules as inputs</li>
</ul>
<p><img alt="TFC Deployment" src="../../assets/images/terraform/image-8.png" /></p>
<ul>
<li>You can then copy the code output and publish to a new VSC repo</li>
</ul>
<p><img alt="TFC Publish config to VSC" src="../../assets/images/terraform/image-9.png" /></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1"># --- mtc-control/deployments/mtc-dev/main.tf ---</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="c1">//--------------------------------------------------------------------</span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="c1">// Variables</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="c1">//--------------------------------------------------------------------</span>
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="c1">// Modules</span>
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;compute&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="w">  </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;app.terraform.io/mtc-terraform-th/compute/aws&quot;</span>
<a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a><span class="w">  </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.0.1&quot;</span>
<a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>
<a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a><span class="w">  </span><span class="na">aws_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ap-southeast-2&quot;</span>
<a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a><span class="w">  </span><span class="na">public_key_material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh-rsa &quot;</span>
<a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a><span class="w">  </span><span class="na">public_sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${module.networking.public_sg}&quot;</span>
<a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a><span class="w">  </span><span class="na">public_subnets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${module.networking.public_subnets}&quot;</span>
<a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a><span class="p">}</span>
<a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a>
<a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;networking&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-77-19" name="__codelineno-77-19" href="#__codelineno-77-19"></a><span class="w">  </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;app.terraform.io/mtc-terraform-th/networking/aws&quot;</span>
<a id="__codelineno-77-20" name="__codelineno-77-20" href="#__codelineno-77-20"></a><span class="w">  </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span>
<a id="__codelineno-77-21" name="__codelineno-77-21" href="#__codelineno-77-21"></a>
<a id="__codelineno-77-22" name="__codelineno-77-22" href="#__codelineno-77-22"></a><span class="w">  </span><span class="na">access_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x.x.x.x&quot;</span>
<a id="__codelineno-77-23" name="__codelineno-77-23" href="#__codelineno-77-23"></a><span class="w">  </span><span class="na">aws_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ap-southeast-2&quot;</span>
<a id="__codelineno-77-24" name="__codelineno-77-24" href="#__codelineno-77-24"></a><span class="p">}</span>
</code></pre></div>
<h3 id="125-settings-up-providers-for-our-new-deployment">125. Settings up Providers for our New Deployment<a class="headerlink" href="#125-settings-up-providers-for-our-new-deployment" title="Permanent link">&para;</a></h3>
<ul>
<li>Here we're using terraform code (outside of Git/TFC) to deploy code to Git/TFC</li>
<li>Deploy the above main.tf code to GitHub, then run using TFC</li>
<li>Create a new GitHub repository and attach repository to TFC workspace all using Terraform code</li>
<li>Modules are scoped to the organisation in TFC so the above module source will all work</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c1"># --- root/providers.tf ---</span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="w">    </span><span class="nb">github</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="w">      </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;integrations/github&quot;</span>
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;4.13.0&quot;</span>
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>
<a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="w">    </span><span class="nb">tfe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a><span class="w">      </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/tfe&quot;</span>
<a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a><span class="p">}</span>
<a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a>
<a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;github&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a><span class="w">  </span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.github_token</span>
<a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a><span class="w">  </span><span class="na">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.github_owner</span>
<a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a><span class="p">}</span>
<a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a>
<a id="__codelineno-78-21" name="__codelineno-78-21" href="#__codelineno-78-21"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;tfe&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-22" name="__codelineno-78-22" href="#__codelineno-78-22"></a><span class="w">  </span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.tfe_token</span>
<a id="__codelineno-78-23" name="__codelineno-78-23" href="#__codelineno-78-23"></a><span class="p">}</span>
</code></pre></div>
<h3 id="127-configuring-our-github-resources-in-terraform">127. Configuring our GitHub Resources in Terraform<a class="headerlink" href="#127-configuring-our-github-resources-in-terraform" title="Permanent link">&para;</a></h3>
<ul>
<li>In local TF - Create repository, default branch, and upload main.tf</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;github_repository&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_repo&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-dev-repo&quot;</span>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;VPC and Compute Resources&quot;</span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="w">  </span><span class="na">auto_init</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="w">  </span><span class="na">license_template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mit&quot;</span>
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="w">  </span><span class="na">visibility</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;private&quot;</span>
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="p">}</span>
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a>
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;github_branch_default&quot;</span><span class="w"> </span><span class="nv">&quot;default&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a><span class="w">  </span><span class="na">repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">github_repository.mtc_repo.name</span>
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="w">  </span><span class="na">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;main&quot;</span>
<a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a><span class="p">}</span>
<a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>
<a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;github_repository_file&quot;</span><span class="w"> </span><span class="nv">&quot;maintf&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a><span class="w">  </span><span class="na">repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">github_repository.mtc_repo.name</span>
<a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a><span class="w">  </span><span class="na">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;main&quot;</span>
<a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a><span class="w">  </span><span class="na">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;main.tf&quot;</span>
<a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a><span class="w">  </span><span class="na">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">file</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;./deployments/mtc-dev/main.tf&quot;</span><span class="p">)</span>
<a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a><span class="c1">  #not uploading file, you are creating a new file and extracting content from main.tf</span>
<a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a><span class="w">  </span><span class="na">commit_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Managed by Terraform&quot;</span>
<a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a><span class="w">  </span><span class="na">commit_author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tim&quot;</span>
<a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a><span class="w">  </span><span class="na">commit_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;tim@tim.com&quot;</span>
<a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a><span class="w">  </span><span class="na">overwrite_on_create</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a><span class="p">}</span>
</code></pre></div>
<h3 id="128-configuring-our-terraform-cloud-resources-in-terraform">128. Configuring our Terraform Cloud Resources in Terraform<a class="headerlink" href="#128-configuring-our-terraform-cloud-resources-in-terraform" title="Permanent link">&para;</a></h3>
<ul>
<li>In local TF create TFC resources: mtc_oauth client to github, workspace using repo from GitHub, workspace environment variables for AWS</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="c1"># --- root/main.tf ---</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;tfe_oauth_client&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_oauth&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="w">  </span><span class="na">organization</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">local.organization</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="w">  </span><span class="na">api_url</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://api.github.com&quot;</span>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="w">  </span><span class="na">http_url</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://github.com&quot;</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a><span class="w">  </span><span class="na">oauth_token</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">var.github_token</span>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a><span class="w">  </span><span class="na">service_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;github&quot;</span>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a><span class="p">}</span>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>
<a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;tfe_workspace&quot;</span><span class="w"> </span><span class="nv">&quot;mtc_workspace&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a><span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">github_repository.mtc_repo.name</span>
<a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a><span class="w">  </span><span class="na">organization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.organization</span>
<a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a><span class="w">  </span><span class="nb">vcs_repo</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a><span class="w">    </span><span class="na">identifier</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.github_owner}/${github_repository.mtc_repo.name}&quot;</span>
<a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a><span class="w">    </span><span class="na">oauth_token_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tfe_oauth_client.mtc_oauth.oauth_token_id</span>
<a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a><span class="p">}</span>
<a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a>
<a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;tfe_variable&quot;</span><span class="w"> </span><span class="nv">&quot;aws_creds&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a><span class="w">  </span><span class="na">for_each</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">local.aws_creds</span>
<a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a><span class="w">  </span><span class="na">key</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span>
<a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a><span class="w">  </span><span class="na">value</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value</span>
<a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a><span class="w">  </span><span class="na">category</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;env&quot;</span>
<a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a><span class="w">  </span><span class="na">sensitive</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a><span class="w">  </span><span class="na">workspace_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tfe_workspace.mtc_workspace.id</span>
<a id="__codelineno-80-26" name="__codelineno-80-26" href="#__codelineno-80-26"></a><span class="w">  </span><span class="na">description</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;AWS creds&quot;</span>
<a id="__codelineno-80-27" name="__codelineno-80-27" href="#__codelineno-80-27"></a><span class="p">}</span>
</code></pre></div>
<ul>
<li>After the workspace is created a plan will automatically run using the main.tf in the mtc_repo</li>
</ul>
<blockquote>
<p>DO NOT run destroy from local TF (destroying TFC workspace, GitHub repo etc) without running a destroy from TFC workspace. Otherwise, you are left with all the AWS resources created from the workspace</p>
</blockquote>
<h3 id="130-pushing-and-pulling-remote-state">130. Pushing and pulling remote state<a class="headerlink" href="#130-pushing-and-pulling-remote-state" title="Permanent link">&para;</a></h3>
<ul>
<li>Locally pull the state down from the mtc-dev-repo, modify and push back up. Should be an extremely rare scenario that would call for this.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># --- mtc-control/deployments/mtc-dev/main.tf ---</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="w">  </span><span class="kr">backend</span><span class="w"> </span><span class="nv">&quot;remote&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="w">    </span><span class="na">organization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-terraform-th&quot;</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="w">    </span><span class="nb">workspaces</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="w">      </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mtc-dev-repo&quot;</span>
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>terraform<span class="w"> </span>init
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>terraform<span class="w"> </span>state<span class="w"> </span>pull<span class="w"> </span>&gt;&gt;<span class="w"> </span>terraform.tfstate
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>terraform<span class="w"> </span>state<span class="w"> </span>push<span class="w"> </span>terraform.tfstate
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a>Failed<span class="w"> </span>to<span class="w"> </span>write<span class="w"> </span>state:<span class="w"> </span>cannot<span class="w"> </span>overwrite<span class="w"> </span>existing<span class="w"> </span>state<span class="w"> </span>with<span class="w"> </span>serial<span class="w"> </span><span class="m">1</span><span class="w"> </span>with<span class="w"> </span>a<span class="w"> </span>different<span class="w"> </span>state<span class="w"> </span>that<span class="w"> </span>has<span class="w"> </span>the<span class="w"> </span>same<span class="w"> </span>serial
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="c1"># need to increment the serial # in the state, then you can push back up to TFC.</span>
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>terraform<span class="w"> </span>state<span class="w"> </span>push<span class="w"> </span>terraform.tfstate
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>Acquiring<span class="w"> </span>state<span class="w"> </span>lock.<span class="w"> </span>This<span class="w"> </span>may<span class="w"> </span>take<span class="w"> </span>a<span class="w"> </span>few<span class="w"> </span>moments...
<a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>Releasing<span class="w"> </span>state<span class="w"> </span>lock.<span class="w"> </span>This<span class="w"> </span>may<span class="w"> </span>take<span class="w"> </span>a<span class="w"> </span>few<span class="w"> </span>moments...
</code></pre></div>
<h3 id="131-updating-our-deployment-modules-and-destroying-it">131. Updating our Deployment Modules and Destroying it<a class="headerlink" href="#131-updating-our-deployment-modules-and-destroying-it" title="Permanent link">&para;</a></h3>
<ul>
<li>Updated variable in terraform-aws-compute module repo and then publish as new module version</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>git<span class="w"> </span>add<span class="w"> </span>.
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;updated key name&quot;</span>
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="o">[</span>main<span class="w"> </span>20b9a08<span class="o">]</span><span class="w"> </span>updated<span class="w"> </span>key<span class="w"> </span>name
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>file<span class="w"> </span>changed,<span class="w"> </span><span class="m">1</span><span class="w"> </span>insertion<span class="o">(</span>+<span class="o">)</span>,<span class="w"> </span><span class="m">1</span><span class="w"> </span>deletion<span class="o">(</span>-<span class="o">)</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span>v1.0.2<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;updated keyname&quot;</span>
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>v1.0.2
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>Enumerating<span class="w"> </span>objects:<span class="w"> </span><span class="m">6</span>,<span class="w"> </span><span class="k">done</span>.
<a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>Counting<span class="w"> </span>objects:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">6</span>/6<span class="o">)</span>,<span class="w"> </span><span class="k">done</span>.
<a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>Delta<span class="w"> </span>compression<span class="w"> </span>using<span class="w"> </span>up<span class="w"> </span>to<span class="w"> </span><span class="m">12</span><span class="w"> </span>threads
<a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a>Compressing<span class="w"> </span>objects:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">4</span>/4<span class="o">)</span>,<span class="w"> </span><span class="k">done</span>.
<a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>Writing<span class="w"> </span>objects:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">4</span>/4<span class="o">)</span>,<span class="w"> </span><span class="m">438</span><span class="w"> </span>bytes<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">438</span>.00<span class="w"> </span>KiB/s,<span class="w"> </span><span class="k">done</span>.
<a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a>Total<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">(</span>delta<span class="w"> </span><span class="m">2</span><span class="o">)</span>,<span class="w"> </span>reused<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">(</span>delta<span class="w"> </span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>pack-reused<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a>remote:<span class="w"> </span>Resolving<span class="w"> </span>deltas:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">2</span>/2<span class="o">)</span>,<span class="w"> </span>completed<span class="w"> </span>with<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="nb">local</span><span class="w"> </span>objects.
<a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a>To<span class="w"> </span>https://github.com/liftconfig/terraform-aws-compute.git
<a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a><span class="w"> </span>*<span class="w"> </span><span class="o">[</span>new<span class="w"> </span>tag<span class="o">]</span><span class="w">         </span>v1.0.2<span class="w"> </span>-&gt;<span class="w"> </span>v1.0.2
</code></pre></div>
<ul>
<li>Update module version in main.tf to use new version</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c1"># --- mtc-control/deployments/mtc-dev/main.tf ---</span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="c1">//--------------------------------------------------------------------</span>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="c1">// Variables</span>
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="c1">//--------------------------------------------------------------------</span>
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="c1">// Modules</span>
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;compute&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a><span class="w">  </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;app.terraform.io/mtc-terraform-th/compute/aws&quot;</span>
<a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a><span class="w">  </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span>
<a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a>
<a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a><span class="w">  </span><span class="na">aws_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ap-southeast-2&quot;</span>
<a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a><span class="w">  </span><span class="na">public_key_material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ssh-rsa &quot;</span>
<a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a><span class="w">  </span><span class="na">public_sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${module.networking.public_sg}&quot;</span>
<a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a><span class="w">  </span><span class="na">public_subnets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${module.networking.public_subnets}&quot;</span>
<a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a><span class="p">}</span>
<a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a>
<a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;networking&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a><span class="w">  </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;app.terraform.io/mtc-terraform-th/networking/aws&quot;</span>
<a id="__codelineno-84-20" name="__codelineno-84-20" href="#__codelineno-84-20"></a><span class="w">  </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span>
<a id="__codelineno-84-21" name="__codelineno-84-21" href="#__codelineno-84-21"></a>
<a id="__codelineno-84-22" name="__codelineno-84-22" href="#__codelineno-84-22"></a><span class="w">  </span><span class="na">access_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x.x.x.x&quot;</span>
<a id="__codelineno-84-23" name="__codelineno-84-23" href="#__codelineno-84-23"></a><span class="w">  </span><span class="na">aws_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ap-southeast-2&quot;</span>
<a id="__codelineno-84-24" name="__codelineno-84-24" href="#__codelineno-84-24"></a><span class="p">}</span>
</code></pre></div>
<h3 id="cleaning-up">Cleaning up<a class="headerlink" href="#cleaning-up" title="Permanent link">&para;</a></h3>
<ul>
<li>Run destroy in TFC mtc-dev-repo workspace</li>
<li>Destroy mtc-dev-repo GitHub repo and TFC workspace</li>
<li>Destroy resources from aws-networking TFC workspace (created prior to turning into module)</li>
<li>Delete TFC token, GitHub PAT, AWS Access Key</li>
</ul>
<h3 id="time-to-complete-course">Time to complete course<a class="headerlink" href="#time-to-complete-course" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Date</th>
<th>Day</th>
<th>Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>15/01/24</td>
<td>MON</td>
<td>3H</td>
</tr>
<tr>
<td>16/01/24</td>
<td>TUE</td>
<td>1H</td>
</tr>
<tr>
<td>17/01/24</td>
<td>WED</td>
<td>2H</td>
</tr>
<tr>
<td>18/01/24</td>
<td>THU</td>
<td>1.5H</td>
</tr>
<tr>
<td>19/01/24</td>
<td>FRI</td>
<td>2H</td>
</tr>
<tr>
<td>20/01/24</td>
<td>SAT</td>
<td>1.5H</td>
</tr>
<tr>
<td>21/01/24</td>
<td>SUN</td>
<td>1H</td>
</tr>
<tr>
<td>22/01/24</td>
<td>MON</td>
<td>2H</td>
</tr>
<tr>
<td>23/01/24</td>
<td>TUE</td>
<td>1H</td>
</tr>
<tr>
<td>24/01/24</td>
<td>WED</td>
<td>1H</td>
</tr>
<tr>
<td>25/01/24</td>
<td>THU</td>
<td>2H</td>
</tr>
<tr>
<td>26/01/24</td>
<td>FRI</td>
<td>1H</td>
</tr>
<tr>
<td>28/01/24</td>
<td>SUN</td>
<td>2H</td>
</tr>
<tr>
<td>29/01/24</td>
<td>MON</td>
<td>3H</td>
</tr>
<tr>
<td>30/01/24</td>
<td>TUE</td>
<td>1.5H</td>
</tr>
<tr>
<td>31/01/24</td>
<td>WED</td>
<td>1H</td>
</tr>
<tr>
<td>03/02/24</td>
<td>SAT</td>
<td>1H</td>
</tr>
<tr>
<td>04/02/24</td>
<td>SUN</td>
<td>2.5H</td>
</tr>
<tr>
<td>05/02/24</td>
<td>MON</td>
<td>1H</td>
</tr>
<tr>
<td>06/02/24</td>
<td>TUE</td>
<td>1H</td>
</tr>
<tr>
<td>11/02/24</td>
<td>SUN</td>
<td>2H</td>
</tr>
<tr>
<td>12/02/24</td>
<td>MON</td>
<td>2H</td>
</tr>
<tr>
<td>13/02/24</td>
<td>TUE</td>
<td>2H</td>
</tr>
<tr>
<td>14/02/24</td>
<td>THU</td>
<td>1.5H</td>
</tr>
<tr>
<td>18/02/24</td>
<td>FRI</td>
<td>0.5H</td>
</tr>
<tr>
<td>19/02/24</td>
<td>MON</td>
<td>1H</td>
</tr>
<tr>
<td>20/02/24</td>
<td>TUE</td>
<td>0.5H</td>
</tr>
<tr>
<td>26/02/24</td>
<td>MON</td>
<td>1.5H</td>
</tr>
<tr>
<td>27/02/24</td>
<td>TUE</td>
<td>1.5H</td>
</tr>
<tr>
<td>28/02/24</td>
<td>WED</td>
<td>2H</td>
</tr>
</tbody>
</table>
<ul>
<li>Total = 46.5.</li>
<li>Course video length = 12.5 = 4x to complete</li>
<li>Average ~1 hour a day / 7.75 hours a week</li>
</ul>







  
  



  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2024 liftConfig

    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/timhowlinson" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/liftconfig" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:tim.howlinson@gmail.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.openpowerlifting.org/u/timhowlinson" target="_blank" rel="noopener" title="www.openpowerlifting.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M96 64c0-17.7 14.3-32 32-32h32c17.7 0 32 14.3 32 32v384c0 17.7-14.3 32-32 32h-32c-17.7 0-32-14.3-32-32v-64H64c-17.7 0-32-14.3-32-32v-64c-17.7 0-32-14.3-32-32s14.3-32 32-32v-64c0-17.7 14.3-32 32-32h32V64zm448 0v64h32c17.7 0 32 14.3 32 32v64c17.7 0 32 14.3 32 32s-14.3 32-32 32v64c0 17.7-14.3 32-32 32h-32v64c0 17.7-14.3 32-32 32h-32c-17.7 0-32-14.3-32-32V64c0-17.7 14.3-32 32-32h32c17.7 0 32 14.3 32 32zM416 224v64H224v-64h192z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotation", "content.code.copy", "content.code.select", "search.suggest", "search.highlight", "navigation.expand", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.top", "toc.follow"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.bd41221c.min.js"></script>
      
    
  </body>
</html>